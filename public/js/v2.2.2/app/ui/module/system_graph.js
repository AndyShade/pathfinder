define(["jquery","app/util","module/base","morris"],(e,t,s,a)=>{"use strict";let o=class SystemGraphModule extends s{constructor(e={}){super(Object.assign({},new.target.defaultConfig,e))}newHeaderElement(){return""}newHeadlineToolbarElement(){let e=super.newHeadlineToolbarElement(),s=document.createElement("small");return s.innerHTML='<i class="fas fa-fw fa-question-circle pf-help '+t.config.popoverTriggerClass+'"></i>',e.append(s),e}render(e,t){if(this._systemData=t,2===t.type.id){let e=document.createElement("div");e.classList.add(this._config.bodyClassName,"grid");for(let t of Object.keys(this._config.systemGraphs)){let s=document.createElement("div");s.dataset.graph=t;let a=this.newHeadElement();a.append(this.newHandlerElement(),this.newHeadlineElement(this.getInfoForGraph(t,"headline")),this.newHeadlineToolbarElement());let o=document.createElement("div");o.classList.add(this._config.systemGraphClass),s.append(a,o),e.append(s)}return this.moduleElement.append(e),this.setModuleObserver(),this._dataPromise=this.getGraphsData(),this.moduleElement}}init(){super.init(),this._dataPromise instanceof Promise&&this._dataPromise.then(e=>this.addGraphData(e.data)).catch(e=>{let t=e.data.status+" "+e.data.error;this.showNotify({title:e.data.jqXHR.status+": System graph data",text:t,type:"warning"})})}getGraphsData(){return e(this.moduleElement).find("."+this._config.systemGraphClass).showLoadingAnimation(),this.request("GET","SystemGraph",this._systemData.id,{systemIds:[this._systemData.systemId]})}addGraphData(s){let a=t.getServerTime(),o=Math.floor(a.getTime()/1e3)-this._systemData.updated.updated,i=Math.floor(o/3600),r=Math.floor(o%3600/60),l=parseFloat((r/60).toFixed(2)),n=Math.max(parseFloat((24-i-l).toFixed(2)),0);for(let[t,a]of Object.entries(s))for(let[t,s]of Object.entries(a)){let a=e(this.moduleElement).find('[data-graph="'+t+'"]'),o=a.find("."+this._config.systemGraphClass);o.hideLoadingAnimation(),a.data("infoData",this.initGraph(o,t,s,n))}}setModuleObserver(){e(this.moduleElement).hoverIntent({over:function(t){let s=e(this),a=s.parents("[data-graph]").data("infoData");a&&SystemGraphModule.addSystemGraphTooltip(s,a.rows,{trigger:"manual",title:a.title}).popover("show")},out:function(t){e(this).destroyPopover()},selector:"."+t.config.popoverTriggerClass})}getInfoForGraph(e,s){return t.getObjVal(this._config.systemGraphs,e+"."+s)||""}initGraph(e,s,o,i){let r=null;if(o.logExists&&o.data&&o.data.length){let l=o.data.length,n="x",h=this.getInfoForGraph(s,"ykeys"),d=h.reduce((e,t)=>(e[t]=0,e),{});d=o.data.reduce((e,t)=>{for(let[s,a]of Object.entries(t))e.hasOwnProperty(s)&&(e[s]+=a);return e},d);let p=Object.values(d).map(e=>Math.floor(e/l)),m={element:e,data:o.data,xkey:n,ykeys:h,labels:this.getInfoForGraph(s,"labels"),xLabelAngle:0,parseTime:!1,ymin:0,yLabelFormat:e=>Math.round(e),padding:8,hideHover:!0,pointSize:2.5,lineColors:this.getInfoForGraph(s,"lineColors"),pointFillColors:this.getInfoForGraph(s,"pointFillColors"),pointStrokeColors:["#141519"],lineWidth:1.5,grid:!0,gridTextColor:"#63676a",gridTextSize:10,gridTextFamily:'Arial, "Oxygen Bold"',gridStrokeWidth:.3,behaveLikeLine:!0,goals:p,goalStrokeWidth:1,goalLineColors:["#c2760c"],smooth:!0,fillOpacity:.5,areaColors:["#c2760c","#c2760c"],belowArea:!0,dataLabels:!1,eventStrokeWidth:1,eventLineColors:["#63676a"],nbYkeys2:this.getInfoForGraph(s,"nbYkeys2")};i>0&&(m.events=[i]),this["_aChart_"+s]=a.Line(m),r={};let f=[],g=this.getInfoForGraph(s,"infoLabels");p.forEach((e,t)=>{f.push({label:g[t],value:e,class:"txt-color txt-color-orangeDark"})}),r.rows=f;let c=t.getServerTime(),y=t.convertTimestampToServerTime(o.updated),u=t.getTimeDiffParts(y,c);r.title='<i class="fas fa-download"></i><span class="pull-right ">'+t.formatTimeParts(u)+"</span>"}else e.css("height","22px").text("No data");return r}beforeDestroy(){super.beforeDestroy();for(let e of Object.keys(this._config.systemGraphs))"object"==typeof this["_aChart_"+e]&&(this["_aChart_"+e].destroy(),delete this["_aChart_"+e])}onSortableEvent(e,t){if(super.onSortableEvent(e,t),"add"===t.type&&t.from!==t.to)for(let e of Object.keys(this._config.systemGraphs))"object"==typeof this["_aChart_"+e]&&this["_aChart_"+e].resizeHandler()}static addSystemGraphTooltip(t,s,a={}){let o="<table>";for(let e of s){let t=e.class||"";o+="<tr>",o+="<td>",o+=e.label,o+="</td>",o+='<td class="text-right '+t+'">',o+=e.value,o+="</td>",o+="</tr>"}let i={placement:"top",html:!0,trigger:"hover",container:"body",title:"Info",content:o+="</table>",delay:{show:0,hide:0}};return a=Object.assign({},i,a),e(t).popover(a)}};return o.isPlugin=!1,o.scope="system",o.sortArea="a",o.position=3,o.label="Graphs",o.defaultConfig={className:"pf-system-graph-module",sortTargetAreas:["a","b","c"],systemGraphClass:"pf-system-graph",systemGraphs:{jumps:{headline:"Jumps",postUnits:"jumps",ykeys:["y"],nbYkeys2:0,labels:["Jumps"],lineColors:["#375959"],pointFillColors:["#477372"],infoLabels:["Avg. jumps"]},shipKills:{headline:"Ship/POD Kills",postUnits:"kills",ykeys:["y","z"],nbYkeys2:1,labels:["Ships","PODs"],lineColors:["#375959","#477372"],pointFillColors:["#477372","#568a89"],infoLabels:["Avg. ship kills","Avg. pod kills"]},factionKills:{headline:"NPC Kills",postUnits:"kills",ykeys:["y"],nbYkeys2:0,labels:["NPCs"],lineColors:["#375959"],pointFillColors:["#477372"],infoLabels:["Avg. NPC kills"]}}},o});
//# sourceMappingURL=system_graph.js.map
