define(["jquery","app/init","app/util","module/base","app/map/map","app/map/util","app/ui/form_element"],(e,t,a,n,l,o,s)=>{"use strict";let i=class TheraModule extends n{constructor(e={}){e.eveScoutUrl=new URL(t.url.eveScout),super(Object.assign({},new.target.defaultConfig,e))}getIconForUndefinedCellValue(){return'<i class="fas fa-question txt-color txt-color-orangeDark"></i>'}getIconForStatusCellValue(e=""){let t="";switch(e){case"warning":t=`not in ${this._config.eveScoutUrl.hostname.replace("www.","")} connections`;break;case"success":t=`in ${this._config.eveScoutUrl.hostname.replace("www.","")} connections`;break;case"hint":t+="sync connections/signatures";break;default:t="not mapped"}return`<i class="fas fa-circle txt-color txt-color-${e}" title="${t}"></i>`}getTableId(...e){return n.Util.getTableId(this._config.theraTableId,...e)}getRowId(e,t){return n.Util.getTableRowId(this._config.theraTableRowIdPrefix,e,t)}getRowById(e,t){return e.rows().ids().toArray().find(a=>a===this.getRowId(n.Util.getObjVal(this.getTableMetaData(e),"type"),t))}getTableMetaData(e){return e?e.init().pfMeta:null}render(t){return this._mapId=t,this._bodyEl=Object.assign(document.createElement("div"),{className:this._config.bodyClassName}),this.moduleElement.append(this._bodyEl),this._bodyEl.append(this.newControlElement("Thera not found on map. Click here to add",[this._config.moduleHeadlineIconClass,this._config.controlAreaTheraClass,"hidden"],["fa-plus"])),e(this.moduleElement).showLoadingAnimation(),this.initTheraTable(),this.setModuleObserver(),this.moduleElement}initTheraTable(){let a=this,i=document.createElement("table");i.id=a.getTableId("thera",a._mapId),i.classList.add("compact","stripe","order-column","row-border","pf-table-fixed",a._config.globalTheraTableClass),this._bodyEl.append(i),this._tableApi=e(i).DataTable({pfMeta:{type:"theraConnection"},paging:!1,ordering:!0,order:[[0,"desc"],[8,"desc"]],orderFixed:[[10,"desc"]],info:!1,searching:!1,hover:!1,autoWidth:!1,rowId:e=>a.getRowId("theraConnection",e.id),select:{style:"os",selector:"td:not(."+a._config.tableCellActionClass+")"},language:{emptyTable:"No Thera connections found"},columnDefs:[{targets:0,name:"syncStatus",title:"",width:2,className:"text-center",data:"syncStatus",defaultContent:a.getIconForStatusCellValue(),render:{display:(e,t,n,l)=>a.getIconForStatusCellValue(e),sort:e=>["warning","hint","success"].indexOf(e)}},{targets:1,name:"trueSec",title:"sec",width:15,className:"text-center",data:"target.trueSec",defaultContent:a.getIconForUndefinedCellValue(),render:{display:(e,t,a,l)=>{if(void 0!==e){return'<span class="'+n.Util.getTrueSecClassForSystem(e)+'">'+e.toFixed(1)+"</span>"}}}},{targets:2,name:"systemName",title:"system",className:a._config.tableCellEllipsisClass,data:"target",defaultContent:a.getIconForUndefinedCellValue(),render:{display:(e,t,l,o)=>{return`<span data-systemid="${e.id||""}" class="${e.name&&(n.Util.getObjVal(l,"relRowId")||n.Util.getObjVal(l,"connectionId"))?a._config.linkClass:""}">${e.name||""}</span>`},sort:"name"}},{targets:3,name:"region",title:"region",className:a._config.tableCellEllipsisClass,data:"target",defaultContent:a.getIconForUndefinedCellValue(),render:{_:"region.name"}},{targets:4,name:"outSig",title:'<i title="Out signature" data-toggle="tooltip" class="fas fa-sign-out-alt fa-rotate-270"></i>',width:12,className:["text-center",a._config.fontUppercaseClass].join(" "),data:"sourceSignature",defaultContent:a.getIconForUndefinedCellValue(),render:{_:"name"}},{targets:5,name:"fakeConnection",title:"con.",orderable:!1,width:30,className:"text-center",data:"fakeConnection",defaultContent:""},{targets:6,name:"inSig",title:'<i title="In signature" data-toggle="tooltip" class="fas fa-sign-in-alt fa-rotate-90"></i>',width:12,className:["text-center",a._config.fontUppercaseClass].join(" "),data:"targetSignature",defaultContent:a.getIconForUndefinedCellValue(),render:{_:"name"}},{targets:7,name:"wormholeLabel",title:"type",width:50,className:a._config.tableCellTypeClass,data:"wormholeLabel",defaultContent:a.getIconForUndefinedCellValue(),render:{display:(e,a,l,o)=>{if(e){let a=n.Util.getObjVal(t,`wormholes.${e}`),l=n.Util.getObjVal(a,"security");return[...s.formatSignatureTypeSelectionData({text:`${e} - ${l}`},void 0,{showWhSizeLabel:!1})].reduce((e,t)=>e+=t.outerHTML,"")}}}},{targets:8,name:"estimatedLife",title:'<i title="estimated lifetime" data-toggle="tooltip" class="fas fa-hourglass-start"></i>',width:15,className:"text-right",data:"estimatedEol",defaultContent:a.getIconForUndefinedCellValue(),render:{display:(e,t,a,n)=>{try{let t=(new Date).getTime(),a=Date.parse(e);if(!isNaN(t)&&!isNaN(a)){let e=(a-t)/1e3;return e/=3600,`< ${Math.ceil(e)}h`}}catch(e){}},sort:e=>Date.parse(e)}},{targets:9,name:"action",title:"",orderable:!1,width:10,className:["text-center",a._config.tableCellActionClass,a._config.moduleHeadlineIconClass].join(" "),data:null,render:{display:e=>{let t="";return e.connectionId?t='<i class="fas fa-times txt-color txt-color-redDark"></i>':e.syncStatus||(t='<i class="fas fa-plus"></i>'),t}},createdCell:function(t,s,i,r,d){let c=this.api();t.addEventListener("click",s=>{s.stopPropagation();let d=c.row(s.target.closest("tr"));if((i=d.data()).connectionId){let l,s={systemIds:[],connectionIds:[]},d=c.rows({selected:!0});d.count()>1&&c.row(r,{selected:!0}).count()?l=`delete ${(s=d.data().toArray().reduce((e,t)=>(e.systemIds.push(n.Util.getObjVal(t,"target.realId")),e.connectionIds.push(n.Util.getObjVal(t,"connectionId")),e),s)).systemIds.length} systems`:(d=c.row(e(t).parents("tr")),i=d.data(),s.systemIds.push(n.Util.getObjVal(i,"target.realId")||0),s.connectionIds.push(n.Util.getObjVal(i,"connectionId")||0),l=`delete '${n.Util.getObjVal(i,"target.name")}'`);let m={title:"---",template:n.Util.getConfirmationTemplate(n.Util.getConfirmationContent([{name:"deleteSystems",value:1,label:l,class:"pf-editable-warn",checked:!1}]),{size:"small",noTitle:!0}),trigger:"manual",onConfirm:function(t,l){t.preventDefault();let i=l.data("bs.confirmation").tip().find("form:not(.hidden)").first().getFormValues();if(n.Util.getObjVal(i,"deleteSystems")){let t=n.Util.getMapModule().getActiveMap(),l=s.systemIds.map(e=>document.getElementById(o.getSystemId(a._mapId,e))).filter(Boolean);e(a.moduleElement).showLoadingAnimation(),t.trigger("pf:deleteSystems",[{systems:l,callback:t=>{t.length?d.remove().draw():this.showNotify({title:"Failed to delete system",type:"error"}),e(a.moduleElement).hideLoadingAnimation()}}])}else{let t=s.connectionIds.map(t=>e().getConnectionById(a._mapId,t)).filter(Boolean);e(a.moduleElement).showLoadingAnimation(),o.deleteConnections(t,()=>{d.remove().draw(),e(a.moduleElement).hideLoadingAnimation()})}}};e(t).confirmation("destroy").confirmation(m).confirmation("show")}else if(!i.syncStatus){let t=o.getSystemData(a._mapId,TheraModule.systemIdThera,"systemId"),s=o.getSystemData(a._mapId,n.Util.getObjVal(i,"target.id"),"systemId");if(t&&s){let n=o.getMapInstance(a._mapId),r={source:t.id,target:s.id,scope:i.scope,type:i.type};e(a.moduleElement).showLoadingAnimation(),l.drawConnection(n,r).then(e=>l.saveConnection(e.data.connection,!0)).catch(console.warn)}else{let l={systemData:{id:n.Util.getObjVal(i,"target.id"),name:n.Util.getObjVal(i,"target.name")}};if(t){let a=document.getElementById(o.getSystemId(t.mapId,t.id));a&&(l.sourceSystem=e(a),l.connectionData={scope:i.scope,type:i.type,disableAutoScope:!0})}a.showNewSystemDialog(l)}}})}},{targets:10,name:"rowGroupData",className:"never",data:"rowGroupData",defaultContent:0,visible:!1,render:{sort:"id"}}],drawCallback:function(t){let a=this.api().rows().nodes().to$().filter(function(){return e(this).data("animationStatus")||e(this).data("animationTimer")});a.initTooltips();for(let t=0;t<a.length;t++){let n=e(a[t]);n.pulseBackgroundColor(n.data("animationStatus")),n.removeData("animationStatus")}},initComplete:function(t,l){a.getTheraConnectionsData("callbackUpdateTableRows");let s=this.api(),i=null;s.tables().nodes().to$().on("mouseenter","td",function(){if(i=n.Util.getObjVal(s.row(this.parentElement).data(),"relRowId")||null){let e=s.cell(this).index().column;if(e<=8){let t=s.cell(this),n=s.cell(`#${a.getRowById(s,i)}`,e);if(t.nodes().to$().addClass("cellHighlight"),n.nodes().to$().addClass("cellHighlight"),[4,5,6,7,8].includes(e)){let e=t.node(),a=n.node();e&&a&&e.innerHTML!==a.innerHTML&&(e.dataset.origValue=e.innerHTML,e.innerHTML=a.innerHTML)}}}}).on("mouseleave","td",function(){i&&(this.dataset.origValue&&(this.innerHTML=this.dataset.origValue,delete this.dataset.origValue),s.cells().nodes().to$().removeClass("cellHighlight"),i=null)}),e(this).on("click",".pf-fake-connection",function(){let t=s.row(this.closest("tr")).data();if(t.connectionId){let n=e().getConnectionById(a._mapId,t.connectionId);if(n){let e=n._jsPlumb.instance;o.showConnectionInfo(e,[n])}}}),e(this).on("click",`.${a._config.linkClass}[data-systemid]:not([data-systemid=''])`,e=>{n.Util.triggerMenuAction(n.Util.getMapModule().getActiveMap(),"SelectSystem",{systemId:o.getSystemData(a._mapId,parseInt(e.target.dataset.systemid),"systemId").id})})},data:[]});new e.fn.dataTable.Buttons(this._tableApi,{dom:{container:{tag:"h5",className:"pull-right"},button:{tag:"i",className:["fas","fa-fw",a._config.moduleHeadlineIconClass].join(" ")},buttonLiner:{tag:null}},name:"tableTools",buttons:[{name:"eveScout",className:"fa-external-link-alt",titleAttr:a._config.eveScoutUrl.hostname.replace("www.",""),attr:{"data-toggle":"tooltip","data-html":!0},action:function(e,t,n,l){e.stopPropagation(),window.open(`//${a._config.eveScoutUrl.hostname}`,"_blank")}},{name:"refresh",className:"fa-sync",titleAttr:"refresh",attr:{"data-toggle":"tooltip","data-html":!0},action:function(t,n,l,o){e(a.moduleElement).showLoadingAnimation(),a.getTheraConnectionsData("callbackUpdateTableRows")}}]});this._tableApi.buttons().container().appendTo(a.moduleElement.querySelector("."+a._config.headClassName)),new e.fn.dataTable.RowGroup(this._tableApi,{dataSrc:"rowGroupData.name",startRender:function(e,t,a){return'<div class="flex-row flex-between">'+`<span class="flex-col flex-grow">${t}</span>`+`<span class="flex-col">${e.count()}</span>`+"</div>"}}),this._tableApi.select(),this._tableApi.on("user-select",function(e,t,a,l,o){let s=t.row(l.index().row).data();n.Util.getObjVal(s,"connectionId")||e.preventDefault()})}showNewSystemDialog(t={},a=!1){let o=n.Util.getMapModule().getActiveMap();t.callback=((t,a,n,o)=>{e(this.moduleElement).showLoadingAnimation(),l.saveSystemCallback(t,a,n,o)}),n.Util.triggerMenuAction(o,"AddSystem",t)}getTheraConnectionsData(t,a=null){this.getLocalStore().getItem("eveScout").then(t=>new Promise(a=>{t&&t.tSet&&TheraModule.ttlEveScoutResponse>n.now()-t.tSet?(e(this.moduleElement).hideLoadingAnimation(),a(t.value)):this.request("GET","SystemThera",[],{},this,t=>{e(this.moduleElement).hideLoadingAnimation()}).then(e=>{let t={tSet:n.now(),value:Array.isArray(e.data)?e.data:[]};this.getLocalStore().setItem("eveScout",t).then(e=>a(e.value))}).catch(e=>{let t=e.data.status+" "+e.data.error;this.showNotify({title:e.data.jqXHR.status+": Thera connections data",text:t,type:"warning"}),a([])})})).then(e=>this[t](e,a))}callbackUpdateTableRows(a=[],l=null){if(!this._tableApi)return;a=Array.isArray(a)?a:[];let s=(e,t)=>`${e.id}-${t}`,i=[],r=this._tableApi.rows().any(),d={added:0,changed:0,deleted:0},c=o.getMapInstance(this._mapId),m=n.Util.getCurrentMapData(this._mapId);if(c&&m){let g={id:this._mapId,name:n.Util.getObjVal(m,"config.name")},u={id:0,name:"eve-scout.com"},h={},p=!1;if(l){p=!0;let e=o.searchConnectionsBySystems(c,[l],"*");h=n.getConnectionsDataFromConnections(this._mapId,e)}else{let e=o.getSystemData(this._mapId,TheraModule.systemIdThera,"systemId");if(e){p=!0;let t=o.getSystemId(this._mapId,e.id),a=o.searchConnectionsBySystems(c,[t],"*");h=n.getConnectionsDataFromConnections(this._mapId,a)}}this._bodyEl.querySelector(`.${this._config.controlAreaTheraClass}`).classList.toggle("hidden",p);new Date;let f=[],b=[],y=e=>({id:e.ids,name:e.names.length?e.names.map(e=>e.substring(0,3)).join(", "):null,type:{name:e.labels.length?e.labels.join(", "):null}}),w=(e,t="id")=>a=>a[t]===e;for(let a of Object.values(h)){let l=n.Util.getObjVal(a,"connection.id")||0,i=n.Util.getObjVal(a,"connection.updated")||0,r=a.source,d=a.target,c=n.getConnectionDataCacheKey(r.name,d.name),u=o.getConnectionDataFromMapData(m,l),h=e().getConnectionById(this._mapId,l),p=o.getConnectionDataFromSignatures(h,u),b=y(p.source),C=y(p.target);"thera"===d.name.toLowerCase()&&([r,d]=[d,r],[b,C]=[C,b]);let I,S=null,T=0;for(let e of Object.values(p)){if(!e.labels)continue;let t=e.labels.findIndex(e=>"K162"!==e);if(-1!==t){S=e.labels[t],T=e.ids[t];break}}let _=n.Util.getObjVal(Object.assign({},t.wormholes[S]),"maxStableTime");if(_&&T){let e=(n.Util.getObjVal(u,"signatures")||[]).find(w(T)),t=n.Util.getObjVal(e,"created.created")||0;if(t){let e=new Date(1e3*t);e.setHours(e.getHours()+_),I=e.toISOString()}}let U={id:s(g,c),hash:c,scope:n.Util.getObjVal(a,"connection.scope"),type:n.Util.getObjVal(a,"connection.type"),source:(({id:e,systemId:t,name:a,trueSec:n,constellation:l,region:o})=>({realId:e,id:t,name:a,trueSec:n,constellation:l,region:o}))(o.getSystemDataFromMapData(m,r.id)),target:(({id:e,systemId:t,name:a,trueSec:n,constellation:l,region:o})=>({realId:e,id:t,name:a,trueSec:n,constellation:l,region:o}))(o.getSystemDataFromMapData(m,d.id)),sourceSignature:b,targetSignature:C,wormholeLabel:S,syncStatus:"warning",rowGroupData:g,connectionId:l,fakeConnection:n.getFakeConnectionElement(a),estimatedEol:I,updated:i,updatedHash:[i,p.hash].join().hashCode()};f.push(U)}for(let e of a){let a=n.Util.getObjVal(e,"source.name"),l=n.Util.getObjVal(e,"target.name"),o=n.getConnectionDataCacheKey(a,l),i=n.Util.getObjVal(e,"sourceSignature.type.name")||null;i||(i=n.Util.getObjVal(e,"targetSignature.type.name")||null);let r=n.Util.getObjVal(Object.assign({},t.wormholes[i]),"size.type"),d=[...e.type,r];e.id=s(u,o),e.hash=o,e.wormholeLabel=i,e.syncStatus=null,e.rowGroupData=u,e.connectionId=null,e.type=d,e.fakeConnection=n.getFakeConnectionElement(n.getFakeConnectionData({system:a},{system:l},e.scope,e.type)),e.updatedHash=String(e.updated).hashCode(),b.push(e)}for(let e of f){let t=b.findIndex(w(e.hash,"hash"));if(-1!==t){let a=[e.updatedHash,b[t].updatedHash].join().hashCode();e.syncStatus="success",e.relRowId=b[t].id,e.updatedHash=a,b[t].syncStatus="hint",b[t].relRowId=e.id,b[t].updatedHash=a}}let C=[...f,...b];for(let e of C){let t=this.getRowById(this._tableApi,e.id);if(t){let a=this._tableApi.row("#"+t),l=a.data();n.Util.getObjVal(l,"updatedHash")!==n.Util.getObjVal(e,"updatedHash")&&(a.data(e),a.nodes().to$().data("animationStatus","changed"),d.changed++),i.push(a.id())}else{let t=this._tableApi.row.add(e);t.nodes().to$().data("animationStatus","added"),d.added++,i.push(t.id())}}let I=this._tableApi.rows((e,t,a)=>!i.includes(a.id));d.deleted+=I.ids().count(),I.remove(),Math.max(...Object.values(d))&&this._tableApi.draw();let S=Object.keys(d).reduce((e,t)=>`${e}${d[t]?`${d[t]} ${t}<br>`:""}`,"");r&&S.length&&this.showNotify({title:"Thera connections updated",text:S,type:"success",textTrusted:!0})}else console.warn("Table update failed for Thera connections. MapData is missing")}setModuleObserver(){this._bodyEl.querySelector(`.${this._config.controlAreaTheraClass}`).addEventListener("click",e=>{this.showNewSystemDialog({systemData:{id:TheraModule.systemIdThera,name:"Thera"}},!0)},!1),o.initWormholeInfoTooltip(e(this.moduleElement).find("."+this._config.globalTheraTableClass),`.${this._config.tableCellTypeClass} span[class^="pf-system-sec-"]`),e(this.moduleElement).initTooltips()}update(e){return super.update(e).then(e=>new Promise(e=>{this.getTheraConnectionsData("callbackUpdateTableRows"),e({action:"update",data:{module:this}})}))}};return i.isPlugin=!1,i.scope="global",i.sortArea="b",i.position=3,i.label="Thera",i.systemIdThera=31000005,i.ttlEveScoutResponse=120,i.defaultConfig={className:"pf-global-thera-module",sortTargetAreas:["a","b","c"],headline:"Thera Connection",theraTableId:"pf-thera-table-",theraTableRowIdPrefix:"pf-thera-row-",globalTheraTableClass:"pf-global-thera-table",controlAreaTheraClass:"pf-global-thera-control",fontUppercaseClass:"pf-font-uppercase",linkClass:"pf-link",tableCellTypeClass:"pf-table-type-cell",tableCellEllipsisClass:"pf-table-cell-ellipses-auto",tableCellActionClass:"pf-table-action-cell"},i});
//# sourceMappingURL=global_thera.js.map
