define(["jquery","app/init","app/util","bootbox","app/map/util","module/base"],(e,t,a,s,o,l)=>{"use strict";let r=class SystemRouteModule extends l{constructor(e={}){super(Object.assign({},new.target.defaultConfig,e))}update(e){return super.update(e).then(e=>new Promise(t=>{switch(e.task){case"showFindRouteDialog":this.showFindRouteDialog({mapId:this._systemData.mapId,systemFromData:this._systemFromData,systemToData:e.systemToData});break;case"findRoute":this.drawRouteTable(this._systemData.mapId,this._systemFromData,[e.systemToData],this._routeSettings)}t({action:"update",data:{module:this}})}))}render(e,t){return this._systemData=t,this._systemFromData={systemId:t.systemId,name:t.name},this._bodyEl=Object.assign(document.createElement("div"),{className:this._config.bodyClassName}),this.moduleElement.append(this._bodyEl),this.initRouteTable(),this.setModuleObserver(),this.moduleElement}setModuleObserver(){e(this.moduleElement).initTooltips({placement:"top"})}initRouteTable(){let s=this,l=document.createElement("table");l.classList.add("compact","stripe","order-column","row-border",s._config.systemInfoRoutesTableClass),this._bodyEl.append(l),this._tableApi=e(l).DataTable({paging:!1,ordering:!0,order:[[2,"asc"],[0,"asc"]],info:!1,searching:!1,hover:!1,autoWidth:!1,rowId:"systemTo",language:{emptyTable:"No routes added"},columnDefs:[{targets:0,orderable:!0,title:"",width:2,class:["text-center"].join(" "),data:"status",render:{_:"formatted",sort:"value"}},{targets:1,orderable:!0,title:"system&nbsp;&nbsp;&nbsp;",class:a.config.popoverTriggerClass,data:"systemToData",render:{_:"name",sort:"name"},createdCell:function(t,a,o,l,r){s.initSystemPopover(e(t),{systemToData:o.systemToData}),e(t).toggleClass(s._config.rallyClass,a.hasOwnProperty("rally"))}},{targets:2,orderable:!0,title:'<span title="jumps"><i class="fas fa-arrows-alt-h"></i>&nbsp;&nbsp;</span>',width:16,class:"text-right",data:"jumps",render:{_:"formatted",sort:"value"}},{targets:3,orderable:!0,title:'<span title="average security">&#216;&nbsp;&nbsp;</span>',width:14,class:"text-right",data:"avgTrueSec",render:{_:"formatted",sort:"value"}},{targets:4,orderable:!1,title:"route",class:[this._config.dataTableRouteCellClass].join(" "),data:"route",render:{_:"value"}},{targets:5,title:'<i title="toggle connections" class="fas fa-code-branch fa-rotate-270 text-right"></i>',orderable:!1,searchable:!1,width:10,class:["text-center",this._config.dataTableActionCellClass].join(" "),data:"connections",render:{_:"button"},createdCell:function(t,a,o,l,r){let i=this.api();e(t).on("click",function(t){let a=i.cell(l,4).nodes().to$();a.hasClass(s._config.dataTableJumpCellClass)?(a.toggleClass(s._config.dataTableJumpCellClass,!1),e(this).find("i").toggleClass("txt-color-orange",!1)):(a.toggleClass(s._config.dataTableJumpCellClass,!0),e(this).find("i").toggleClass("txt-color-orange",!0))})}},{targets:6,title:'<i title="search safer (HS)" class="fas fa-shield-alt text-right"></i>',orderable:!1,searchable:!1,width:10,class:["text-center",this._config.dataTableActionCellClass].join(" "),data:"flag",render:{_:"button"},createdCell:function(t,a,o,l,r){let i=this.api();e(t).on("click",function(a){o=i.row(e(t).parents("tr")).data();let l=s.getRouteRequestDataFromRowData(o,s._routeSettings);l.skipSearch=0,l.flag="shortest"===l.flag?"secure":"shortest";let r={routeData:[l]};s.getRouteData(r,"callbackAddRouteRows")})}},{targets:7,title:"",orderable:!1,searchable:!1,width:10,class:["text-center",this._config.dataTableActionCellClass].join(" "),data:"reload",render:{_:"button"},createdCell:function(t,a,o,l,r){let i=this.api();e(t).on("click",function(a){o=i.row(e(t).parents("tr")).data();let l=s.getRouteRequestDataFromRowData(o,s._systemData.mapId,s._routeSettings);l.skipSearch=0;let r={routeData:[l]};s.getRouteData(r,"callbackAddRouteRows")})}},{targets:8,title:"",orderable:!1,searchable:!1,width:10,class:["text-center",this._config.dataTableActionCellClass].join(" "),data:"clear",render:{_:"button"},createdCell:function(t,s,o,l,r){let i=this,n={title:"---",template:a.getConfirmationTemplate(null,{size:"small",noTitle:!0}),onConfirm:function(a,s){let o=e(t).parents("tr");i.api().rows(o).remove().draw()}};e(t).confirmation(n)}}],drawCallback:function(t){let a=this.api().rows().nodes().to$().filter(function(){return e(this).data("animationStatus")||e(this).data("animationTimer")});for(let t=0;t<a.length;t++){let s=e(a[t]);s.pulseBackgroundColor(s.data("animationStatus")),s.removeData("animationStatus")}},initComplete:function(t,l){a.getLocalStore("map").getItem(s._systemData.mapId).then(e=>{let t=[{systemId:30000142,name:"Jita"}];e&&e.routes&&(t=e.routes);let a={};e&&e.routeSettings&&(a=e.routeSettings),s._routeSettings=a;let o=s.getRallySystemsData(s._systemData.mapId);o.push(...t),s.drawRouteTable(s._systemData.mapId,s._systemFromData,o,a)}),e(this).on("click",".pf-fake-connection",function(){let t=e(this),a=t.attr("data-mapId"),s=t.attr("data-connectionId"),l=e().getConnectionById(a,s);if(l){let e=l._jsPlumb.instance;o.showConnectionInfo(e,[l])}})},data:[]});new e.fn.dataTable.Buttons(this._tableApi,{dom:{container:{tag:"h5",className:"pull-right"},button:{tag:"i",className:["fas","fa-fw",s._config.moduleHeadlineIconClass].join(" ")},buttonLiner:{tag:null}},name:"tableTools",buttons:[{name:"settings",className:["fa-sliders-h"].join(" "),titleAttr:"settings",attr:{"data-toggle":"tooltip","data-html":!0},action:function(e,t,a,o){s.showSettingsDialog({mapId:s._systemData.mapId,systemFromData:s._systemFromData})}},{name:"search",className:"fa-search",titleAttr:"find&nbsp;route",attr:{"data-toggle":"tooltip","data-html":!0},action:function(e,a,o,l){let r=t.routeSearch.limit;a.rows().count()>=r?s.showNotify({title:"Route limit reached",text:"Search is limited by "+r,type:"warning"}):s.showFindRouteDialog({mapId:s._systemData.mapId,systemFromData:s._systemFromData})}},{name:"refresh",className:"fa-sync",titleAttr:"refresh",attr:{"data-toggle":"tooltip","data-html":!0},action:function(e,t,a,o){s.updateRoutesTable()}}]});this._tableApi.buttons().container().appendTo(s.moduleElement.querySelector("."+s._config.headClassName))}drawRouteTable(e,a,s,o){let l=[],r=t.routeSearch.defaultCount,i=[];for(let t of s)if(a.name!==t.name){let s=this.getRouteDataCacheKey([e],a.name,t.name),n=SystemRouteModule.getCache("routes").get(s);if(n)i.push(this.addRow(n));else{let s={mapIds:[e],systemFromData:a,systemToData:t,skipSearch:l.length>=r};l.push(this.getRouteRequestDataFromRowData(s,o))}}if(i.length&&this._tableApi.draw(),l.length>0){let e={routeData:l};this.getRouteData(e,"callbackAddRouteRows")}}getRouteDataCacheKey(e,t,a){return"route_"+`${e.join("_")}${t}${a}`.hashCode()}getRouteRequestDataFromRowData(e,t){return{mapIds:e.hasOwnProperty("mapIds")?e.mapIds:[],systemFromData:e.hasOwnProperty("systemFromData")?e.systemFromData:{},systemToData:e.hasOwnProperty("systemToData")?e.systemToData:{},skipSearch:e.hasOwnProperty("skipSearch")?0|e.skipSearch:0,stargates:e.hasOwnProperty("stargates")?0|e.stargates:t.stargates,jumpbridges:e.hasOwnProperty("jumpbridges")?0|e.jumpbridges:t.jumpbridges,wormholes:e.hasOwnProperty("wormholes")?0|e.wormholes:t.wormholes,wormholesReduced:e.hasOwnProperty("wormholesReduced")?0|e.wormholesReduced:t.wormholesReduced,wormholesCritical:e.hasOwnProperty("wormholesCritical")?0|e.wormholesCritical:t.wormholesCritical,wormholesEOL:e.hasOwnProperty("wormholesEOL")?0|e.wormholesEOL:t.wormholesEOL,wormholesThera:e.hasOwnProperty("wormholesThera")?0|e.wormholesThera:t.wormholesThera,wormholesSizeMin:e.hasOwnProperty("wormholesSizeMin")?e.wormholesSizeMin:t.wormholesSizeMin,excludeTypes:e.hasOwnProperty("excludeTypes")?e.excludeTypes:t.excludeTypes,endpointsBubble:e.hasOwnProperty("endpointsBubble")?0|e.endpointsBubble:t.endpointsBubble,connections:e.hasOwnProperty("connections")?0|e.connections.value:0,flag:e.hasOwnProperty("flag")?e.flag.value:"shortest"}}getRouteData(t,a){e(this.moduleElement).showLoadingAnimation(),this.request("POST","Route",[],t,this,t=>{e(this.moduleElement).hideLoadingAnimation()}).then(e=>e.context[a](e.data.routesData)).catch(e=>{let t=e.data.status+" "+e.data.error;this.showNotify({title:e.data.jqXHR.status+": System route data",text:t,type:"warning"})})}updateRoutesTable(){let e=this,t=[];this._tableApi.rows().every(function(){t.push(e.getRouteRequestDataFromRowData(this.data(),e._systemData.mapId))}),this.getRouteData({routeData:t},"callbackAddRouteRows")}callbackAddRouteRows(e){if(e.length>0){for(let t of e){let e=this.formatRouteData(t);if(e.route){let a=this.getRouteDataCacheKey(e.mapIds,t.systemFromData.name,t.systemToData.name);SystemRouteModule.getCache("routes").set(a,e),this.addRow(e)}}this._tableApi.draw()}}addRow(e){let t,a=null,s="changed",o=this._tableApi.rows().eq(0).filter(t=>this._tableApi.cell(t,1).data().name===e.systemToData.name);return o.length>0?(t=this._tableApi.row(parseInt(o[0]))).data(e):(t=this._tableApi.row.add(e),s="added"),t.length>0&&((a=t.nodes().to$()).data("animationStatus",s),a.initTooltips()),a}formatRouteData(e){let t=e=>/^J\d+$/.test(e)||"Thera"===e,a=e.skipSearch?2:0,s="secure"===e.flag?"txt-color-success":"",o='<i class="fas '+["fa-code-branch","fa-rotate-270","txt-color"].join(" ")+'"></i>',r='<i class="fas '+["fa-shield-alt","txt-color",s].join(" ")+'"></i>',i='<i class="fas '+["fa-sync"].join(" ")+'"></i>',n='<i class="fas '+["fa-search"].join(" ")+'"></i>',c='<i class="fas '+["fa-times","txt-color","txt-color-redDark"].join(" ")+'"></i>',d={systemFromData:e.systemFromData,systemToData:e.systemToData,jumps:{value:9999,formatted:""},avgTrueSec:{value:"",formatted:""},route:{value:2===a?"search now":"not found",data:e.route},stargates:e.stargates,jumpbridges:e.jumpbridges,wormholes:e.wormholes,wormholesReduced:e.wormholesReduced,wormholesCritical:e.wormholesCritical,wormholesEOL:e.wormholesEOL,wormholesThera:e.wormholesThera,wormholesSizeMin:e.wormholesSizeMin,excludeTypes:e.excludeTypes,endpointsBubble:e.endpointsBubble,connections:{value:0,button:o},flag:{value:e.flag,button:r},reload:{button:e.skipSearch?n:i},clear:{button:c},maps:e.maps,mapIds:e.mapIds};if(!0===e.routePossible&&e.route.length>0){a=1;let s=[],o=0,r=l.getConnectionsDataFromMaps(e.mapIds),i=null;for(let a=0;a<e.route.length;a++){let n=e.route[a],c=n.system;if(i){let e=l.findConnectionsData(r,i.system,c);e||(e=l.getFakeConnectionData(i,n,t(c)?"wh":"stargate"));let a=l.getFakeConnectionElement(e);s.push(a)}let d=Number(n.security).toFixed(1).toString(),m=d;m<=0&&(m="0-0");let u=this._config.systemSecurityClassPrefix+m.replace(".","-"),h="fas fa-square-full";t(c)&&(h="fas fa-dot-circle");let p='<i class="'+h+" "+u+'" ';p+='data-toggle="tooltip" data-placement="bottom" ',p+='title="'+c+" ["+d+'] "></i>',s.push(p),a>0&&(o+=Number(n.security)),i=n}let n=(o/(e.route.length-1)).toFixed(2),c=Number(n).toFixed(1);c<=0&&(c="0.0");let m=this._config.systemSecurityClassPrefix+c.toString().replace(".","-");d.jumps={value:e.routeJumps,formatted:e.routeJumps},d.avgTrueSec={value:n,formatted:'<span class="'+m+'">'+n+"</span>"},d.route.value=s.join(" ")}return d.status={value:a,formatted:(e=>{let t="txt-color-danger",a="route not found";switch(e){case 1:t="txt-color-success",a="route exists";break;case 2:t="txt-color-warning",a="not search performed"}return'<i class="fas fa-fw fa-circle txt-color '+t+'" title="'+a+'"></i>'})(a)},d}getRallySystemsData(t){let a=[],s=o.getMapInstance(t);if(s){let t=e(s.getContainer()).find(".pf-system-info-rally");for(let s of t)s=e(s),a.push({systemId:s.data("systemId"),name:s.data("name"),rally:1})}return a}initSystemPopover(t,s){let o=s.systemToData;requirejs(["text!templates/tooltip/system_popover.html","mustache"],(s,l)=>{let r={systemToData:o},i=l.render(s,r);t.each(function(){let t=e(this);t.popover("destroy").off(),t.popover({html:!0,title:o.name,trigger:"manual",placement:"top",container:"body",content:i}).data("bs.popover").tip().addClass(a.config.popoverClass)}),t.initPopoverClose("hideSystemPopup"),t.on("contextmenu",function(t){t.preventDefault(),e(this).popover("show")}),t.on("shown.bs.popover",function(){let t=e(this);t.data("bs.popover").tip().find("a").on("click",function(){let s={id:e(this).data("systemid"),name:e(this).data("name")};a.setDestination("set_destination","system",s),t.popover("hide")})})})}showSettingsDialog(l){a.getLocalStore("map").getItem(l.mapId).then(r=>{let i=[],n={};r&&r.routes&&(i=r.routes),r&&r.routeSettings&&(n=r.routeSettings);let c=t.routeSearch.maxDefaultCount,d={id:this._config.routeSettingsDialogId,selectClass:this._config.systemDialogSelectClass,systemSelectOptions:i,maxSelectionLength:c,routeSettings:n,select2Class:a.config.select2Class,routeDialogSizeSelectId:this._config.routeDialogSizeSelectId,select2Class:a.config.select2Class,sizeOptions:o.allConnectionJumpMassTypes().map(e=>({id:e,name:e,selected:!1}))};console.log(d),requirejs(["text!templates/dialog/route_settings.html","mustache"],(t,o)=>{let r=o.render(t,d),i=s.dialog({title:"Route settings",message:r,show:!1,buttons:{close:{label:"cancel",className:"btn-default"},success:{label:'<i class="fas fa-fw fa-check"></i>&nbsp;save',className:"btn-success",callback:t=>{let s=e(t.delegateTarget).find("form"),o=s.find("."+this._config.systemDialogSelectClass).select2("data"),r=[];o.length>0?(r=SystemRouteModule.formSystemSelectData(o),a.getLocalStore("map").setItem(`${l.mapId}.routes`,r)):a.getLocalStore("map").removeItem(`${l.mapId}.routes`);let i=e(s).getFormValues();if(i){let e={stargates:i.hasOwnProperty("stargates")?parseInt(i.stargates):0,jumpbridges:i.hasOwnProperty("jumpbridges")?parseInt(i.jumpbridges):0,wormholes:i.hasOwnProperty("wormholes")?parseInt(i.wormholes):0,wormholesReduced:i.hasOwnProperty("wormholesReduced")?parseInt(i.wormholesReduced):0,wormholesCritical:i.hasOwnProperty("wormholesCritical")?parseInt(i.wormholesCritical):0,wormholesEOL:i.hasOwnProperty("wormholesEOL")?parseInt(i.wormholesEOL):0,wormholesThera:i.hasOwnProperty("wormholesThera")?parseInt(i.wormholesThera):0,wormholesSizeMin:i.wormholesSizeMin||"",excludeTypes:SystemRouteModule.getLowerSizeConnectionTypes(i.wormholesSizeMin),endpointsBubble:i.hasOwnProperty("endpointsBubble")?parseInt(i.endpointsBubble):0};a.getLocalStore("map").setItem(`${l.mapId}.routeSettings`,e)}this.showNotify({title:"Route settings stored",type:"success"}),this.drawRouteTable(l.mapId,l.systemFromData,r,i)}}}});i.on("shown.bs.modal",t=>{e(t.target).find("."+this._config.systemDialogSelectClass).delay(240).initSystemSelect({key:"id",maxSelectionLength:c}),e(t.target).find("#"+this._config.routeDialogSizeSelectId).initConnectionSizeSelect()}),i.modal("show")})})}showFindRouteDialog(t){let l=[],r=a.getCurrentMapData();if(!1!==r)for(let e=0;e<r.length;e++)l.push({id:r[e].config.id,name:r[e].config.name,selected:t.mapId===r[e].config.id});let i={id:this._config.routeDialogId,select2Class:a.config.select2Class,selectClass:this._config.systemDialogSelectClass,routeDialogMapSelectId:this._config.routeDialogMapSelectId,routeDialogSizeSelectId:this._config.routeDialogSizeSelectId,systemFromData:t.systemFromData,systemToData:t.systemToData,mapSelectOptions:l,sizeOptions:o.allConnectionJumpMassTypes().map(e=>({id:e,name:e,selected:!1}))};requirejs(["text!templates/dialog/route.html","mustache"],(a,o)=>{let l=o.render(a,i),r=s.dialog({title:"Route finder",message:l,show:!1,buttons:{close:{label:"cancel",className:"btn-default"},success:{label:'<i class="fas fa-fw fa-search"></i>&nbsp;search route',className:"btn-primary",callback:a=>{let s=e(a.delegateTarget).find("form"),o=e(s).getFormValues();if(s.validator("validate"),!1===s.isValidForm())return!1;let l=s.find("."+this._config.systemDialogSelectClass).select2("data");if(l&&1===l.length){let e={routeData:[{mapIds:o.mapIds,systemFromData:t.systemFromData,systemToData:{systemId:parseInt(l[0].id),name:l[0].text},stargates:o.hasOwnProperty("stargates")?parseInt(o.stargates):0,jumpbridges:o.hasOwnProperty("jumpbridges")?parseInt(o.jumpbridges):0,wormholes:o.hasOwnProperty("wormholes")?parseInt(o.wormholes):0,wormholesReduced:o.hasOwnProperty("wormholesReduced")?parseInt(o.wormholesReduced):0,wormholesCritical:o.hasOwnProperty("wormholesCritical")?parseInt(o.wormholesCritical):0,wormholesEOL:o.hasOwnProperty("wormholesEOL")?parseInt(o.wormholesEOL):0,wormholesThera:o.hasOwnProperty("wormholesThera")?parseInt(o.wormholesThera):0,wormholesSizeMin:o.wormholesSizeMin||"",excludeTypes:SystemRouteModule.getLowerSizeConnectionTypes(o.wormholesSizeMin),endpointsBubble:o.hasOwnProperty("endpointsBubble")?parseInt(o.endpointsBubble):0,flag:o.hasOwnProperty("flag")?o.flag:"shortest"}]};this.getRouteData(e,"callbackAddRouteRows")}}}}});r.on("show.bs.modal",t=>{e(t.target).initTooltips(),this.setDialogObserver(e(t.target)),e(t.target).find("#"+this._config.routeDialogMapSelectId).initMapSelect(),e(t.target).find("#"+this._config.routeDialogSizeSelectId).initConnectionSizeSelect()}),r.on("shown.bs.modal",t=>{e(t.target).find("."+this._config.systemDialogSelectClass).delay(240).initSystemSelect({key:"id"})}),r.modal("show")})}setDialogObserver(t){let a=t.find('input[type="checkbox"][name="wormholes"]'),s=t.find('input[type="checkbox"][name="wormholesReduced"]'),o=t.find('input[type="checkbox"][name="wormholesCritical"]'),l=t.find('input[type="checkbox"][name="wormholesEOL"]'),r=t.find('input[type="checkbox"][name="wormholesThera"]'),i=t.find("#"+this._config.routeDialogSizeSelectId),n=()=>{s.data("selectState",s.prop("checked")),o.data("selectState",o.prop("checked")),l.data("selectState",l.prop("checked")),r.data("selectState",r.prop("checked"))},c=t=>{e(t.target).is(":checked")?(i.prop("disabled",!1),s.prop("disabled",!1),o.prop("disabled",!1),l.prop("disabled",!1),r.prop("disabled",!1),s.prop("checked",s.data("selectState")),o.prop("checked",o.data("selectState")),l.prop("checked",l.data("selectState")),r.prop("checked",r.data("selectState"))):(i.prop("disabled",!0),n(),s.prop("checked",!1),s.prop("disabled",!0),o.prop("checked",!1),o.prop("disabled",!0),l.prop("checked",!1),l.prop("disabled",!0),r.prop("checked",!1),r.prop("disabled",!0))};a.on("change",c),n(),c({target:a})}init(){super.init()}static getLowerSizeConnectionTypes(e){let s=[],o=a.getObjVal(t.wormholeSizes,e+".jumpMassMin")||0;if(o)for(let[e,a]of Object.entries(t.wormholeSizes))a.jumpMassMin<o&&s.push(e);return s}static formSystemSelectData(e){let t=[];for(let a=0;a<e.length;a++){let s=e[a];t.push({systemId:parseInt(s.id),name:s.text})}return t}};return r.isPlugin=!1,r.scope="system",r.sortArea="b",r.position=1,r.label="Routes",r.cacheConfig={routes:{ttl:5,maxSize:100}},r.defaultConfig={className:"pf-system-route-module",sortTargetAreas:["a","b","c"],headline:"Routes",routeDialogId:"pf-route-dialog",routeSettingsDialogId:"pf-route-settings-dialog",systemDialogSelectClass:"pf-system-dialog-select",routeDialogMapSelectId:"pf-route-dialog-map-select",routeDialogSizeSelectId:"pf-route-dialog-size-select",systemInfoRoutesTableClass:"pf-system-route-table",dataTableActionCellClass:"pf-table-action-cell",dataTableRouteCellClass:"pf-table-route-cell",dataTableJumpCellClass:"pf-table-jump-cell",systemSecurityClassPrefix:"pf-system-security-",rallyClass:"pf-rally"},r});
//# sourceMappingURL=system_route.js.map
