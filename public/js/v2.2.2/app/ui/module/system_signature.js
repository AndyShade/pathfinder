define(["jquery","app/init","app/util","module/base","bootbox","app/counter","app/map/map","app/map/util","app/ui/form_element"],(e,t,a,i,n,s,l,o,r)=>{"use strict";let d=class SystemSignatureModule extends i{constructor(e={}){super(Object.assign({},new.target.defaultConfig,e))}getTableMetaData(e){return e?e.init().pfMeta:null}getTableId(...e){return a.getTableId(this._config.sigTableId,...e)}getDataTableInstance(e,t,i){return a.getDataTableInstance(this._config.sigTableId,e,t,i)}updateTooltip(t,a){e(t).attr("title",a.toUpperCase()).tooltip("fixTitle").tooltip("setContent")}newProgressElement(e=0){let t=document.createElement("div");t.classList.add(this._config.moduleHeadlineProgressBarClass);let a=document.createElement("div");a.classList.add("progress","progress-micro");let i=document.createElement("div");return i.classList.add("progress-bar","progress-bar-success"),i.setAttribute("role","progressbar"),i.setAttribute("aria-valuenow",e.toString()),i.setAttribute("aria-valuemin","0"),i.setAttribute("aria-valuemax","100"),i.style.width=e+"px",i.style.willChange="width",a.append(i),t.append(a),t}newHeaderElement(e){let t=super.newHeaderElement(e),a=this.newProgressElement();t.append(a);let i=this.newHeadlineElement("0%");return i.classList.add("progress-label-right"),t.append(i),t}render(t,a){return this._systemData=a,this._bodyEl=Object.assign(document.createElement("div"),{className:this._config.bodyClassName}),this.moduleElement.append(this._bodyEl),e(this.moduleElement).showLoadingAnimation(),this.drawSignatureTableNew(),this.drawSignatureTable(),this.setModuleObserver(),this.moduleElement}drawSignatureTableInfo(t){let a=this,i=e(t).find("#"+a._config.sigInfoId),n=document.createElement("table");n.id=a.getTableId("info",a._systemData.mapId,a._systemData.id),n.classList.add("display","compact","nowrap",a._config.sigTableClass,a._config.sigTableInfoClass),i.append(n);let l={tabIndex:-1,dom:'<"flex-row flex-between"<"flex-col"l><"flex-col flex-grow '+a._config.tableToolbarStatusClass+'"><"flex-col"fS>><"flex-row"<"flex-col flex-grow"tr>><"flex-row flex-between"<"flex-col"i><"flex-col"p>>',initComplete:function(e,t){let i=this.api();a.initCharacterInfoTooltip(this,i),i.columns(["action:name"]).visible(!1),s.initTableCounter(this,["created:name","updated:name"])}},o=e(n).DataTable(e.extend(!0,l,a.getSignatureDataTableDefaults(a._systemData.mapId,a._systemData)));return o.on("draw.dt",function(i,n){e(t).find("."+a._config.sigTableInfoClass).find("td.editable").editable("disable")}),o}drawSignatureTableNew(){let t=this,a=document.createElement("div");a.classList.add(t._config.tableToolsActionClass);let i=document.createElement("table");i.id=t.getTableId("secondary",t._systemData.mapId,t._systemData.id),i.classList.add("compact","stripe","row-border","nowrap",t._config.sigTableClass,t._config.sigTableSecondaryClass),a.append(i),this._bodyEl.append(a);let n={paging:!1,info:!1,searching:!1,tabIndex:-1,data:[e.extend(!0,{},SystemSignatureModule.emptySignatureData)],initComplete:function(a,i){let n=this.api();e(this).on("keyup","td",{tableApi:n},function(e){t.keyNavigation(n,e)})}},s=e(i).DataTable(e.extend(!0,n,t.getSignatureDataTableDefaults(t._systemData.mapId,t._systemData)));new e.fn.dataTable.Responsive(s)}drawSignatureTable(){let i=this,l=document.createElement("table");l.id=i.getTableId("primary",i._systemData.mapId,i._systemData.id),l.classList.add("display","compact","nowrap",i._config.sigTableClass,i._config.sigTablePrimaryClass),this._bodyEl.append(l);let o={select:{style:"os",selector:"td:not(."+i._config.tableCellActionClass+")"},tabIndex:-1,dom:'<"flex-row flex-between"<"flex-col"l><"flex-col flex-grow"B><"flex-col"fS>><"flex-row"<"flex-col flex-grow"tr>><"flex-row flex-between"<"flex-col"i><"flex-col"p>>',buttons:{name:"tableTools",buttons:[{name:"filterGroup",tag:"a",className:i._config.moduleHeadlineIconClass,text:"",init:function(t,n,s){a.getLocalStore("character").getItem(a.getCurrentCharacterId()).then(s=>{let l=[{value:0,text:"unknown"}],o=i._config.signatureGroupsLabels,r=[];s&&s.filterSignatureGroups&&s.filterSignatureGroups.length?r=s.filterSignatureGroups:(r=o.map(e=>e.value)).unshift(0),n.editable({mode:"popup",type:"checklist",showbuttons:!1,onblur:"submit",highlight:!1,title:"filter groups",value:r,prepend:l,source:o,inputclass:i._config.editableUnknownInputClass,display:function(t,a){let i='<i class="fas fa-filter"></i>filter',n=t.length>=a.length;n||(i+="&nbsp;("+t.length+")"),e(this).toggleClass("active",!n).html(i)},validate:function(e){return{newValue:e.map(e=>parseInt(e)),msg:null}}});let d=l.concat(o);n.on("save",{tableApi:t,sourceOptions:d},(e,t)=>{a.getLocalStore("character").setItem(`${a.getCurrentCharacterId()}.filterSignatureGroups`,t.newValue),i.searchGroupColumn(e.data.tableApi,t.newValue,e.data.sourceOptions)}),i.searchGroupColumn(t,r,d)})}},{name:"undo",tag:"a",className:i._config.moduleHeadlineIconClass,text:"",init:function(a,n,s){let l=e=>{switch(e){case"add":return"fa-plus txt-color-green";case"delete":return"fa-times txt-color-redDark";case"edit":return"fa-pen txt-color-orangeDark";case"undo":return"fa-undo txt-color-grayLight";case"sync":return"fa-exchange-alt txt-color-orangeDark"}};n.on("shown",(e,t)=>{if(t.input.$input.length){t.input.$input.first().prop("disabled",!0),t.input.$input.attr("name","test").attr("type","radio"),t.input.$input.eq(1).prop("checked",!0);let e=t.container.$form.find("label");e.addClass("radio");for(let t of e.find("span")){t.style.display="inline-block",t.style.width="100%";let e=t.innerText.trim().split("%%");e[0]='<span style="display: inline-block; width: calc(65% - 38px); text-overflow: ellipsis; overflow: hidden">'+e[0]+"</span>",e[1]='<span style="display: inline-block; width: 15px; text-align: right"><i class="fas fa-fw txt-color '+l(e[1])+'"></i></span>',e[2]='<span style="display: inline-block; width: 23px; text-align: right" title="signature count"><kbd>'+e[2]+"</kbd></span>",e[3]='<span style="display: inline-block; width: 35%; text-align: right; font-size: 90%" class="txt-color txt-color-grayLight">'+e[3]+"</span>",t.innerHTML=e.join("")}e.initTooltips()}else t.options.error.call(t,["No record found"])});let o=null;n.editable({url:t.path.api+"/SignatureHistory",ajaxOptions:{processData:!1,type:"PUT",dataType:"json",contentType:"application/json",beforeSend:function(e,t){o=a.newProcess("lock")}},params:function(e){return JSON.stringify({systemId:e.pk,stamp:e.value[0]})},mode:"popup",type:"checklist",showbuttons:!0,highlight:!1,title:"historical records",name:"history",pk:i._systemData.id,source:t.path.api+"/SignatureHistory/"+i._systemData.id,sourceOptions:{type:"GET",data:{mapId:i._systemData.mapId}},sourceCache:!1,display:function(t){e(this).html('<i class="fas fa-undo"></i>undo')},success:(e,t)=>{a.endProcess(o),i.updateSignatureTable(a,e,!0)},error:function(e){let t=[];if(e&&e.responseText)if(e.responseJSON&&e.responseJSON.error)for(let a of e.responseJSON.error)t.push(a.message);else t.push(e.responseText);else if(e.length){t=e;let a=this.container.$form.addClass("has-error");a.find(".editable-buttons").hide(),a.find(".editable-input").hide(),a.find(".editable-error-block").html(t.join("<br>")).show()}return t.join(" | ")},validate:function(e){if(!Array.isArray(e)||1!==e.length)return{newValue:e,msg:"No record selected",field:this}}})}},{name:"selectAll",tag:"a",className:i._config.moduleHeadlineIconClass,text:'<i class="fas fa-check-double"></i>select all',action:function(e,t,a,i){let n=t.rows(),s=n.count(),l=t.rows({selected:!0}).count();l&&l>=s?(n.deselect(),a.removeClass("active")):(n.select(),a.addClass("active"))}},{extend:"selected",name:"delete",tag:"a",className:[i._config.moduleHeadlineIconClass,i._config.sigTableClearButtonClass].join(" "),text:'<i class="fas fa-trash"></i>delete&nbsp;(<span>0</span>)',init:function(t,a,i){e.fn.dataTable.ext.buttons.selected.init.call(this,t,a,i),t.on("select deselect",(e,t,i,n)=>{let s=t.rows().count(),l=t.rows({selected:!0}).count(),o=l>=s?"all":l;a.find("i+span").text(o)})},action:function(e,t,a,s){let l=t.rows({selected:!0});l.count()&&n.confirm("Delete "+l.count()+" signature?",e=>{e&&i.deleteSignatures(this,l)})}}]},initComplete:function(t,a){let n=this.api();i.initCharacterInfoTooltip(this,n),e(this).on("keyup","td",{tableApi:n},function(e){i.keyNavigation(n,e)}),s.initTableCounter(this,["created:name","updated:name"])}},r=e(l).DataTable(e.extend(!0,o,i.getSignatureDataTableDefaults(i._systemData.mapId,i._systemData)));new e.fn.dataTable.Responsive(r),r.select();new e.fn.dataTable.Buttons(r,{dom:{container:{tag:"h5",className:"pull-right"},button:{tag:"i",className:["fas","fa-fw",i._config.moduleHeadlineIconClass].join(" ")},buttonLiner:{tag:null}},name:"moduleTools",buttons:[{name:"add",className:["fa-plus",i._config.moduleHeadlineIconAddClass].join(" "),titleAttr:"add",attr:{"data-toggle":"tooltip","data-html":!0},action:function(e,t,a,n){i.toggleAddSignature("auto")}},{name:"reader",className:["fa-paste",i._config.moduleHeadlineIconReaderClass].join(" "),titleAttr:"signature reader",attr:{"data-toggle":"tooltip","data-html":!0},action:function(e,t,a,n){i.showSignatureReaderDialog(t)}},{name:"lazy",className:["fa-exchange-alt",i._config.moduleHeadlineIconLazyClass].join(" "),titleAttr:"lazy 'delete' signatures",attr:{"data-toggle":"tooltip","data-html":!0},action:function(t,a,i,n){e(i).toggleClass("active")}}]});r.buttons("moduleTools",null).container().appendTo(i.moduleElement.querySelector("."+i._config.headClassName)),e(i.moduleElement).data("lockPromise",r.newProcess("lock"))}getSignatureDataTableDefaults(i,n){let s=this,l=e=>(e.systemId=n.id,e);return{pfMeta:{mapId:i,systemId:n.id},order:[1,"asc"],rowId:e=>s._config.sigTableRowIdPrefix+e.id,language:{emptyTable:"No signatures added",info:"Showing _START_ to _END_ of _TOTAL_ signatures",infoEmpty:"Showing 0 to 0 of 0 signatures",infoFiltered:'(<i class="fas fa-fw fa-filter"></i> from _MAX_ total)',lengthMenu:"Show _MENU_",zeroRecords:"No signatures recorded"},columnDefs:[{targets:0,name:"status",orderable:!0,searchable:!1,title:"",width:2,class:["text-center"].join(" "),data:"updated",type:"html",render:{_:(e,t,i,n)=>{let s="";return e&&e.character&&(s=a.getStatusInfoForCharacter(e.character,"class")),"display"===t&&(s='<i class="fas fa-fw fa-circle pf-user-status '+s+'"></i>'),s}}},{targets:1,name:"id",orderable:!0,searchable:!0,title:"id",type:"string",width:12,class:[s._config.tableCellFocusClass,s._config.sigTableEditSigNameInput,s._config.fontUppercaseClass].join(" "),data:"name",createdCell:function(t,a,i,n,o){let r=this.api();s.updateTooltip(t,a),s.editableOnSave(r,t,[],["group:name","type:name","action:name"]),s.editableOnHidden(r,t),e(t).editable(e.extend({mode:"popup",type:"text",title:"signature id",name:"name",pk:i.id||null,emptytext:"? ? ?",value:a,inputclass:s._config.fontUppercaseClass,display:function(t){e(this).text([...e.trim(t)].slice(0,3).join("").toLowerCase())},validate:function(e){let t=!1;if(e.trimChars().match(/^[a-zA-Z]{3}-\d{3}$/)||(t="ID format invalid. E.g.: ABC-123"),t)return{newValue:e,msg:t,field:this}},params:l,success:function(a,i){if(r.cell(t).data(i),e(this).pulseBackgroundColor("changed"),s.updateTooltip(t,i),a){let e=a[0];s.updateSignatureCell(r,n,"status:name",e.updated),s.updateSignatureCell(r,n,"updated:name",e.updated.updated)}r.draw()}},SystemSignatureModule.editableDefaults))}},{targets:2,name:"group",orderable:!0,searchable:!0,title:"group",type:"string",width:40,class:[s._config.tableCellFocusClass].join(" "),data:"groupId",render:{sort:s.getGroupLabelById.bind(s),filter:s.getGroupLabelById.bind(s)},createdCell:function(t,a,i,n,o){let r=this.api();s.editableOnSave(r,t,["type:name"],["type:name","action:name"]),s.editableOnHidden(r,t),s.editableGroupOnShown(t),s.editableGroupOnSave(r,t),e(t).editable(e.extend({mode:"popup",type:"select",title:"group",name:"groupId",pk:i.id||null,emptytext:"unknown",onblur:"submit",showbuttons:!1,value:a,prepend:[{value:0,text:""}],params:l,source:s._config.signatureGroupsLabels,display:function(t,a){let i=e.fn.editableutils.itemsByValue(t,a);i.length&&i[0].value>0?e(this).html(i[0].text):e(this).empty()},validate:function(e){if(!Number.isInteger(e))return{newValue:parseInt(e)||0,msg:null}},success:function(a,i){if(r.cell(t).data(i),e(this).pulseBackgroundColor("changed"),a){let e=a[0];s.updateSignatureCell(r,n,"status:name",e.updated),s.updateSignatureCell(r,n,"updated:name",e.updated.updated)}r.draw();let l=s.getNeighboringCell(r,t,"type:name"),o=l.nodes().to$();s.editableSelectCheck(o),l.data(0),o.editable("setValue",0);let d=s.getNeighboringCell(r,t,"connection:name"),c=d.nodes().to$();5===i?s.editableEnable(c):(s.checkConnectionConflicts(),s.editableDisable(c)),d.data(0),c.editable("setValue",0)}},SystemSignatureModule.editableDefaults))}},{targets:3,name:"type",orderable:!1,searchable:!1,title:"type",type:"string",width:180,class:[s._config.tableCellFocusClass,s._config.tableCellTypeClass].join(" "),data:"typeId",createdCell:function(t,i,o,d,c){let u=this.api();s.editableOnSave(u,t,["connection:name"],["action:name"]),s.editableOnHidden(u,t),s.editableTypeOnInit(t),s.editableTypeOnShown(t),e(t).editable(e.extend({mode:"popup",type:"select",title:"type",name:"typeId",pk:o.id||null,emptytext:"unknown",onblur:"submit",showbuttons:!1,disabled:o.groupId<=0,value:i,prepend:[{value:0,text:""}],params:l,source:function(){let i=u.row(e(t).parents("tr")).data();return SystemSignatureModule.getSignatureTypeOptions(n.type.id,a.getAreaIdBySecurity(n.security),i.groupId,n)},display:function(t,a){let i=e.fn.editableutils.itemsByValue(t,a);i.length&&i[0].value>0?e(this).html(r.formatSignatureTypeSelectionData({text:i[0].text},void 0,{showWhSizeLabel:!0})):e(this).empty()},validate:function(e){if(!Number.isInteger(e))return{newValue:parseInt(e)||0,msg:null}},success:function(a,i){if(u.cell(t).data(i),e(this).pulseBackgroundColor("changed"),a){let e=a[0];s.updateSignatureCell(u,d,"status:name",e.updated),s.updateSignatureCell(u,d,"updated:name",e.updated.updated)}u.draw()}},SystemSignatureModule.editableDefaults))}},{targets:4,name:"description",orderable:!1,searchable:!0,title:"description",class:[s._config.tableCellFocusClass,s._config.tableCellActionClass].join(" "),type:"html",data:"description",defaultContent:"",createdCell:function(t,a,i,n,o){let r=this.api();s.editableOnSave(r,t,[],["action:name"]),s.editableOnHidden(r,t),s.editableDescriptionOnShown(t),s.editableDescriptionOnHidden(t),e(t).editable(e.extend({mode:"inline",type:"textarea",title:"description",name:"description",pk:i.id||null,emptytext:'<i class="fas fa-fw fa-lg fa-pen"></i>',onblur:"submit",showbuttons:!1,inputclass:s._config.editableDescriptionInputClass,emptyclass:s._config.moduleHeadlineIconClass,params:l,success:function(a,i){if(r.cell(t).data(i),e(this).pulseBackgroundColor("changed"),a){let e=a[0];s.updateSignatureCell(r,n,"status:name",e.updated),s.updateSignatureCell(r,n,"updated:name",e.updated.updated)}r.draw()}},SystemSignatureModule.editableDefaults))}},{targets:5,name:"connection",orderable:!1,searchable:!1,title:"leads to",type:"string",className:[s._config.tableCellFocusClass,s._config.tableCellConnectionClass].join(" "),width:80,data:"connection.id",defaultContent:0,createdCell:function(t,i,o,d,c){let u=this.api();s.editableOnSave(u,t,[],["action:name"]),s.editableOnHidden(u,t),s.editableConnectionOnInit(t),s.editableConnectionOnShown(u,t),s.editableConnectionOnSave(t),e(t).editable(e.extend({mode:"popup",type:"select",title:"system",name:"connectionId",pk:o.id||null,emptytext:"unknown",onblur:"submit",showbuttons:!1,disabled:5!==o.groupId,value:i,prepend:[{value:0,text:""}],params:l,source:function(){let e=a.getMapModule().getActiveMap().data("id");return SystemSignatureModule.getSignatureConnectionOptions(e,n)},display:function(t,a){let i=e.fn.editableutils.itemsByValue(t,a);if(i.length&&i[0].value>0){let t='<i class="fas fa-exclamation-triangle txt-color txt-color-danger hide"></i>&nbsp;';e(this).html(r.formatSignatureConnectionSelectionData({text:i[0].text,metaData:i[0].metaData})).prepend(t)}else e(this).empty()},validate:function(e){if(!Number.isInteger(e))return{newValue:parseInt(e)||0,msg:null}},success:function(a,i){if(u.cell(t).data(i),e(this).pulseBackgroundColor("changed"),a){let e=a[0];s.updateSignatureCell(u,d,"status:name",e.updated),s.updateSignatureCell(u,d,"updated:name",e.updated.updated)}u.draw()}},SystemSignatureModule.editableDefaults))}},{targets:6,name:"created",title:"created",searchable:!1,width:80,className:["text-right",s._config.tableCellCounterClass,"min-screen-d"].join(" "),data:"created.created",defaultContent:""},{targets:7,name:"updated",title:"updated",searchable:!1,width:80,className:["text-right",s._config.tableCellCounterClass,"min-screen-d"].join(" "),data:"updated.updated",defaultContent:""},{targets:8,name:"info",title:"",orderable:!1,searchable:!1,width:10,class:["text-center",a.config.helpClass,a.config.popoverTriggerClass].join(" "),data:"created.created",defaultContent:"",render:{display:(e,t,a,i)=>{if(e)return'<i class="fas fa-question-circle"></i>'}}},{targets:9,name:"action",title:"",orderable:!1,searchable:!1,width:10,class:["text-center",s._config.tableCellFocusClass,s._config.tableCellActionClass].join(" "),data:null,render:{display:(e,t,a,i)=>{let n='<i class="fas fa-plus"></i>';return a.id&&(n='<i class="fas fa-times txt-color txt-color-redDark"></i>'),n}},createdCell:function(i,n,l,o,r){let d=this.api();if(l.id){let t={title:"---",template:a.getConfirmationTemplate(a.getConfirmationContent([{name:"deleteConnection",value:"1",label:"delete connection",class:"pf-editable-warn",checked:!0}]),{size:"small",noTitle:!0}),onConfirm:function(t,i){t.preventDefault();let n=i.data("bs.confirmation").tip().find("form:not(.hidden)").first().getFormValues(),l=a.getObjVal(n,"deleteConnection")?n:{};if(l.deleteConnection){let t=d.cell(o,"connection:name").data();if(t){let a=s.getTableMetaData(d),i=e().getConnectionById(a.mapId,t);i&&i.addType("state_process")}}let r=e(i).parents("tr"),c=d.rows(r);s.deleteSignatures(d,c,l)},onShow:function(e,t){let a=t.data("bs.confirmation").tip().find("form").first(),i=d.cell(o,"connection:name").data();a.toggleClass("hidden",!i)}};e(i).confirmation(t)}else e(i).on("click",{tableApi:d,rowIndex:o},function(i){i.stopPropagation(),i.preventDefault();let n=i.data.tableApi,l=s.getTableMetaData(n),o=s.getDataTableInstance(l.mapId,l.systemId,"primary"),r=n.row(i.data.rowIndex).nodes().to$().find(".editable");r.editable("hide");let d=null,c=null;r.editable("submit",{url:t.path.api+"/Signature",ajaxOptions:{processData:!1,type:"PUT",dataType:"json",contentType:"application/json",beforeSend:function(e,t){t.data=JSON.stringify(t.data),d=o.newProcess("lock"),c=o.newProcess("request")},context:{primaryTableApi:o,secondaryTableApi:n}},data:{systemId:l.systemId},error:SystemSignatureModule.editableDefaults.error,success:function(t,i){let n=i.ajaxOptions.context,l=n.primaryTableApi,o=n.secondaryTableApi,r=t[0],u=s.addSignatureRow(l,r);u&&(l.draw(),u.nodes().to$().pulseBackgroundColor("added"),o.clear().row.add(e.extend(!0,{},SystemSignatureModule.emptySignatureData)).draw(),a.showNotify({title:"Signature added",text:"Name: "+r.name,type:"success"}),s.updateScannedSignaturesBar(l,{showNotice:!0})),l.endProcess(d),l.endProcess(c)}})})}}],createdRow:function(t,a,i){e(t).find("."+s._config.tableCellFocusClass+":not(.editable-disabled)").attr("tabindex",0).on("keydown",function(t){t.stopPropagation(),13===t.which&&e(this).trigger("click")})},rowCallback:function(){let t=this.api(),a=Math.floor((new Date).getTime());t.cells(null,["updated:name"]).every(function(t,i,n,s){let l=this.node(),o=this.data(),r=a-1e3*o;e(l).toggleClass("txt-color txt-color-warning",r>864e5)})}}}toggleAddSignature(t="auto"){let a=e(this.moduleElement).find("."+this._config.moduleHeadlineIconAddClass),i=e(this.moduleElement).find("."+this._config.tableToolsActionClass);a.toggleClass("active","auto"===t?void 0:t),!i.is(":visible")||t&&"auto"!==t?i.is(":visible")||!t&&"auto"!==t?i.is(":visible")&&t&&this.focusNewSignatureEditableField():i.velocity("stop").velocity({opacity:[1,0],height:["70px",0]},{duration:150,display:"block",complete:()=>{this.focusNewSignatureEditableField()}}):i.velocity("stop").velocity({opacity:[0,1],height:[0,"70px"]},{duration:150,display:"none"})}searchGroupColumn(t,a,i){let n=t.column("group:name"),s="";if(a.length<=i.length){s=e.fn.editableutils.itemsByValue(a,i).map(t=>0!==t.value?e.fn.dataTable.util.escapeRegex(t.text):"^$").join("|")}n.search(s,!0,!1).draw()}initCharacterInfoTooltip(t,i){t.hoverIntent({over:function(t){let a=e(this),n=i.row(a.parents("tr")).data();a.addCharacterInfoTooltip(n,{trigger:"manual",placement:"top",show:!0})},out:function(t){e(this).destroyPopover()},selector:"td."+a.config.helpClass})}enrichParsedSignatureData(e){let t=a.getCurrentCharacter(),i=Math.floor((new Date).getTime()/1e3);for(let a=0;a<e.length;a++)e[a].created={created:i,character:t},e[a].updated={updated:i,character:t};return e}parseSignatureString(t){let i=[];if(t.length){let n=t.split(/\r\n|\r|\n/g),s=this._config.signatureGroupsNames,l=0;for(let t=0;t<n.length;t++){let o=n[t].split(/\t|\s{4}/g);if(6===o.length)if(-1!==SystemSignatureModule.validSignatureNames.indexOf(o[1])){let t=e.trim(o[2]).toLowerCase(),n=e.trim(o[3]),l=0,r=0;for(let e of s){if(new RegExp(e.text,"i").test(t)){l=e.value;break}}if(5!==l){let e=n.toLowerCase(),t=SystemSignatureModule.getSignatureTypeOptions(this._systemData.type.id,a.getAreaIdBySecurity(this._systemData.security),l,this._systemData);for(let[i,n]of Object.entries(a.flattenXEditableSelectArray(t)))if(n.toLowerCase()===e){r=parseInt(i);break}n=0===r?n:""}else n="";let d={systemId:this._systemData.id,name:e.trim(o[0]).toLowerCase(),groupId:l,typeId:r,description:n};i.push(d)}else l++}if(l>0){let e=l+" / "+n.length+" signatures invalid";a.showNotify({title:"Invalid signature(s)",text:e,type:"warning"})}}return i}updateSignatureTableByClipboard(e,t,i){if(e.hasProcesses("request"))return void console.info("Update signature table By clipboard locked.");let s=t=>{let n=e.newProcess("lock"),s=e.newProcess("request");a.request("POST","Signature",[],{signatures:t,deleteOld:i.deleteOld||0,deleteConnection:i.deleteConnection||0,systemId:parseInt(this._systemData.id)},{tableApi:e,processLockPromise:n,processRequestPromise:s},e=>{e.tableApi.endProcess(e.processLockPromise),e.tableApi.endProcess(e.processRequestPromise)}).then(e=>{this.updateSignatureTable(e.context.tableApi,e.data,!!i.deleteOld)},a.handleAjaxErrorResponse)},l=this.parseSignatureString(t);if(l.length>0){let e=a.getCurrentLocationData();if(e.id&&e.id!==this._systemData.systemId){let t=this._systemData.name===this._systemData.alias?'"'+this._systemData.name+'"':'"'+this._systemData.alias+'" ('+this._systemData.name+")",a="Update signatures in "+(t='<span class="txt-color txt-color-warning">'+t+"</span>")+' ? This is not your current location, "'+e.name+'" !';n.confirm(a,e=>{e&&s(l)})}else s(l)}}deleteSignatures(e,t,i={}){let n=this,s=[...new Set(t.data().toArray().map(e=>e.id))],l=n.getTableMetaData(e),o=Object.assign(i,{systemId:l.systemId}),r=e.newProcess("request");a.request("DELETE","Signature",s,o,{tableApi:e,processRequestPromise:r},e=>{e.tableApi.endProcess(e.processRequestPromise)}).then(e=>{let t=e.context.tableApi,a=[];t.rows((t,a,i)=>e.data.includes(a.id)).every(function(e,t,i){let s=this.nodes().to$();s.pulseBackgroundColor("deleted"),a.push(n.toggleTableRow(s))}),Promise.all(a).then(e=>{t.rows(e.map(e=>e.row)).remove().draw(),n.updateScannedSignaturesBar(t,{showNotice:!1}),n.checkConnectionConflicts();let a={type:"success"};1===e.length?a.title="Signature deleted":a.title=e.length+" Signatures deleted ",n.showNotify(a)})},a.handleAjaxErrorResponse)}updateSignatureCell(e,t,a,i){e.cell(t,a).data(i)}checkConnectionConflicts(){setTimeout(()=>{let t=[this._config.sigTablePrimaryClass,this._config.sigTableSecondaryClass].map(e=>"."+e+" ."+this._config.tableCellConnectionClass+".editable").join(", "),a=e(t),i=[],n=[],s=[];a.each(function(){let t=e(this),a=parseInt(t.editable("getValue",!0))||0;i.indexOf(a)>-1&&-1===n.indexOf(a)&&n.push(a),void 0!==s[a]?s[a].push(t[0]):s[a]=[t[0]],i.push(a)}),a.each(function(){let t=e(this),a=parseInt(t.editable("getValue",!0))||0,i=t.find(".fa-exclamation-triangle");n.indexOf(a)>-1&&s[a].indexOf(t[0])>-1?i.removeClass("hide"):i.addClass("hide")})},200)}getGroupLabelById(e){let t=this._config.signatureGroupsLabels.filter(t=>t.value===e);return t.length?t[0].text:""}getNeighboringCell(e,t,a){return e.cell(e.cell(t).index().row,a)}searchNextCell(e,t,a){if(!a.length)return e.cell(t);{a=a.slice(0);let i=this.getNeighboringCell(e,t,a.shift()),n=i.nodes().to$();if(n.data("editable")){let s=n.editable("getValue",!0);return[0,null].includes(s)&&!n.data("editable").options.disabled?i:this.searchNextCell(e,t,a)}if(i.index().column===e.column(-1).index())return i;console.error("No cell found for activation!")}}activateCell(e){let t=e.nodes().to$();t.is(":visible")&&(t.focus(),t.data("editable")&&t.editable("show"))}activateNextCell(e,t,a){let i=this.searchNextCell(e,t,a);this.activateCell(i)}editableOnSave(t,a,i=[],n=[]){e(a).on("save",(e,s)=>{s.response?this.activateNextCell(t,a,i):this.activateNextCell(t,a,n)})}editableOnHidden(t,a){e(a).on("hidden",function(e,t){"save"!==t&&this.focus()})}editableGroupOnShown(t){e(t).on("shown",(e,t)=>{t.input.$input.addClass("pf-select2").initSignatureGroupSelect()})}editableGroupOnSave(t,a){e(a).on("save",(e,a)=>{a.response&&this.updateScannedSignaturesBar(t,{showNotice:!0})})}editableTypeOnInit(t){e(t).on("init",(t,a)=>{a.options.source().length||this.editableDisable(e(t.target))})}editableTypeOnShown(t){e(t).on("shown",(t,a)=>{e(t.target).destroyPopover(!0);let i=a.input.$input,n=i.has("optgroup").length>0;i.addClass("pf-select2").initSignatureTypeSelect({},n)})}editableDescriptionOnShown(t){e(t).on("shown",(t,a)=>{e(t.target).parents("."+this._config.tableToolsActionClass).css("height","+=35px")})}editableDescriptionOnHidden(t){e(t).on("hidden",(a,i)=>{e(t).parents("."+this._config.tableToolsActionClass).css("height","-=35px")})}editableConnectionOnInit(t){e(t).on("init",(e,t)=>{t.value>0&&this.checkConnectionConflicts()})}editableConnectionOnShown(t,i){e(i).on("shown",(i,n)=>{let s=n.input.$input;if(!e(t.table().node()).hasClass(this._config.sigTablePrimaryClass)){let e=this.getTableMetaData(t);t=this.getDataTableInstance(e.mapId,e.systemId,"primary")}let l=a.convertXEditableOptionsToSelect2(n),o=t.column("connection:name").data().toArray();if((o=o.filter(e=>e>0)).length){let e=[],t=[];for(let a of l)if(Array.isArray(a.children)){let i=[];for(let e of a.children)!e.selected&&o.includes(e.id)?(e.disabled=!0,t.push(e)):i.push(e);i.length&&e.push({text:a.text,children:i})}else e.push(a);t.length&&e.push({text:"linked",children:t}),l=e}let r={data:l};s.addClass("pf-select2").initSignatureConnectionSelect(r)})}editableConnectionOnSave(t){e(t).on("save",(e,t)=>{this.checkConnectionConflicts()})}editableEnable(e){e.editable("enable"),e.attr("tabindex",0)}editableDisable(e){e.editable("disable")}editableSelectCheck(e){if(e.data("editable")){e.data("editable").options.source().length>0?this.editableEnable(e):this.editableDisable(e)}}focusNewSignatureEditableField(){e(this.moduleElement).find("."+this._config.sigTableSecondaryClass).find("td."+this._config.sigTableEditSigNameInput).editable("show")}setModuleObserver(){e(this.moduleElement).on("pf:showSystemSignatureModuleAddNew",e=>{this.toggleAddSignature(!0)}),e(this.moduleElement).on("pf:updateSystemSignatureModuleByClipboard",(t,a)=>{let i={deleteOld:this.getLazyUpdateToggleStatus(),deleteConnection:0};e(this.getLazyUpdateToggleElement()).toggleClass("active",!1),this.updateSignatureTableByClipboard(this.getDataTableInstance(this._systemData.mapId,this._systemData.id,"primary"),a,i)}),o.initWormholeInfoTooltip(e(this.moduleElement).find("."+this._config.sigTableClass),'.editable-click:not(.editable-open) span[class^="pf-system-sec-"]'),e(this.moduleElement).initTooltips()}keyNavigation(e,t){let a;if(37===t.keyCode?a=[-1,0]:38===t.keyCode?a=[0,-1]:39===t.keyCode?a=[1,0]:40===t.keyCode&&(a=[0,1]),Array.isArray(a)){let i=(e,t)=>(t[0]<0&&(t[0]=e.column(":last").nodes().to$().index()),t[0]>e.column(":last").nodes().to$().index()&&(t[0]=0),t[1]<0&&(t[1]=e.row(":last",{search:"applied"}).nodes().to$().index()),t[1]>e.row(":last",{search:"applied"}).nodes().to$().index()&&(t[1]=0),t),n=(e,t,a)=>{let s=t.nodes(),l=[s.to$().index(),s.to$().closest("tr").index()].map((e,t)=>e+a[t]);l=i(e,l);let o=e.cell(":eq("+l[1]+")",":eq("+l[0]+")",{search:"applied"}),r=o.node();return(!r.hasAttribute("tabindex")||parseInt(r.getAttribute("tabindex"))<0)&&(o=n(e,o,a)),o};n(e,e.cell(t.target),a).node().focus()}}toggleTableRow(t){return new Promise((a,i)=>{let n=t.children("td");t.is(":visible")?n.addClass(s.config.counterStopClass).velocity({paddingTop:[0,"4px"],paddingBottom:[0,"4px"],opacity:[0,1]},{duration:350,easing:"linear"}).wrapInner("<div>").children().css({willChange:"height"}).velocity("slideUp",{duration:350,easing:"linear",complete:function(i){e(i).children().unwrap(),a({action:"rowHidden",row:t})}}):(n.css({"padding-top":0,"padding-bottom":0,willChange:"padding-top, padding-top, height"}),n.wrapInner(e("<div>").hide()),t.show(),n.velocity({paddingTop:["4px",0],paddingBottom:["4px",0]},{duration:350,queue:!1,complete:function(){n.children().css({willChange:"height"}).velocity("slideDown",{duration:350,complete:function(i){for(let t=0;t<i.length;t++){let a=e(i[t]);a.children().length>0?a.children().unwrap():a.parent().html(a.html())}a({action:"rowShown",row:t})}})}}))})}updateScannedSignaturesBar(t,a){let i=t.table().node(),n=e(i).parents("."+this._config.className+", ."+this._config.sigReaderDialogClass),s=n.find(".progress-bar"),l=n.find(".progress-label-right"),o=0,r="",d=t.column("group:name").data(),c=d.length,u=d.filter((e,t)=>!e).length;if(c&&(o=100-Math.round(100/c*u)),r=o<30?"progress-bar-danger":o<100?"progress-bar-warning":"progress-bar-success",l.text(o+"%"),s.removeClass().addClass("progress-bar").addClass(r),s.attr("aria-valuenow",o),s.css({width:o+"%"}),!1!==a.showNotice){let e=c-u+" / "+c+" ("+o+"%) signatures scanned";o<100?this.showNotify({title:"Unscanned signatures",text:e,type:"info"}):this.showNotify({title:"System is scanned",text:e,type:"success"})}}initTableDataWithCurrentSignatureData(e,t=!1){e.clear();let a=this.getDataTableInstance(this._systemData.mapId,this._systemData.id,"primary");a?(e.rows.add(a.data().toArray()),t&&e.draw()):console.warn("Signature table not found. mapId: %d; systemId: %d",this._systemData.mapId,this._systemData.id)}setSignatureReaderDialogObserver(t){let a=(t=e(t)).find("form").first(),i=a.find("#"+this._config.sigInfoTextareaId),n=a.find("#"+this._config.sigReaderLazyUpdateId),s=a.find("#"+this._config.sigReaderConnectionDeleteId),l=t.find("."+this._config.tableToolbarStatusClass);a.initFormValidation({delay:0,feedback:{success:"fa-check",error:"fa-times"},custom:{clipboard:e=>{let t=this.parseSignatureString(e.val());if(l.text(t.length+" signatures parsed"),0===t.length)return"No signatures found in scan result"}}});let o=e=>{let t=this.getDataTableInstance(this._systemData.mapId,this._systemData.id,"info");if(t){this.initTableDataWithCurrentSignatureData(t);let a=this.parseSignatureString(e.clipboard);a.length>0?(a=this.enrichParsedSignatureData(a),this.updateSignatureInfoTable(t,a,Boolean(e.deleteOld),Boolean(e.deleteConnection))):(t.draw(),this.updateSignatureReaderCounters(SystemSignatureModule.emptySignatureReaderCounterData),this.updateScannedSignaturesBar(t,{showNotice:!1}),console.info("No signatures found in scan result"))}else console.warn('Signature "preview" table not found. mapId: %d; systemId: %d',this._systemData.mapId,this._systemData.id)},r="";i.on("change keyup paste",()=>{let e=a.getFormValues(),t=e.clipboard;t!==r&&(r=t,o(e))}),i.on("focus",function(e){this.select()});let d=function(){s.prop("disabled",!this.checked),s.prop("checked",!1)}.bind(n[0]);n.on("change",d),d(),n.add(s).on("change",()=>{a.getFormValues().clipboard.length&&o(a.getFormValues())}),t.on("pf:updateSignatureReaderDialog",()=>{o(a.getFormValues())})}showSignatureReaderDialog(t){requirejs(["text!templates/dialog/signature_reader.html","mustache"],(a,i)=>{let s={sigInfoId:this._config.sigInfoId,sigReaderLazyUpdateId:this._config.sigReaderLazyUpdateId,sigReaderConnectionDeleteId:this._config.sigReaderConnectionDeleteId,sigInfoTextareaId:this._config.sigInfoTextareaId,sigInfoLazyUpdateStatus:this.getLazyUpdateToggleStatus(),sigInfoCountSigNewId:this._config.sigInfoCountSigNewId,sigInfoCountSigChangeId:this._config.sigInfoCountSigChangeId,sigInfoCountSigDeleteId:this._config.sigInfoCountSigDeleteId,sigInfoCountConDeleteId:this._config.sigInfoCountConDeleteId,sigInfoProgressElement:this.newProgressElement().outerHTML},l=n.dialog({className:this._config.sigReaderDialogClass,title:"Signature reader",size:"large",message:i.render(a,s),show:!1,buttons:{close:{label:"cancel",className:"btn-default"},success:{label:'<i class="fas fa-paste fa-fw"></i>&nbsp;update signatures',className:"btn-success",callback:a=>{let i=e(a.delegateTarget).find("form");if(i.validator("validate"),!i.isValidForm())return!1;{let e=i.getFormValues(),a={deleteOld:e.deleteOld?1:0,deleteConnection:e.deleteConnection?1:0};this.updateSignatureTableByClipboard(t,e.clipboard,a)}}}}});l.on("show.bs.modal",e=>{let t=this.drawSignatureTableInfo(e.target);this.initTableDataWithCurrentSignatureData(t,!0),this.updateScannedSignaturesBar(t,{showNotice:!1}),this.setSignatureReaderDialogObserver(e.target)}),l.on("shown.bs.modal",e=>{l.initTooltips(),l.find("textarea").focus()}),l.modal("show")})}getLazyUpdateToggleElement(){return this.moduleElement.querySelector("."+this._config.moduleHeadlineIconLazyClass)}getLazyUpdateToggleStatus(){return this.getLazyUpdateToggleElement().classList.contains("active")?1:0}updateSignatureReaderCounters(t){let a=e("#"+this._config.sigInfoCountSigNewId).text(t.added||0);a.toggleClass(a.attr("data-class"),Boolean(t.added)),(a=e("#"+this._config.sigInfoCountSigChangeId).text(t.changed||0)).toggleClass(a.attr("data-class"),Boolean(t.changed)),(a=e("#"+this._config.sigInfoCountSigDeleteId).text(t.deleted||0)).toggleClass(a.attr("data-class"),Boolean(t.deleted)),(a=e("#"+this._config.sigInfoCountConDeleteId).text(t.deleteCon||0)).toggleClass(a.attr("data-class"),Boolean(t.deleteCon))}addSignatureRow(e,t){return e?e.row.add(t):null}getPromiseForRow(e,t){return new Promise(a=>{a({action:e,rowId:t})})}rowUpdate(e,t,i,n,s){let l=a.getObjVal(s,"cell"),o=l.nodes().to$();if(o.data("editable")){let t=o.editable("getValue",!0);switch(o.data("editable").options.name){case"typeId":this.editableSelectCheck(o);break;case"connectionId":5===l.cell(e,"group:name").data()?this.editableEnable(o):this.editableDisable(o)}o.editable("setValue",l.data()),t!==l.data()&&o.pulseBackgroundColor("changed",a.getObjVal(s,"keepVisible")||!1)}else o.hasClass(this._config.tableCellCounterClass)&&o.pulseBackgroundColor("changed",a.getObjVal(s,"keepVisible")||!1)}updateSignatureInfoTable(t,i,n=!1,s=!1){let l=this,o=e.extend([],i),r=[],d=[],c=[],u=function(){l.rowUpdate(...arguments,{cell:this,keepVisible:!0})};if(t.rows().every(function(e,t,a){let i=this,n=i.data();for(let t=0;t<o.length;t++)if(o[t].name===n.name){let a=i.id(!0);if(o[t].updated.updated>n.updated.updated){let e=o[t];e.description=n.description,e.groupId?e.groupId===n.groupId&&(e.typeId||(e.typeId=n.typeId)):(e.groupId=n.groupId,e.typeId=n.typeId),e.created=n.created,i.data(e),i.cells(i.id(!0),["id:name","group:name","type:name","description:name","connection:name","updated:name"]).every(u),c.push(l.getPromiseForRow("changed",a))}r.push(e),o.splice(t,1),t--}}),n){t.rows((e,t,a)=>!r.includes(e)).every(function(e,t,i){let n=this.id(!0),o=this.nodes().to$(),r=this.data();o.pulseBackgroundColor("deleted",!0),c.push(l.getPromiseForRow("deleted",n)),s&&a.getObjVal(r,"connection.id")&&c.push(l.getPromiseForRow("deleteCon",n))})}for(let e of o){let a=l.addSignatureRow(t,e);a.nodes().to$().pulseBackgroundColor("added",!0),d.push(l.getPromiseForRow("added",a.index()))}Promise.all(d.concat(c,[])).then(e=>{if(e.length){t.draw();let a=e.reduce((e,t)=>(e[t.action]++,e),Object.assign({},SystemSignatureModule.emptySignatureReaderCounterData));l.updateSignatureReaderCounters(a),l.updateScannedSignaturesBar(t,{showNotice:!1})}})}updateSignatureTable(t,i,n=!1){let s=this;if(t.hasProcesses("lock"))return void console.info("Signature table locked. Skip table update");let l=t.newProcess("lock"),o=e.extend([],i),r=[],d=[],c=[],u=[],g=t.rows(),p=!g.any(),f=function(){s.rowUpdate(...arguments,{cell:this})};if(g.every(function(e,t,a){let i=this,n=i.data();for(let e=0;e<o.length;e++)if(o[e].id===n.id){let t=i.id(!0);o[e].updated.updated>n.updated.updated&&(i.data(o[e]),i.cells(i.id(!0),["id:name","group:name","type:name","description:name","connection:name","updated:name"]).every(f),c.push(s.getPromiseForRow("changed",t))),r.push(t),o.splice(e,1),e--}}),n){t.rows((e,t,a)=>!r.includes("#"+s._config.sigTableRowIdPrefix+t.id)).every(function(e,t,a){let i=this.id(!0),n=this.nodes().to$();n.find(".editable").editable("destroy"),n.destroyPopover(!0),n.pulseBackgroundColor("deleted"),u.push(new Promise((e,t)=>{s.toggleTableRow(n).then(t=>e({action:"deleted",rowIdx:i}))}))}).remove()}for(let e of o){let a=s.addSignatureRow(t,e),i=a.id(!0);a.nodes().to$().pulseBackgroundColor("added"),d.push(s.getPromiseForRow("added",i))}Promise.all(d.concat(c,u)).then(i=>{if(i.length){if(t.draw(),s.checkConnectionConflicts(),!p){let e=i.reduce((e,t)=>(e[t.action]||(e[t.action]=0),e[t.action]++,e),Object.assign({},SystemSignatureModule.emptySignatureReaderCounterData)),t=Object.keys(e).reduce((t,a)=>`${t}${e[a]?`${e[a]} ${a}<br>`:""}`,"");t.length&&a.showNotify({title:"Signatures updated",text:t,type:"success",textTrusted:!0})}s.updateScannedSignaturesBar(t,{showNotice:!0}),e("."+s._config.sigReaderDialogClass+".in").trigger("pf:updateSignatureReaderDialog")}t.endProcess(l)})}updateSignatureHistory(t,a){let i=t.table().node();e(i).data("history",a)}update(t){return super.update(t).then(t=>new Promise(i=>{if(a.getObjVal(t,"id")===this._systemData.id&&a.getObjVal(t,"mapId")===this._systemData.mapId&&a.getObjVal(t,"signatures")&&a.getObjVal(t,"sigHistory")){let e=this.getDataTableInstance(t.mapId,t.id,"primary");this.updateSignatureTable(e,t.signatures,!0),this.updateSignatureHistory(e,t.sigHistory)}e(this.moduleElement).hideLoadingAnimation(),i({action:"update",data:{module:this}})}))}init(){super.init(),this.getDataTableInstance(this._systemData.mapId,this._systemData.id,"primary").endProcess(e(this.moduleElement).data("lockPromise"))}beforeHide(){super.beforeHide(),this.getDataTableInstance(this._systemData.mapId,this._systemData.id,"primary").newProcess("lock")}static getSignatureTypeOptionsBySystem(e,t){let i=e.data("typeId"),n=a.getAreaIdBySecurity(e.data("security")),s={statics:e.data("statics")};return SystemSignatureModule.getSignatureTypeOptions(i,n,t,s)}static getSignatureConnectionOptions(e,t){let a=l.getMapInstance(e),i=o.getSystemId(e,t.id),n=o.searchConnectionsBySystems(a,[i],"wh"),s=[],r=[],d=(e,t,a)=>{let i="UNKNOWN";return"source"===e?i=t.sourceAlias+" - "+o.getSystemSecurityForDisplay(a.security).toLowerCase()+a.tag:"target"===e&&(i=t.targetAlias+" - "+o.getSystemSecurityForDisplay(a.security).toLowerCase()+a.tag),{value:t.id,text:i,metaData:{type:t.type}}};for(let a of n){let i=o.getDataByConnection(a);if(i.id)if(t.id!==i.target){let t=o.getSystemData(e,i.target);t&&r.push(d("target",i,t))}else if(t.id!==i.source){let t=o.getSystemData(e,i.source);t&&r.push(d("source",i,t))}}return r.length>0&&s.push({text:"System",children:r}),s}static getSignatureTypeOptions(e,i,n,{statics:s=null,shattered:l=!1}={}){e=parseInt(e||0),i=parseInt(i||0),n=parseInt(n||0);let o=0;if(!e||!i||!n)return[];let r=SystemSignatureModule.getAreaIdsForSignatureTypeOptions(e,i,n,l),d=[e,...r,n].join("_"),c=SystemSignatureModule.getCache("sigTypeOptions").get(d);if(Array.isArray(c))c=c.slice(0),o=SystemSignatureModule.getOptionsCount("children",c);else{c=[];let s=a.getSignatureTypeNames(e,r,n);if(s){let e=[];for(let t in s)t>0&&s.hasOwnProperty(t)&&(o++,e.push({value:o,text:s[t]}));o>0&&(5===n?c.push({text:"Wandering",children:e}):c=e)}if(5===n){let e=SystemSignatureModule.getFrigateHolesBySystem(i),a=[];for(let t in e)t>0&&e.hasOwnProperty(t)&&(o++,a.push({value:o,text:e[t]}));if(a.length>0&&c.push({text:"Frigate",children:a}),[30,31,32].includes(i)){let e=[];for(let a in t.drifterWormholes)a>0&&t.drifterWormholes.hasOwnProperty(a)&&(o++,e.push({value:o,text:t.drifterWormholes[a]}));e.length>0&&c.push({text:"Drifter",children:e})}let n=[];for(let e in t.incomingWormholes)e>0&&t.incomingWormholes.hasOwnProperty(e)&&(o++,n.push({value:o,text:t.incomingWormholes[e]}));n.length>0&&c.push({text:"Incoming",children:n})}else c=c.sortBy("text");SystemSignatureModule.getCache("sigTypeOptions").set(d,c.slice(0))}if(5===n&&s){let e=[],a=e=>t=>t.text!==e;for(let i of s){let n=Object.assign({},t.wormholes[i]),s=n.name+" - "+n.security;SystemSignatureModule.filterGroupedOptions(c,a(s)),o++,e.push({value:o,text:s})}e.length>0&&c.unshift({text:"Static",children:e})}return c}static filterGroupedOptions(e,t=(()=>!0),a="children"){for(let[i,n]of Object.entries(e))"object"==typeof n&&n.hasOwnProperty(a)&&n[a].not(t).length&&(e[i]=Object.assign({},e[i],{[a]:n[a].filter(t)}))}static getFrigateHolesBySystem(e){let a={};return t.frigateWormholes[e]&&(a=t.frigateWormholes[e]),a}static getOptionsCount(e,t){let a=0;for(let i of t)i.hasOwnProperty(e)?a+=i[e].length:a++;return a}static getAreaIdsForSignatureTypeOptions(e,t,a,i=!1){let n=[t];return 1===e&&i&&[1,2,3,4,5,6].includes(t)&&[1,2,3].includes(a)?n=[t-1,t,t+1].filter(e=>e>=1&&e<=6):1===e&&i&&[1,2,3,4,5,6].includes(t)&&[4,6].includes(a)&&(n=[1,2,3,4,5,6,13]),n}};return d.isPlugin=!1,d.scope="system",d.sortArea="a",d.position=4,d.label="Signatures",d.fullDataUpdate=!0,d.cacheConfig={sigTypeOptions:{ttl:300,maxSize:100}},d.validSignatureNames=["Cosmic Anomaly","Cosmic Signature","Kosmische Anomalie","Kosmische Signatur","Космическая аномалия","Скрытый сигнал","Anomalie cosmique","Signature cosmique","宇宙の特異点","宇宙のシグネチャ","异常空间","空间信号"],d.emptySignatureData={id:0,name:"",groupId:0,typeId:0},d.emptySignatureReaderCounterData={added:0,changed:0,deleted:0,deleteCon:0},d.editableDefaults={url:function(e){return new Promise((t,i)=>{if(e.pk){let n={};n[e.name]=e.value,a.request("PATCH","Signature",e.pk,n).then(e=>t(e.data)).catch(e=>i(e.data.jqXHR))}else t()})},dataType:"json",highlight:!1,error:function(t,i){let n="",s="Error";return t.statusText?n=t.statusText:t.name?(n=t.name.msg,t.name.field.$element.editable("show")):(n=t.responseJSON.text,s=t.status),a.showNotify({title:s+": save signature",text:n,type:"error"}),e(document).setProgramStatus("problem"),n}},d.defaultConfig={className:"pf-system-signature-module",sortTargetAreas:["a","b","c"],headline:"Signatures",moduleHeadlineIconAddClass:"pf-module-icon-button-add",moduleHeadlineIconReaderClass:"pf-module-icon-button-reader",moduleHeadlineIconLazyClass:"pf-module-icon-button-lazy",moduleHeadlineProgressBarClass:"pf-system-progress-scanned",fontUppercaseClass:"pf-font-uppercase",tableToolsActionClass:"pf-table-tools-action",tableToolbarStatusClass:"pf-table-toolbar-status",sigTableClearButtonClass:"pf-sig-table-clear-button",sigTableId:"pf-sig-table-",sigTableClass:"pf-sig-table",sigTablePrimaryClass:"pf-sig-table-primary",sigTableSecondaryClass:"pf-sig-table-secondary",sigTableInfoClass:"pf-sig-table-info",sigTableRowIdPrefix:"pf-sig-row_",sigTableEditSigNameInput:"pf-sig-table-edit-name-input",tableCellTypeClass:"pf-table-type-cell",tableCellConnectionClass:"pf-table-connection-cell",tableCellFocusClass:"pf-table-focus-cell",tableCellCounterClass:"pf-table-counter-cell",tableCellActionClass:"pf-table-action-cell",editableDescriptionInputClass:"pf-editable-description",editableUnknownInputClass:"pf-editable-unknown",signatureGroupsLabels:a.getSignatureGroupOptions("label"),signatureGroupsNames:a.getSignatureGroupOptions("name"),sigReaderDialogClass:"pf-sig-reader-dialog",sigInfoId:"pf-sig-info",sigInfoTextareaId:"pf-sig-info-textarea",sigReaderLazyUpdateId:"pf-sig-reader-lazy-update",sigReaderConnectionDeleteId:"pf-sig-reader-delete-connection",sigInfoCountSigNewId:"pf-sig-info-count-sig-new",sigInfoCountSigChangeId:"pf-sig-info-count-sig-change",sigInfoCountSigDeleteId:"pf-sig-info-count-sig-delete",sigInfoCountConDeleteId:"pf-sig-info-count-con-delete"},d});
//# sourceMappingURL=system_signature.js.map
