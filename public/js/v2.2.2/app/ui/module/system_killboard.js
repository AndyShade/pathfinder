define(["jquery","app/init","app/util","module/base","app/map/util"],(e,t,l,s,i)=>{"use strict";let a=class SystemKillboardModule extends s{constructor(e={}){super(Object.assign({},new.target.defaultConfig,e))}newHeaderElement(e){let t=super.newHeaderElement(e),l=Object.assign(document.createElement("h5"),{className:this._config.wsStatusWrapperClass});this._iconWsEl=this.newIconElement(["fa-circle","fa-fw","txt-color",this._config.wsStatusClass]),l.append(this._iconWsEl);let s=this.newHeadlineToolbarElement();this._iconFilterEl=this.newIconElement(["fa-filter","fa-fw",this._config.moduleHeadlineIconClass]);let i=this.newIconElement(["fa-external-link-alt","fa-fw",this._config.moduleHeadlineIconClass]);i.setAttribute("title","zkillboard.com"),i.onclick=(e=>this.openKillboardUrl(e));let a=this.newIconElement(["fa-map-marked-alt","fa-fw",this._config.moduleHeadlineIconClass]);return a.setAttribute("title","zkillboard.com region"),a.onclick=(e=>this.openKillboardUrlRegion(e)),s.append(a,i,this._iconFilterEl),t.append(l,s),t}request(t){return new Promise((l,s)=>{fetch(t).then(e=>e.json().then(t=>e.ok?t:Promise.reject(Object.assign({},t,{status:e.status,statusText:e.statusText})))).then(e=>{l(e)}).catch(e=>{console.error(t,e);let l=e.status?e.status:e,i=e.error?e.error:t;this.showNotify({title:l,text:i,type:"error"}),s(e)}).finally(()=>{e(this.moduleElement).hideLoadingAnimation()})})}getSystemKillsData(){let l=SystemKillboardModule.getCacheKey("systemId",this._systemData.systemId),s=SystemKillboardModule.getCache("zkb").get(l);return s?Promise.resolve(s):new Promise(s=>{e(this.moduleElement).showLoadingAnimation();let i=`${t.url.zKillboard}/npc/0/solarSystemID/${this._systemData.systemId}/pastSeconds/86400/`;this.request(i).then(e=>e.error?(this.showNotify({title:"Data fetch() from zKillboard failed",text:e.error,type:"error"}),Promise.reject(e)):(SystemKillboardModule.getCache("zkb").set(l,e),e)).then(e=>s(e)).catch(e=>{console.error(e),this.showNotify({title:"Data fetch() from zKillboard failed",text:e,type:"error"})})})}render(e,t){return this._mapId=e,this._systemData=t,this._dataPromise=this.getSystemKillsData(),this._bodyEl=Object.assign(document.createElement("div"),{className:this._config.bodyClassName}),this.moduleElement.append(this._bodyEl),this.setModuleObserver(),SystemKillboardModule.initWebSocket(),this.moduleElement}init(){super.init(),SystemKillboardModule.subscribeToWS(this),this.updateWsStatus(),this._dataPromise instanceof Promise&&this._dataPromise.then(e=>{this._killboardLabelEl=this.newLabelElement("recent kills within the last hour",["label-warning",this._config.labelRecentKillsClass,"hidden"]),e.length?(this._killboardEl=document.createElement("ul"),this._killboardEl.classList.add(this._config.systemKillboardListClass),this._bodyEl.append(this._killboardLabelEl,this._killboardEl,this.newControlElement("load more",[this._config.moduleHeadlineIconClass])),this._tempZkbKillmailIndexes=Object.keys(e),this.showKills(this._config.chunkCountKills)):this._bodyEl.append(this.newLabelElement("No kills found within the last 24h",["label-success"]))}).catch(e=>{console.error(e)})}beforeHide(){super.beforeHide(),SystemKillboardModule.unsubscribeFromWS(this)}showKills(e){if(e){let t=SystemKillboardModule.getCacheKey("systemId",this._systemData.systemId),l=SystemKillboardModule.getCache("zkb").get(t);if(this._killboardEl.children.length<this._config.maxCountKillHistoric&&(this._tempZkbKillmailIndexes||[]).length&&(l||[]).length){let t=l[this._tempZkbKillmailIndexes.shift()];t?this.loadKillmailData({killId:parseInt(t.killmail_id)||0,hash:t.zkb.hash},{chunkSize:--e,zkb:t.zkb},"renderKillmail"):console.warn("Killmail not found in local zkb cache")}else this.moduleElement.querySelector("."+this._config.controlAreaClass).style.display="none"}}loadKillmailData(e,t,l){let s=SystemKillboardModule.getCacheKey("killmail",e.killId),i=SystemKillboardModule.getCache("killmail").get(s);if(i)this[l](i.zkb,i.killmailData,i.systemData,t.chunkSize).then(e=>this.showKills(e.data.chunkSize)).catch(e=>console.error(e));else{let i="https://esi.evetech.net/latest/killmails/"+e.killId+"/"+e.hash+"/";this.request(i).then(e=>{let i=SystemKillboardModule.getSystemDataForCache(this._systemData);SystemKillboardModule.getCache("killmail").set(s,{zkb:t.zkb,killmailData:e,systemData:i}),this[l](t.zkb,e,i,t.chunkSize).then(e=>this.showKills(e.data.chunkSize)).catch(e=>console.error(e))}).catch(e=>{console.warn(e),this.showKills(t.chunkSize)})}}getAttackerBadgeData(e,t){let l,s;return e.solo?(l="#5cb85c",s="solo"):e.npc?(l="#d747d6",s="npc"):t&&(l="#adadad",s=t),{color:l,label:s}}renderKillmail(i,a,o,r,n="bottom"){return new Promise((d,m)=>{if(!this._killboardEl)return m(new ReferenceError("Could not render killmail. KB element not found."));let c=SystemKillboardModule.serverTime,h=c.setHours(0,0,0,0),b=l.convertDateToUTC(new Date(a.killmail_time)),u=Math.round((c-b)/1e3/60),y=Math.floor(u/60),g=s.Util.getObjVal(a,"attackers")||[],p=g.length,S=g.find(e=>e.final_blow),k={zkb:i,killmail:a,system:o,isPodKill:670===s.Util.getObjVal(a,"victim.ship_type_id"),attackersCount:p,attackerFinal:S,attackerBadge:this.getAttackerBadgeData(i,p),config:this._config,zKillboardUrl:"https://zkillboard.com",ccpImageServerUrl:t.url.ccpImageServer,imgUrlType:()=>(e,t)=>this.getImageUrl("types",parseInt(t(e))||0,64),imgUrlChar:()=>(e,t)=>this.getImageUrl("characters",parseInt(t(e))||0),imgUrlCorp:()=>(e,t)=>this.getImageUrl("corporations",parseInt(t(e))||0),imgUrlAlly:()=>(e,t)=>this.getImageUrl("alliances",parseInt(t(e))||0),dateFormat:()=>(e,t)=>{let s=l.convertDateToUTC(new Date(t(e))),i=l.convertDateToString(s);return s.setHours(0,0,0,0)===h&&(i="today"+i.substring(10)),i},iskFormat:()=>(e,t)=>l.formatPrice(t(e))};requirejs(["text!templates/modules/killmail.html","mustache"],(t,l)=>{this._killboardLabelEl.classList.toggle("hidden",!(0===y&&this._killboardLabelEl));let s=["append","beforeend"],i="lastChild";"top"===n&&(s=["prepend","afterbegin"],i="firstChild"),this._killboardEl.insertAdjacentHTML(s[1],l.render(t,k)),e(this._killboardEl[i]).velocity("transition.expandIn",{display:"flex",complete:function(){e(this).initTooltips()}},{display:"flex"}),d({action:"renderKillmail",data:{chunkSize:r}})})})}removeKillmail(){if(this._killboardEl){let e=this._nextToRemove||(this._listStreamHeadline?this._listStreamHeadline.previousElementSibling:null)||this._killboardEl.lastChild;e&&(this._nextToRemove=e.previousElementSibling,this._killboardEl.removeChild(e))}}getImageUrl(e,t,l=32){let i="#";return t&&(i=s.Util.eveImageUrl(e,t,l)),i}newListItemHeadElement(e){let t=Object.assign(document.createElement("li"),{className:["flex-row","flex-between","media",this._config.systemKillboardListHeadClass].join(" ")}),l=this.newIconElement(["fa-angle-double-down"]),s=this.newIconElement(["fa-angle-double-up"]),i=Object.assign(this.newHeadlineElement(),{className:"flex-col"}),a=Object.assign(this.newHeadlineElement(),{className:"flex-col"});i.append(l),a.append(s);let o=this.newHeadlineElement(e);o.classList.add("flex-col","flex-grow","media-body");let r=this.newHeadlineElement("Killstream");return r.classList.add("flex-col","flex-grow","media-body","text-right"),t.append(i,o,r,a),t}setModuleObserver(){this.setFilterIconObserver(),e(this.moduleElement).initTooltips({placement:"top"}),this.moduleElement.addEventListener("click",e=>{e.target.closest("."+this._config.controlAreaClass)&&(e.stopPropagation(),this.showKills(this._config.chunkCountKills))})}setFilterIconObserver(){let t=`map_${this._mapId}.streams`;this.getLocalStore().getItem(t).then(l=>{l||(l=["system","map"],this.getLocalStore().setItem(t,l)),this._filterStreams=l;let i=[{value:"system",text:`System (${this._systemData.name})`},{value:"map",text:`Map (${s.Util.getObjVal(s.Util.getCurrentMapData(this._mapId),"config.name")})`},{value:"all",text:"All (New Eden)"}];e(this._iconFilterEl).editable({mode:"popup",type:"checklist",showbuttons:!1,onblur:"submit",highlight:!1,title:"Streams",placement:"left",pk:this._mapId,value:this._filterStreams,source:i,emptyclass:"",emptytext:"",display:function(e,t){e&&t&&e.length<t.length?this.dataset.badge=String(e.length):delete this.dataset.badge},viewport:{selector:this.moduleElement,padding:5}}),e(this._iconFilterEl).on("save",(e,l)=>{this.getLocalStore().setItem(t,l.newValue).then(e=>this._filterStreams=e)})})}openKillboardUrl(e){e.stopPropagation(),window.open(`//zkillboard.com/system/${this._systemData.systemId}/`,"_blank")}openKillboardUrlRegion(e){e.stopPropagation(),window.open(`//zkillboard.com/region/${this._systemData.region.id}/`,"_blank")}filterKillmailByStreams(e){let t=this._filterStreams||[];return!!(t.includes("all")||t.includes("system")&&this._systemData.systemId===e.solar_system_id||t.includes("map")&&i.getSystemData(this._mapId,e.solar_system_id,"systemId"))}onWsMessage(e,t){if(this.filterKillmailByStreams(t)){if(!this._killboardEl){let e=this._bodyEl.querySelector(".label-success");e&&this._bodyEl.removeChild(e),this._killboardEl=document.createElement("ul"),this._killboardEl.classList.add(this._config.systemKillboardListClass),this._bodyEl.append(this._killboardLabelEl,this._killboardEl)}this._countKillsWS=(this._countKillsWS||0)+1,this._countKillsWS>this._config.maxCountKillsWS&&this.removeKillmail(),this._killboardEl&&1===this._countKillsWS&&(this._listStreamHeadline=this.newListItemHeadElement(this._systemData.name),this._killboardEl.prepend(this._listStreamHeadline));let l=i.getSystemData(this._mapId,t.solar_system_id,"systemId")||null;this.renderKillmail(e,t,l,0,"top").catch(e=>console.warn(e))}}updateWsStatus(){let t=!1,l=!1,s=!1,i="unknown";switch(SystemKillboardModule.wsStatus){case 1:i="connectingâ€¦",l=!0;break;case 2:i="connected",t=!0;break;case 3:i="error",s=!0;break;case 4:i="closed",s=!0}this._iconWsEl.classList.toggle("txt-color-green",t),this._iconWsEl.classList.toggle("txt-color-orange",l),this._iconWsEl.classList.toggle("txt-color-red",s),this._iconWsEl.setAttribute("title",i),e(this._iconWsEl).destroyTooltips().initTooltips({placement:"top"})}static getSystemDataForCache(e){return e?{id:e.systemId,name:e.name}:null}static getWsRelevantSystemsFromMaps(){let e=SystemKillboardModule.getCacheKey("tempSystemsData",1),t=SystemKillboardModule.getCache("zkb").get(e);if(!t){t=(s.Util.getCurrentMapData()||[]).reduce((e,t)=>Object.assign(e,(s.Util.getObjVal(t,"data.systems")||[]).reduce((e,t)=>Object.assign(e,{[t.systemId]:this.getSystemDataForCache(t)}),{})),{}),SystemKillboardModule.getCache("zkb").set(e,t)}return t}static cacheWsResponse(e){let t=e.zkb;delete e.zkb;let l=e,i=null,a=this.getWsRelevantSystemsFromMaps();if(Object.keys(a).map(e=>parseInt(e)).includes(l.solar_system_id)){i=s.Util.getObjVal(a,String(l.solar_system_id));let e=SystemKillboardModule.getCacheKey("killmail",l.killmail_id);SystemKillboardModule.getCache("killmail").set(e,{zkb:t,killmailData:l,systemData:i})}return[t,l]}static unsubscribeFromWS(e){SystemKillboardModule.wsSubscribtions=SystemKillboardModule.wsSubscribtions.filter(t=>t!==e)}static subscribeToWS(e){!SystemKillboardModule.wsSubscribtions.includes(e)&&e instanceof SystemKillboardModule&&SystemKillboardModule.wsSubscribtions.push(e)}static initWebSocket(){SystemKillboardModule.ws||(SystemKillboardModule.ws=new WebSocket("wss://zkillboard.com/websocket/"),SystemKillboardModule.wsStatus=1);var e;SystemKillboardModule.ws.onopen=(t=>{SystemKillboardModule.wsStatus=2,SystemKillboardModule.wsSubscribtions.forEach(e=>e.updateWsStatus()),e={action:"sub",channel:"killstream"},SystemKillboardModule.ws.send(JSON.stringify(e))}),SystemKillboardModule.ws.onmessage=(e=>{let t=JSON.parse(e.data),[l,s]=this.cacheWsResponse(t);SystemKillboardModule.wsSubscribtions.forEach(e=>e.onWsMessage(l,s))}),SystemKillboardModule.ws.onerror=(e=>{SystemKillboardModule.wsStatus=3,SystemKillboardModule.ws=null,SystemKillboardModule.wsSubscribtions.forEach(e=>e.updateWsStatus())}),SystemKillboardModule.ws.onclose=(e=>{SystemKillboardModule.wsStatus=4,SystemKillboardModule.ws=null,SystemKillboardModule.wsSubscribtions.forEach(e=>e.updateWsStatus())})}static getCacheKey(e,t){if("string"==typeof e&&e.length&&parseInt(t))return`${e}_${t}`;throw new TypeError("Invalid cache key types")}};return a.isPlugin=!1,a.scope="system",a.sortArea="c",a.position=1,a.label="Killboard",a.wsStatus=void 0,a.serverTime=s.Util.getServerTime(),a.wsSubscribtions=[],a.cacheConfig={zkb:{ttl:180,maxSize:50},killmail:{ttl:1800,maxSize:500}},a.defaultConfig={className:"pf-system-killboard-module",sortTargetAreas:["a","b","c"],headline:"Killboard",systemKillboardListClass:"pf-system-killboard-list",systemKillboardListHeadClass:"pf-system-killboard-list-head",systemKillboardListImgL:"pf-system-killboard-img-l",systemKillboardListImgM:"pf-system-killboard-img-m",systemKillboardListImgS:"pf-system-killboard-img-s",wsStatusWrapperClass:"pf-system-killboard-wsStatusWrapper",wsStatusClass:"pf-system-killboard-wsStatus",labelRecentKillsClass:"pf-system-killboard-label-recent",minCountKills:5,chunkCountKills:5,maxCountKillHistoric:43,maxCountKillsWS:150},a});
//# sourceMappingURL=system_killboard.js.map
