define(["jquery","app/init","app/util","app/map/util","module/base"],(e,t,s,a,o)=>{"use strict";let n=class SystemInfoModule extends o{constructor(e={}){super(Object.assign({},new.target.defaultConfig,e))}newHeaderElement(){let e=this.newHeadElement(),o=this.newHeadlineElement(this._systemData.alias||this._systemData.name);o.setAttribute("title","alias"),o.classList.add("pull-right"),"A"===this._systemData.security&&o.classList.add(this._config.fontTriglivianClass);let n=this.newIconElement(["fa-fw","fa-angle-double-right"]),i=this.newHeadlineElement(),l=document.createElement("span");l.setAttribute("title","type"),l.classList.add(this._config.typeLinkClass),l.textContent=a.getSystemTypeInfo(this._systemData.type.id,"name"),i.append(l,n);let r=this.newHeadlineElement(),c=document.createElement("span");c.setAttribute("title","region"),c.classList.add(this._config.regionLinkClass),"A"===this._systemData.security&&c.classList.add(this._config.fontTriglivianClass),c.textContent=this._systemData.region.name,r.append(c,n.cloneNode());let m=this.newHeadlineElement(),d=document.createElement("span");d.classList.add(this._config.constellationLinkClass,this._config.linkClass,s.config.popoverTriggerClass),"A"===this._systemData.security&&d.classList.add(this._config.fontTriglivianClass),d.textContent=this._systemData.constellation.name,d.setAttribute("popup-ajax",t.path.getConstellationData+"/"+this._systemData.constellation.id),m.append(d,n.cloneNode());let f=this.newHeadlineElement(),p=document.createElement("span");p.setAttribute("title","system"),"A"===this._systemData.security&&p.classList.add(this._config.fontTriglivianClass),p.textContent=this._systemData.name;let u=this.newIconElement(["fa-fw","fa-copy",this._config.moduleHeadlineIconClass,this._config.textActionIconCopyClass]);if(u.setAttribute("title","copy url"),u.dataset.copy=a.getMapDeeplinkUrl(this._systemData.mapId,this._systemData.id),f.append(p,u),this._systemData.locked){let e=this.newIconElement(["fa-fw","fa-lock",this._config.moduleHeadlineIconClass]);e.setAttribute("title","locked"),f.append(e)}for(let e of this.getThirdPartySystemLinks(["dotlan","eveeye","anoik"]))if(e.showInModuleHead){let t=document.createElement("a");t.classList.add("pf-bg-icon-inline"),t.style.setProperty("--bg-image",`url("${s.imgRoot()}icons/logo_${e.page}.png")`),t.setAttribute("title",e.title),t.setAttribute("href",e.url),t.setAttribute("target","_blank"),t.setAttribute("rel","noopener"),f.append(t)}return e.append(this.newHandlerElement(),o,i,r,m,f),e}update(t){return super.update(t).then(t=>new Promise(a=>{if(this._systemData.id===t.id&&this._updated!==t.updated.updated){let a=!0,o=e(this.moduleElement).find("."+this._config.systemInfoNameClass),n={created:t.created,updated:t.updated};o.addCharacterInfoTooltip(n);let i=e(this.moduleElement).find("."+this._config.systemInfoStatusLabelClass),l=parseInt(i.attr("data-status"));if(l!==t.status.id){let e=s.getStatusInfoForSystem(l,"class"),a=s.getStatusInfoForSystem(t.status.id,"class"),o=s.getStatusInfoForSystem(t.status.id,"label");i.removeClass(e).addClass(a).text(o),i.attr("data-status",t.status.id)}let r=e(this.moduleElement).find("."+this._config.descriptionTextareaElementClass);if(r.length){if(r.html()!==t.description)if("object"==typeof r.data().summernote)a=!1;else{let e=t.description;s.isValidHtml(e)||(e="<p>"+(e=e.replace(/(\r\n|\n|\r)/g,"<br>"))+"</p>"),r.html(e)}}a&&(this._updated=t.updated.updated)}e(this.moduleElement).hideLoadingAnimation(),a({action:"update",data:{module:this}})}))}render(e,t){this._systemData=t;let s,a,o,n=document.createElement("div");return n.classList.add(this._config.bodyClassName,"grid"),(s=document.createElement("div")).classList.add(this._config.systemInfoSectionClass),n.append(s),(a=document.createElement("div")).classList.add(this._config.systemSovSectionClass,"pf-dynamic-area"),n.append(a),(o=document.createElement("div")).classList.add(this._config.descriptionSectionClass),n.append(o),this.moduleElement.append(n),require(["text!templates/modules/system_info.html","mustache","summernote.loader"],(e,t,n)=>{SystemInfoModule.Mustache=t,SystemInfoModule.Summernote=n,e=(new DOMParser).parseFromString(e,"text/html"),SystemInfoModule.tplInfoSection=e.getElementById("tplInfoSection").innerHTML,SystemInfoModule.tplSovSection=e.getElementById("tplSovSection").innerHTML,SystemInfoModule.tplDescSection=e.getElementById("tplDescSection").innerHTML,SystemInfoModule.Mustache.parse(SystemInfoModule.tplInfoSection),SystemInfoModule.Mustache.parse(SystemInfoModule.tplSovSection),SystemInfoModule.Mustache.parse(SystemInfoModule.tplDescSection),this.renderInfoSection(s,SystemInfoModule.tplInfoSection),this.renderSovSection(a,SystemInfoModule.tplSovSection),this.renderDescSection(o,SystemInfoModule.tplDescSection),this.setModuleObserver()}),this.moduleElement}renderInfoSection(e,o){if(SystemInfoModule.Mustache&&e&&o){let n={config:this._config,system:this._systemData,systemStatusClass:s.getStatusInfoForSystem(this._systemData.status.id,"class"),systemStatusLabel:s.getStatusInfoForSystem(this._systemData.status.id,"label"),systemNameClass:"A"===this._systemData.security?this._config.fontTriglivianClass:"",systemSecurityClass:s.getSecurityClassForSystem(this._systemData.security),trueSec:this._systemData.trueSec.toFixed(1),trueSecClass:s.getTrueSecClassForSystem(this._systemData.trueSec),systemEffectName:a.getEffectInfoForSystem(this._systemData.effect,"name"),systemEffectClass:a.getEffectInfoForSystem(this._systemData.effect,"class"),systemPlanetCount:this._systemData.planets?this._systemData.planets.length:0,systemStaticData:(s.getObjVal(this._systemData,"statics")||[]).reduce((e,s)=>(e.push(Object.assign({},t.wormholes[s])),e),[]),systemShatteredClass:s.getSecurityClassForSystem("SH"),popoverTriggerClass:s.config.popoverTriggerClass};e.innerHTML=SystemInfoModule.Mustache.render(o,n),this.setInfoSectionObserver(e)}}renderSovSection(e,t){if(SystemInfoModule.Mustache&&e&&t){let a,o,n={row1Label:"Sov.",row1Val:"???",row1Img:void 0,row1ImgTitle:void 0,row2Label:void 0,row2Val:void 0,row3Label:void 0,row3Val:void 0};if(this._systemData.sovereignty){let e=s.getObjVal(this._systemData.sovereignty,"faction"),t=s.getObjVal(this._systemData.sovereignty,"alliance"),n=s.getObjVal(this._systemData.sovereignty,"corporation");e?a={row1Val:"Faction",row1Img:s.eveImageUrl("factions",e.id,64),row1ImgTitle:e.name,row2Val:e.name}:(t&&(a={row1Val:"Alliance",row1Img:s.eveImageUrl("alliances",t.id,64),row1ImgTitle:t.name,row2Val:"<"+t.ticker+">",row3Label:"Ally",row3Val:t.name}),n&&(o={row1Label:"Corp",row1Val:n.name,row1Img:s.eveImageUrl("corporations",n.id,64)}))}let i={config:this._config,sovereigntyPrimary:a?Object.assign({},n,a):void 0,sovereigntySecondary:o?Object.assign({},n,o):void 0};i.sovereigntyPrimary?(e.innerHTML=SystemInfoModule.Mustache.render(t,i),this.setSovSectionObserver(e)):(e.parentNode.classList.add(this._config.bodyClassName+"-small"),e.remove())}}renderDescSection(e,t){if(SystemInfoModule.Mustache&&e&&t){let a={config:this._config,summernoteClass:s.config.summernoteClass};e.innerHTML=SystemInfoModule.Mustache.render(t,a),this.setDescSectionObserver(e)}}init(){super.init()}setModuleObserver(){e(this.moduleElement).find("."+this._config.textActionIconCopyClass).on("click",function(){let t=e(this).attr("data-copy");s.copyToClipboard(t).then(e=>{e.data&&s.showNotify({title:"Copied to clipboard",text:t,type:"success"})})}),e(this.moduleElement).find("[popup-ajax]").popover({html:!0,trigger:"hover",placement:"top",delay:200,container:"body",content:function(){let t=e(this),a=t.data("bs.popover");return e.ajax({url:t.attr("popup-ajax"),success:function(e){a.options.content=s.getSystemsInfoTable(e.systemsData),a.show()}}),"Loading..."}}),e(this.moduleElement).initTooltips({placement:"top"})}setInfoSectionObserver(t){e(t).find("."+this._config.systemInfoEffectClass).addSystemEffectTooltip(this._systemData.security,this._systemData.effect,{placement:"left"}),e(t).find("."+this._config.systemInfoPlanetsClass).addSystemPlanetsTooltip(this._systemData.planets,{placement:"left"}),a.initWormholeInfoTooltip(e(t),"[data-name]",{placement:"left"})}setSovSectionObserver(t){e(t).showLoadingAnimation()}setDescSectionObserver(t){let a=e(t).find("."+this._config.descriptionAreaClass),o=e(t).find("."+this._config.addDescriptionButtonClass),n=e(t).find("."+this._config.descriptionTextareaElementClass),i=this._config.maxDescriptionLength,l=this._systemData.id,r=this.update.bind(this);a.showLoadingAnimation(),o.on("click",function(t){t.stopPropagation();let o=e(this);o.hide();let c=!1;SystemInfoModule.Summernote.initSummernote(n,{height:75,minHeight:75,maxHeight:500,focus:!0,placeholder:!1,maxTextLength:i,disableDragAndDrop:!0,shortcuts:!1,toolbar:[["style",["style"]],["font",["underline","strikethrough","clear"]],["color",["color"]],["para",["ul","ol","paragraph"]],["table",["table"]],["insert",["link","hr"]],["misc",["undo","redo"]],["lengthField"],["customBtn",["discardBtn","saveBtn"]]],buttons:{saveBtn:t=>{return e.summernote.ui.button({contents:'<i class="fas fa-fw fa-check"/>',container:"body",className:["btn-success","btn-save"],click:e=>{if(t.layoutInfo.editable.removeClass("has-error"),c){let e=!0,o="";t.$note.summernote("isEmpty")?t.$note.summernote("code",""):(o=t.$note.summernote("code"),s.isValidHtml(o)||(e=!1,t.layoutInfo.editable.addClass("has-error"),s.showNotify({title:"Validation failed",text:"HTML not valid",type:"error"}))),e&&(a.showLoadingAnimation(),s.request("PATCH","System",l,{description:o},{descriptionArea:a},e=>{e.descriptionArea.hideLoadingAnimation()}).then(e=>{t.$note.summernote("destroy"),r(e.data)},s.handleAjaxErrorResponse))}else t.$note.summernote("destroy")}}).render()}},callbacks:{onInit:function(e){e.editable.css("height","150px");e.toolbar.find(".note-current-color-button").attr("data-backcolor","#e2ce48").find(".note-recent-color").css("background-color","#e2ce48")},onChange:function(e){c=!0},onPaste:function(e){let t=((e.originalEvent||e).clipboardData||window.clipboardData).getData("Text");e.preventDefault(),setTimeout(()=>{document.execCommand("insertText",!1,t)},10)},onDestroy:function(e){o.show()}}})})}getThirdPartySystemLinks(e){let o=[],n="w-space"===a.getSystemTypeInfo(s.getObjVal(this._systemData,"type.id"),"name"),i=s.getObjVal(this._systemData,"name")||"",l=s.getObjVal(this._systemData,"region.name")||"";for(let a=0;a<e.length;a++){let r=null,c=!0,m=s.getObjVal(t,"url."+e[a]);if(m){let t=!1;switch(e[a]){case"dotlan":let s=i.replace(/ /g,"_"),o=l.replace(/ /g,"_");t=n?m+"/system/"+s:m+"/map/"+o+"/"+s;break;case"eveeye":n||(t=m+"/?m="+encodeURIComponent(l)+"&s="+encodeURIComponent(i),t+="&t=eswkc&o=thera,con_svc,node_sov,sub_sec,sector_fac,tag_mk");break;case"anoik":n&&(t=m+"/systems/"+i)}if(t){r={title:new URL(t).hostname,url:t}}}r&&o.push(Object.assign({},r,{page:e[a],showInModuleHead:c}))}return o}beforeDestroy(){super.beforeDestroy();let t=this.moduleElement.querySelector(`.${this._config.descriptionTextareaElementClass}`);t&&e(t).summernote&&e(t).summernote("destroy")}};return n.isPlugin=!1,n.scope="system",n.sortArea="a",n.position=2,n.label="Information",n.fullDataUpdate=!0,n.defaultConfig={className:"pf-system-info-module",sortTargetAreas:["a","b","c"],textActionIconCopyClass:"pf-module-icon-button-copy",constellationLinkClass:"pf-system-info-constellation",regionLinkClass:"pf-system-info-region",typeLinkClass:"pf-system-info-type",systemInfoSectionClass:"pf-system-info-section",systemInfoTableClass:"pf-module-table",systemInfoNameClass:"pf-system-info-name",systemInfoEffectClass:"pf-system-info-effect",systemInfoPlanetsClass:"pf-system-info-planets",systemInfoStatusLabelClass:"pf-system-info-status-label",systemSovSectionClass:"pf-system-sov-section",systemSovTableClass:"pf-module-table",systemSovFwContestedRowClass:"pf-system-sov-fw-contested-row",systemSovFwOccupationRowClass:"pf-system-sov-fw-occupation-row",systemSovFwContestedClass:"pf-system-sov-fw-contested",systemSovFwPercentageClass:"pf-system-sov-fw-percentage",systemSovFwOccupationClass:"pf-system-sov-fw-occupation",systemSovFwOccupationImageClass:"pf-system-sov-fw-occupation-image",systemSovFwStatusIconClass:"pf-system-sov-fw-status-icon",descriptionSectionClass:"pf-system-description-section",descriptionAreaClass:"pf-system-info-description-area",addDescriptionButtonClass:"pf-system-info-description-button",descriptionTextareaElementClass:"pf-system-info-description",maxDescriptionLength:9e3,fontTriglivianClass:"pf-triglivian",linkClass:"pf-link"},n});
//# sourceMappingURL=system_info.js.map
