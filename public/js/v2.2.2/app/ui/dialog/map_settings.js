define(["jquery","app/init","app/util","app/render","bootbox","app/map/util","app/module_map","app/map/overlay/util"],(e,a,t,o,n,i,l,s)=>{"use strict";let r="pf-map-dialog",d="pf-map-dialog-new",c="pf-map-dialog-edit",p="pf-map-dialog-settings",g="pf-map-dialog-download",f="pf-map-dialog-new-name-input",m="pf-map-dialog-new-icon-select",h="pf-map-dialog-new-scope-select",y="pf-map-dialog-new-type-select",b="pf-map-dialog-edit-name-input",u="pf-map-dialog-edit-icon-select",C="pf-map-dialog-edit-scope-select",k="pf-map-dialog-edit-type-select",I="pf-map-dialog-delete-connections-expired",w="pf-map-dialog-delete-connections-eol",R="pf-map-dialog-persistent-aliases",M="pf-map-dialog-persistent-signatures",E="pf-map-dialog-track-abyss-jumps",x="pf-map-dialog-history",v="pf-map-dialog-activity",S="pf-map-dialog-slack-url",H="pf-map-dialog-slack-username",T="pf-map-dialog-slack-icon",A="pf-map-dialog-slack-channel-history",F="pf-map-dialog-slack-channel-rally",_="pf-map-dialog-discord-username",L="pf-map-dialog-discord-url-rally",j="pf-map-dialog-discord-url-history",U="pf-map-dialog-character-select",O="pf-map-dialog-corporation-select",D="pf-map-dialog-alliance-select",V="pf-map-dialog-form-export",W="pf-map-dialog-form-import",N="pf-map-dialog-button-export",B="pf-map-dialog-button-import",P="pf-map-filename-export",J="pf-map-filename-import",q="pf-map-import-container",z="pf-form-dropzone";e.fn.showMapSettingsDialog=function(o,K){var Q;e("#"+r).is(":visible")||requirejs(["text!templates/dialog/map.html","text!templates/form/map.html","mustache"],(X,Y,ee)=>{let ae=e=>()=>(a,t)=>{if(t(a)===String(e))return"selected"},te=!1===o,oe=!1===o,ne=!1===o,ie=!i||i.checkRight("map_update",o.config),le=!i||i.checkRight("map_export",o.config),se=!i||i.checkRight("map_import",o.config),re=!i||i.checkRight("map_share",o.config),de=i.getMapTypes(!0,"map_create"),ce=i.getMapTypes(!0,"map_update"),pe={id:r,mapData:o,type:de,select2Class:t.config.select2Class,hasRightMapUpdate:ie,hasRightMapExport:le,hasRightMapImport:se,hasRightMapShare:re,formErrorContainerClass:t.config.formErrorContainerClass,formWarningContainerClass:t.config.formWarningContainerClass,formInfoContainerClass:t.config.formInfoContainerClass,openTabNew:"new"===K.tab,openTabEdit:"edit"===K.tab,openTabSettings:"settings"===K.tab,openTabDownload:"download"===K.tab,dialogMapNewContainerId:d,dialogMapEditContainerId:c,dialogMapSettingsContainerId:p,dialogMapDownloadContainerId:g,hideEditTab:te,hideSettingsTab:oe,hideDownloadTab:ne,deleteExpiredConnectionsId:I,deleteEolConnectionsId:w,persistentAliasesId:R,persistentSignaturesId:M,trackAbyssalJumpsId:E,logHistoryId:x,logActivityId:v,deleteExpiredConnections:!0,deleteEolConnections:!0,persistentAliases:!0,persistentSignatures:!0,trackAbyssalJumps:!1,logActivity:!0,logHistory:!0,slackWebHookURLId:S,slackUsernameId:H,slackIconId:T,slackChannelHistoryId:A,slackChannelRallyId:F,slackWebHookURL:"",slackUsername:"",slackIcon:"",slackChannelHistory:"",slackChannelRally:"",slackEnabled:!1,slackHistoryEnabled:!1,slackRallyEnabled:!1,slackSectionShow:!1,discordUsernameId:_,discordWebHookURLRallyId:L,discordWebHookURLHistoryId:j,discordUsername:"",discordWebHookURLRally:"",discordWebHookURLHistory:"",discordEnabled:!1,discordRallyEnabled:!1,discordHistoryEnabled:!1,discordSectionShow:!1,characterSelectId:U,corporationSelectId:O,allianceSelectId:D,maxCharacter:a.mapTypes.private.defaultConfig.max_shared,maxCorporation:a.mapTypes.corporation.defaultConfig.max_shared,maxAlliance:a.mapTypes.alliance.defaultConfig.max_shared,accessCharacter:[],accessCorporation:[],accessAlliance:[],dialogMapExportFormId:V,dialogMapImportFormId:W,buttonExportId:N,buttonImportId:B,fieldExportId:P,fieldImportId:J,dialogMapImportInfoId:q,formatFilename:()=>(e,a)=>(Q=a(e),((Q=Q.replace(/[^a-zA-Z0-9]/g,"_"))+"_"+(new Date).toISOString().slice(0,10).replace(/-/g,"_")).replace(/__/g,"_"))};!1!==o&&(Object.assign(pe,{deleteExpiredConnections:o.config.deleteExpiredConnections,deleteEolConnections:o.config.deleteEolConnections,persistentAliases:o.config.persistentAliases,persistentSignatures:o.config.persistentSignatures,trackAbyssalJumps:o.config.trackAbyssalJumps,logActivity:o.config.logging.activity,logHistory:o.config.logging.history,slackWebHookURL:o.config.logging.slackWebHookURL,slackUsername:o.config.logging.slackUsername,slackIcon:o.config.logging.slackIcon,slackChannelHistory:o.config.logging.slackChannelHistory,slackChannelRally:o.config.logging.slackChannelRally,slackEnabled:Boolean(t.getObjVal(a,"slack.status")),discordUsername:t.getObjVal(o,"config.logging.discordUsername"),discordWebHookURLRally:t.getObjVal(o,"config.logging.discordWebHookURLRally"),discordWebHookURLHistory:t.getObjVal(o,"config.logging.discordWebHookURLHistory"),discordEnabled:Boolean(t.getObjVal(a,"discord.status")),accessCharacter:o.config.access.character,accessCorporation:o.config.access.corporation,accessAlliance:o.config.access.alliance}),Object.assign(pe,{slackChannelHistory:0===pe.slackChannelHistory.indexOf("#")?pe.slackChannelHistory.substr(1):pe.slackChannelHistory,slackChannelRally:0===pe.slackChannelRally.indexOf("#")?pe.slackChannelRally.substr(1):pe.slackChannelRally,slackHistoryEnabled:pe.slackEnabled&&Boolean(t.getObjVal(a.mapTypes,o.config.type.name+".defaultConfig.send_history_slack_enabled")),slackRallyEnabled:pe.slackEnabled&&Boolean(t.getObjVal(a.mapTypes,o.config.type.name+".defaultConfig.send_rally_slack_enabled")),slackSectionShow:pe.slackEnabled&&pe.slackWebHookURL.length>0,discordRallyEnabled:pe.discordEnabled&&Boolean(t.getObjVal(a.mapTypes,o.config.type.name+".defaultConfig.send_rally_discord_enabled")),discordHistoryEnabled:pe.discordEnabled&&Boolean(t.getObjVal(a.mapTypes,o.config.type.name+".defaultConfig.send_history_discord_enabled")),discordSectionShow:pe.discordEnabled&&(pe.discordWebHookURLRally.length>0||pe.discordWebHookURLHistory.length>0)}));let ge=ee.render(X,pe);ge=e(ge);let fe={select2Class:t.config.select2Class,scope:i.getMapScopes(),icon:i.getMapIcons(),formErrorContainerClass:t.config.formErrorContainerClass,formWarningContainerClass:t.config.formWarningContainerClass,formInfoContainerClass:t.config.formInfoContainerClass},me=Object.assign({},fe,{type:de,hasRightMapForm:!0,nameInputId:f,iconSelectId:m,scopeSelectId:h,typeSelectId:y,mapId:0,mapIcon:void 0,mapName:void 0,mapScopeId:void 0,mapTypeId:void 0}),he=ee.render(Y,me);if(e("#"+d,ge).html(he),!te){let a=Object.assign({},fe,{type:ce,hasRightMapForm:ie,nameInputId:b,iconSelectId:u,scopeSelectId:C,typeSelectId:k,mapId:o.config.id,mapIcon:ae(o.config.icon),mapName:o.config.name,mapScopeId:ae(o.config.scope.id),mapTypeId:ae(o.config.type.id)}),t=ee.render(Y,a);e("#"+c,ge).html(t)}let ye=n.dialog({title:"Map settings",message:ge,buttons:{close:{label:"cancel",className:"btn-default"},success:{label:'<i class="fas fa-check fa-fw"></i>&nbsp;save',className:"btn-success",callback:function(){let a=e("#"+r).find("form").filter(":visible");if(a.validator("validate"),a.find("select").each(function(){let a=e(this),t=a.val();t&&t.length>0?a.parents(".form-group").removeClass("has-error"):a.parents(".form-group").addClass("has-error")}),a.isValidForm()){let n=ye.find(".modal-content");n.showLoadingAnimation();let i=a.getFormValues();Object.keys(i).map((e,a)=>{["slackChannelHistory","slackChannelRally"].includes(e)&&(i[e]=(i[e].length?"#":"")+i[e])}),o&&s.getMapOverlay(o.map.getContainer(),"timer").startMapUpdateCounter();let r=i.id?"PATCH":"PUT";t.request(r,"Map",i.id,i,{formElement:a},e=>{n.hideLoadingAnimation()}).then(a=>{let o=t.getObjVal(a,"data.mapData");t.showNotify({title:"Map settings",text:`Map: ${t.getObjVal(o,"name")}`,type:"success"});let n=t.getMapTabLinkElements(t.getMapModule()[0],t.getObjVal(o,"id"));1===n.length&&l.updateTabData(n[0],o),e(ye).modal("hide"),t.triggerMenuAction(document,"Close")},t.handleAjaxErrorResponse)}return!1}}}});ye.on("shown.bs.modal",function(a){ye.initTooltips(),ye.find(".navbar li.active a[data-toggle=tab]").trigger("shown.bs.tab"),ye.find(".navbar a[data-toggle=tab]").on("click",function(a){if(e(this).hasClass("disabled"))return a.preventDefault(),!1}),ye.find("#"+d+" ."+t.config.select2Class+", #"+c+" ."+t.config.select2Class+", #"+g+" ."+t.config.select2Class).select2({minimumResultsForSearch:-1,width:"100%"}),ye.find("form").initFormValidation();let n=e("#"+r).find("form").filter(":visible");n.showFormMessage([{type:"info",text:"Creating new maps or change settings may take a few seconds"}]),o||n.showFormMessage([{type:"warning",text:"No maps found. Create a new map before you can start"}]);let i=ye.find("#"+g);if(i.length){i.find("#"+N).on("click",{mapData:o},function(a){if(e("#"+V).isValidForm()){let a=t.getMapModule().getActiveMap();if(a){let t=a.getMapDataFromClient(["hasId"]),o=e(this);Z(o,t),o.attr("disabled",!0)}else console.error("Map not found")}else a.preventDefault()});let a=i.find("#"+W);if(window.File&&window.FileReader&&window.FileList&&window.Blob){i.find("#"+J).on("change",function(e){e.stopPropagation(),e.preventDefault();let t=a.find("#"+q);t.hide().empty(),a.hideFormMessage("all");let o=[],n=e.target.files;for(let e,a=0;e=n[a];a++)o.push(a+1+". file: "+e.name+" - "+e.size+" bytes; last modified: "+e.lastModifiedDate.toLocaleDateString());o.length>0&&t.html(o).show(),a.validator("validate")});let e={mapData:[]},t=[],o=0,n=0,l=function(i){try{e.mapData.push(JSON.parse(i.target.result))}catch(e){n++,a.showFormMessage([{type:"error",text:"File can not be parsed"}])}o===t.length&&0===n&&$(e,()=>{ye.modal("hide")})},s=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},r=function(i){i.stopPropagation(),i.preventDefault(),(e=a.getFormValues()).mapData=[],o=0,n=0,t=i.dataTransfer.files;for(let e;e=t[o];o++){let a=new FileReader;a.onload=l,a.readAsText(e)}},d=i.find("."+z);d.length&&(d[0].addEventListener("dragover",s,!1),d[0].addEventListener("drop",r,!1)),i.find("#"+B).on("click",function(s){if(a.validator("validate"),a.isValidForm()){(e=a.getFormValues()).mapData=[];let s,r=i.find("#"+J);for(t=r[0].files,o=0,n=0;s=t[o];o++){let e=new FileReader;e.onload=l,e.readAsText(s)}}})}else a.showFormMessage([{type:"error",text:"The File APIs are not fully supported in this browser."}])}}),ye.find(".navbar a").on("shown.bs.tab",function(a){let t=ye.find("div.modal-dialog"),o=e(a.target).attr("href"),n=e(o).find("form.form-horizontal"),i=ye.find("#"+U),l=ye.find("#"+O),s=ye.find("#"+D);o==="#"+p?(t.toggleClass("modal-lg",!0),G(ye)):(t.toggleClass("modal-lg",!1),void 0!==e(i).data("select2")&&e(i).select2("destroy"),void 0!==e(l).data("select2")&&e(l).select2("destroy"),void 0!==e(s).data("select2")&&e(s).select2("destroy")),o!=="#"+g&&n.length?ye.find("button.btn-success").show():ye.find("button.btn-success").hide()})})};let $=(o,n)=>{let i=e("#"+W);i.hideFormMessage("all");let l=i.parents(".modal-content");l.showLoadingAnimation(),e.ajax({type:"POST",url:a.path.importMap,data:o,dataType:"json"}).done(function(e){e.error.length?i.showFormMessage(e.error):(e.warning.length&&i.showFormMessage(e.warning),n&&n(),t.showNotify({title:"Import finished",text:"Map(s) imported",type:"success"}))}).fail(function(e,a,o){let n=a+" "+o;t.showNotify({title:e.status+": importMap",text:n,type:"error"})}).always(function(){i.find("input, select").resetFormFields().trigger("change"),l.hideLoadingAnimation()})},Z=(a,t)=>{let o=e("#"+P),n="",i="";o.length&&(n=o.val()).length>0&&(i="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),a.attr("href","data:"+i),a.attr("download",n+".json")},G=e=>{let t=e.find("#"+U),o=e.find("#"+O),n=e.find("#"+D);t.initAccessSelect({type:"character",maxSelectionLength:a.mapTypes.private.defaultConfig.max_shared}),o.initAccessSelect({type:"corporation",maxSelectionLength:a.mapTypes.corporation.defaultConfig.max_shared}),n.initAccessSelect({type:"alliance",maxSelectionLength:a.mapTypes.alliance.defaultConfig.max_shared})};e.fn.showDeleteMapDialog=function(e){let a=t.getObjVal(e,"config.id"),o=t.getObjVal(e,"config.name");if(!a)return;let i=`<span class="txt-color txt-color-danger">${o}</span>`,l=n.confirm({message:`Delete map "${i}"?`,buttons:{confirm:{label:'<i class="fas fa-trash fa-fw"></i>&nbsp;delete map',className:"btn-danger"}},callback:e=>{if(e){return l.find(".modal-content").showLoadingAnimation(),t.request("DELETE","Map",a,{},{}).then(e=>{t.showNotify({title:"Map deleted",text:"Map: "+o,type:"success"})},t.handleAjaxErrorResponse).finally(()=>l.modal("hide")),!1}}})}});
//# sourceMappingURL=map_settings.js.map
