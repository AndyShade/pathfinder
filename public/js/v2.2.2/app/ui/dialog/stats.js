define(["jquery","app/init","app/util","app/render","app/counter","bootbox","peityInlineChart"],(e,t,a,s,n,i)=>{"use strict";let l={statsDialogId:"pf-stats-dialog",dialogNavigationClass:"pf-dialog-navigation-list",dialogNavigationListItemClass:"pf-dialog-navigation-list-item",dialogNavigationOffsetClass:"pf-dialog-navigation-offset",dialogNavigationPrevClass:"pf-dialog-navigation-prev",dialogNavigationNextClass:"pf-dialog-navigation-next",statsContainerId:"pf-stats-dialog-container",statsTableId:"pf-stats-table",tableCellImageClass:"pf-table-image-cell",moduleHeadlineIconClass:"pf-module-icon-button",statsLineChartClass:"pf-line-chart"},o=t=>{let s=function(e,t,a,s){return/^\d+$/.test(e.data)?e.data:'<span class="'+l.statsLineChartClass+'" data-peity=\'{ "stroke": "#477372" }\'>'+e.data+"</span>"},i=function(e,t,a,s){let n=e;return"display"===t&&(n=e.toLocaleString()),n},o=t.find("#"+l.statsTableId).DataTable({dom:'<"flex-row flex-between"<"flex-col"l><"flex-col"B><"flex-col"fS>><"flex-row"<"flex-col flex-grow"tr>><"flex-row flex-between"<"flex-col"i><"flex-col"p>>',buttons:{name:"tableTools",buttons:[{extend:"copy",tag:"a",className:l.moduleHeadlineIconClass,text:'<i class="fas fa-fw fa-copy"></i> copy',exportOptions:{orthogonal:"filter"}},{extend:"csv",tag:"a",className:l.moduleHeadlineIconClass,text:'<i class="fas fa-fw fa-download"></i> csv',exportOptions:{orthogonal:"filter"}}]},pageLength:30,lengthMenu:[[10,20,30,50],[10,20,30,50]],paging:!0,ordering:!0,order:[20,"desc"],info:!0,searching:!0,hover:!1,language:{emptyTable:"No statistics found",zeroRecords:"No characters found",lengthMenu:"Show _MENU_ characters",info:"Showing _START_ to _END_ of _TOTAL_ characters"},columnDefs:[{targets:0,name:"rowIndex",title:'<i class="fas fa-hashtag"></i>',orderable:!1,searchable:!1,width:10,class:"text-right",data:"character.id"},{targets:1,name:"image",title:"",orderable:!1,searchable:!1,width:26,className:["text-center",l.tableCellImageClass].join(" "),data:"character",render:{_:function(e,t,s,n){return'<img src="'+a.eveImageUrl("characters",parseInt(e.id))+'"/>'}}},{targets:2,name:"name",title:"name",width:200,data:"character",render:{_:"name",sort:"name"}},{targets:3,name:"lastLogin",title:"last login",searchable:!1,width:70,className:["text-right","separator-right"].join(" "),data:"character.lastLogin",defaultContent:""},{targets:4,name:"mapCreate",title:'<span title="created" data-toggle="tooltip">C&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"mapCreate",render:{_:s}},{targets:5,name:"mapUpdate",title:'<span title="updated" data-toggle="tooltip">U&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"mapUpdate",render:{_:s}},{targets:6,name:"mapDelete",title:'<span title="deleted" data-toggle="tooltip">D&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"mapDelete",render:{_:s}},{targets:7,name:"mapSum",title:"Σ&nbsp;&nbsp;",searchable:!1,width:20,className:["text-right","separator-right"].join(" "),data:"mapSum",render:{_:i}},{targets:8,name:"systemCreate",title:'<span title="created" data-toggle="tooltip">C&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"systemCreate",render:{_:s}},{targets:9,name:"systemUpdate",title:'<span title="updated" data-toggle="tooltip">U&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"systemUpdate",render:{_:s}},{targets:10,name:"systemDelete",title:'<span title="deleted" data-toggle="tooltip">D&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"systemDelete",render:{_:s}},{targets:11,name:"systemSum",title:"Σ&nbsp;&nbsp;",searchable:!1,width:20,className:["text-right","separator-right"].join(" "),data:"systemSum",render:{_:i}},{targets:12,name:"connectionCreate",title:'<span title="created" data-toggle="tooltip">C&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"connectionCreate",render:{_:s}},{targets:13,name:"connectionUpdate",title:'<span title="updated" data-toggle="tooltip">U&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"connectionUpdate",render:{_:s}},{targets:14,name:"connectionDelete",title:'<span title="deleted" data-toggle="tooltip">D&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"connectionDelete",render:{_:s}},{targets:15,name:"connectionSum",title:"Σ&nbsp;&nbsp;",searchable:!1,width:20,className:["text-right","separator-right"].join(" "),data:"connectionSum",render:{_:i}},{targets:16,name:"signatureCreate",title:'<span title="created" data-toggle="tooltip">C&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"signatureCreate",render:{_:s}},{targets:17,name:"signatureUpdate",title:'<span title="updated" data-toggle="tooltip">U&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"signatureUpdate",render:{_:s}},{targets:18,name:"signatureDelete",title:'<span title="deleted" data-toggle="tooltip">D&nbsp;&nbsp;</span>',orderable:!1,searchable:!1,width:28,className:["text-right","hidden-xs","hidden-sm"].join(" "),data:"signatureDelete",render:{_:s}},{targets:19,name:"signatureSum",title:"Σ&nbsp;&nbsp;",searchable:!1,width:20,className:["text-right","separator-right"].join(" "),data:"signatureSum",render:{_:i}},{targets:20,name:"totalSum",title:"Σ&nbsp;&nbsp;",searchable:!1,width:20,className:"text-right",data:"totalSum",render:{_:i}}],initComplete:function(e){let a=this.api(),s=c(t);r(s,{tableApi:a,callback:d}),n.initTableCounter(this,["lastLogin:name"])},drawCallback:function(t){this.api().rows().nodes().to$().each(function(t,a){e(e(a).find("."+l.statsLineChartClass)).peity("line",{fill:"transparent",height:18,min:0,width:36})})},footerCallback:function(t,a,s,n,l){let o=this.api(),r=[7,11,15,19,20],d=o.columns(r,{page:"current"}).data();d.each(function(e,t){d[t]=e.reduce(function(e,t){return e+t},0)}),e(r).each(function(t,a){e(o.column(a).footer()).text(i(d[t],"display"))})},data:[]});o.on("order.dt search.dt",function(){o.column(0,{search:"applied",order:"applied"}).nodes().each(function(t,a){let s=a+1,n="";switch(s){case 1:n='<i class="fas fa-fw fa-trophy txt-color txt-color-gold"></i>';break;case 2:n='<i class="fas fa-fw fa-trophy txt-color txt-color-silver"></i>';break;case 3:n='<i class="fas fa-fw fa-trophy txt-color txt-color-bronze"></i>';break;default:n=s+".&nbsp;&nbsp;"}e(t).html(n)})}).draw(),t.find('[data-toggle="tooltip"]').tooltip()},r=(s,n)=>{n.dynamicArea=e("#"+l.statsContainerId+" ."+a.config.dynamicAreaClass),n.dynamicArea.showLoadingAnimation(),e.ajax({type:"POST",url:t.path.getStatisticsData,data:s,dataType:"json",context:n}).done(function(e){this.dynamicArea.hideLoadingAnimation(),this.callback(e,this)}).fail(function(e,t,s){let n=t+" "+s;a.showNotify({title:e.status+": loadStatistics",text:n,type:"warning"})})},d=(t,a)=>{let s=e("#"+l.statsDialogId),n=e("."+l.dialogNavigationClass);n.find('a[data-type="typeId"][data-value="'+t.typeId+'"]').tab("show"),n.find('a[data-type="period"][data-value="'+t.period+'"]').tab("show");let i=s.find("."+l.dialogNavigationPrevClass);i.data("newOffset",t.prev),i.find("span").text("Week "+t.prev.week+", "+t.prev.year),i.css("visibility","visible");let o=s.find("."+l.dialogNavigationNextClass);t.next?(o.data("newOffset",t.next),o.find("span").text("Week "+t.next.week+", "+t.next.year),o.css("visibility","visible")):o.css("visibility","hidden");let r="Week "+t.start.week+", "+t.start.year;"weekly"!==t.period&&(r+=' <small><i class="fas fa-fw fa-minus"></i></small> Week '+t.offset.week+", "+t.offset.year),s.find("."+l.dialogNavigationOffsetClass).data("start",t.start).data("period",t.period).html(r);let d=p(t);a.tableApi.clear(),a.tableApi.rows.add(d).draw()},p=t=>{let a=[],s=t.start.year,n=t.start.week,i=t.weekCount,l=t.yearWeeks;return e.each(t.statistics,function(e,t){let o=function(e){let t=s,a=n,o={mapCreate:[],mapUpdate:[],mapDelete:[],systemCreate:[],systemUpdate:[],systemDelete:[],connectionCreate:[],connectionUpdate:[],connectionDelete:[],signatureCreate:[],signatureUpdate:[],signatureDelete:[],mapSum:0,systemSum:0,connectionSum:0,signatureSum:0};for(let s=0;s<i;s++){let s=t+""+a;if(e.hasOwnProperty(s)){let t=e[s];o.mapCreate.push(t.mapCreate),o.mapSum+=parseInt(t.mapCreate),o.mapUpdate.push(t.mapUpdate),o.mapSum+=parseInt(t.mapUpdate),o.mapDelete.push(t.mapDelete),o.mapSum+=parseInt(t.mapDelete),o.systemCreate.push(t.systemCreate),o.systemSum+=parseInt(t.systemCreate),o.systemUpdate.push(t.systemUpdate),o.systemSum+=parseInt(t.systemUpdate),o.systemDelete.push(t.systemDelete),o.systemSum+=parseInt(t.systemDelete),o.connectionCreate.push(t.connectionCreate),o.connectionSum+=parseInt(t.connectionCreate),o.connectionUpdate.push(t.connectionUpdate),o.connectionSum+=parseInt(t.connectionUpdate),o.connectionDelete.push(t.connectionDelete),o.connectionSum+=parseInt(t.connectionDelete),o.signatureCreate.push(t.signatureCreate),o.signatureSum+=parseInt(t.signatureCreate),o.signatureUpdate.push(t.signatureUpdate),o.signatureSum+=parseInt(t.signatureUpdate),o.signatureDelete.push(t.signatureDelete),o.signatureSum+=parseInt(t.signatureDelete)}else o.mapCreate.push(0),o.mapUpdate.push(0),o.mapDelete.push(0),o.systemCreate.push(0),o.systemUpdate.push(0),o.systemDelete.push(0),o.connectionCreate.push(0),o.connectionUpdate.push(0),o.connectionDelete.push(0),o.signatureCreate.push(0),o.signatureUpdate.push(0),o.signatureDelete.push(0);++a>l[t]&&(a=1,t++)}return o.mapCreate=o.mapCreate.join(","),o.mapUpdate=o.mapUpdate.join(","),o.mapDelete=o.mapDelete.join(","),o.systemCreate=o.systemCreate.join(","),o.systemUpdate=o.systemUpdate.join(","),o.systemDelete=o.systemDelete.join(","),o.connectionCreate=o.connectionCreate.join(","),o.connectionUpdate=o.connectionUpdate.join(","),o.connectionDelete=o.connectionDelete.join(","),o.signatureCreate=o.signatureCreate.join(","),o.signatureUpdate=o.signatureUpdate.join(","),o.signatureDelete=o.signatureDelete.join(","),o}(t.weeks),r={character:{id:e,name:t.name,lastLogin:t.lastLogin},mapCreate:{type:"C",data:o.mapCreate},mapUpdate:{type:"U",data:o.mapUpdate},mapDelete:{type:"D",data:o.mapDelete},mapSum:o.mapSum,systemCreate:{type:"C",data:o.systemCreate},systemUpdate:{type:"U",data:o.systemUpdate},systemDelete:{type:"D",data:o.systemDelete},systemSum:o.systemSum,connectionCreate:{type:"C",data:o.connectionCreate},connectionUpdate:{type:"U",data:o.connectionUpdate},connectionDelete:{type:"D",data:o.connectionDelete},connectionSum:o.connectionSum,signatureCreate:{type:"C",data:o.signatureCreate},signatureUpdate:{type:"U",data:o.signatureUpdate},signatureDelete:{type:"D",data:o.signatureDelete},signatureSum:o.signatureSum,totalSum:o.mapSum+o.systemSum+o.connectionSum+o.signatureSum};a.push(r)}),a},c=t=>{let a={};t.find("."+l.dialogNavigationClass).find("."+l.dialogNavigationListItemClass+".active a").each(function(){let t=e(this);a[t.data("type")]=t.data("value")});let s=t.find("."+l.dialogNavigationOffsetClass),n=s.data("start"),i=s.data("period");return a.period===i&&n&&(a.year=n.year,a.week=n.week),a},g=e=>{let s=!1;switch(e){case"private":Boolean(a.getObjVal(t.mapTypes,e+".defaultConfig.log_activity_enabled"))&&(s=!0);break;case"corporation":Boolean(a.getObjVal(t.mapTypes,e+".defaultConfig.log_activity_enabled"))&&a.getCurrentUserInfo("corporationId")&&(s=!0);break;case"alliance":Boolean(a.getObjVal(t.mapTypes,e+".defaultConfig.log_activity_enabled"))&&a.getCurrentUserInfo("allianceId")&&(s=!0)}return s};e.fn.showStatsDialog=function(){requirejs(["text!templates/dialog/stats.html","mustache"],(t,s)=>{let n=!1,p=a.getMapModule().getActiveMap();if(p){let e=p.data("id"),t=a.getCurrentMapData(e);t&&(n=Boolean(a.getObjVal(t,"config.logging.activity")))}let m=g("private"),h=g("corporation"),u=g("alliance"),f=!1,b=!1,C=!1;h?b=!0:u?C=!0:m&&(f=!0);let y={id:l.statsDialogId,dialogNavigationClass:l.dialogNavigationClass,dialogNavLiClass:l.dialogNavigationListItemClass,enablePrivateTab:m,enableCorporationTab:h,enableAllianceTab:u,activePrivateTab:f,activeCorporationTab:b,activeAllianceTab:C,logActivityEnabled:n,statsContainerId:l.statsContainerId,statsTableId:l.statsTableId,dialogNavigationOffsetClass:l.dialogNavigationOffsetClass,dialogNavigationPrevClass:l.dialogNavigationPrevClass,dialogNavigationNextClass:l.dialogNavigationNextClass},x=s.render(t,y),w=i.dialog({title:"Statistics",message:x,size:"large",show:!1});w.on("show.bs.modal",function(t){let a=e(t.target);o(a)}),w.find('a[data-toggle="tab"]').on("show.bs.tab",function(t,a,s){if(e(t.target).parent().hasClass("disabled"))return!1}),w.find('a[data-toggle="tab"]').on("shown.bs.tab",function(e){let t=c(w),a=w.find("#"+l.statsTableId).DataTable();r(t,{tableApi:a,callback:d})}),w.find("."+l.dialogNavigationPrevClass+", ."+l.dialogNavigationNextClass).on("click",function(){let t=e(this).data("newOffset");if(t){let a=c(w),s=e.extend({},a,t),n=w.find("#"+l.statsTableId).DataTable();r(s,{tableApi:n,callback:d})}}),w.modal("show")})}});
//# sourceMappingURL=stats.js.map
