define(["jquery","app/init","app/util","app/counter","bootbox","app/lib/resize"],(e,t,a,s,o)=>{"use strict";let l=[],r=null,i={},n="pf-task-dialog",d="pf-timestamp-counter",p="pf-task-dialog-status",c="pf-task-dialog-table",g="pf-log-graph",m="pf-module-icon-button",f=()=>{let o=e("#"+n);if(o.length){let l=o.find("."+p);l.destroyTooltips(!0),requirejs(["text!templates/modules/sync_status.html","mustache"],(o,r)=>{let i={timestampCounterClass:d,syncStatus:t.syncStatus,isWebSocket:()=>"webSocket"===a.getSyncType(),isAjax:()=>"ajax"===a.getSyncType()},n=e(r.render(o,i));s.destroyTimestampCounter(l,!0),l.html(n);let p=n.find("."+d);s.initTimestampCounter(p),l.initTooltips({placement:"right"})})}},h=(t,s)=>{i.hasOwnProperty(t)||(i[t]={data:[],graph:null,averageElement:null,updateElement:null}),void 0!==s&&i[t].data.unshift(s),i[t].data.length>30&&(i[t].data=i[t].data.slice(0,30));let o=(e=>{let t={data:[],dataSum:0,average:0};for(let a=0;a<30;a++){let s=0;e[a]&&(s=e[a],t.dataSum=Number((t.dataSum+s).toFixed(2))),t.data.push({x:a,y:s})}return t.average=Number((t.dataSum/e.length).toFixed(2)),t})(i[t].data);if(i[t].graph){let s=i[t].averageElement,l=i[t].updateElement,r=a.getCurrentTriggerDelay(t,0);r&&(l[0].textContent=" delay: "+r.toFixed(2)+" ms"),i[t].graph.options.goals=[o.average],s[0].textContent="avg. "+o.average.toFixed(2)+" ms";let n=u(t,o.average),d=a.getLogInfo(n,"class");s.hasClass(d)||(s.removeClass().addClass("pull-right txt-color "+d),"warning"===n?(i[t].graph.options.goalLineColors=["#e28a0d"],e(document).setProgramStatus("slow connection")):i[t].graph.options.goalLineColors=["#5cb85c"]),i[t].graph.setData(o.data)}return o.data},u=(e,a)=>{let s="info";return a>t.timer[e].EXECUTION_LIMIT&&(s="warning"),s},x=e=>{let t="";switch(e){case"client":t="fa-user";break;case"server":t="fa-download"}return t};return{init:()=>{e(window).on("pf:syncStatus",()=>{f()}),e(window).on("pf:log",(e,t,s)=>{if(s&&s.duration&&s.description){let e=s.description,o=s.duration,i=s.type;h(t,o);let n=a.getServerTime(),d=n.getTime(),p=n.toLocaleTimeString("en-US",{hour12:!1}),c={status:u(t,o),timestamp:d,timestampFormatted:p,duration:o,description:e,logType:i,key:t};r?r.row.add(c).draw(!1):l.push(c)}l.length>=150&&(r?r.rows(0,{order:"index"}).remove().draw(!1):l.shift()),r&&(l=r.rows({order:"index"}).data())})},showDialog:()=>{requirejs(["text!templates/dialog/task_manager.html","mustache"],function(t,s){let d={id:n,dialogDynamicAreaClass:a.config.dynamicAreaClass,taskDialogStatusAreaClass:p,taskDialogLogTableAreaClass:c},y=e(s.render(t,d)),b=y.find(".row"),w=y.find("."+c),T=e("<table>",{class:["compact","stripe","order-column","row-border"].join(" ")});w.append(T),r=T.DataTable({dom:'<"flex-row flex-between"<"flex-col"l><"flex-col"B><"flex-col"fS>><"flex-row"<"flex-col flex-grow"tr>><"flex-row flex-between"<"flex-col"i><"flex-col"p>>',buttons:{name:"tableTools",buttons:[{extend:"copy",tag:"a",className:m,text:'<i class="fas fa-fw fa-copy"></i> copy',exportOptions:{orthogonal:"export"}},{extend:"csv",tag:"a",className:m,text:'<i class="fas fa-fw fa-download"></i> csv',exportOptions:{orthogonal:"export"}}]},paging:!0,ordering:!0,order:[1,"desc"],hover:!1,pageLength:10,lengthMenu:[[5,10,25,50,100,-1],[5,10,25,50,100,"All"]],data:l,language:{emptyTable:"No entries",zeroRecords:"No entries found",lengthMenu:"Show _MENU_",info:"Showing _START_ to _END_ of _TOTAL_ entries"},columnDefs:[{targets:0,name:"status",title:'<i class="fas fa-tag"></i>',width:18,searchable:!1,class:["text-center"].join(" "),data:"status",render:{display:(e,t,s,o)=>'<i class="fas fa-fw fa-circle txt-color '+a.getLogInfo(e,"class")+'"></i>'}},{targets:1,name:"time",title:'<i class="far fa-fw fa-clock"></i>',width:50,searchable:!0,class:"text-right",data:"timestamp",render:{display:(e,t,a,s)=>a.timestampFormatted}},{targets:2,name:"duration",title:'<i class="fas fa-fw fa-history"></i>',width:35,searchable:!1,class:"text-right",data:"duration",render:{display:(e,t,s,o)=>{let l=u(s.key,e);return'<span class="txt-color '+a.getLogInfo(l,"class")+'">'+e+"<small>ms</small></span>"}}},{targets:3,name:"description",title:"description",searchable:!0,data:"description"},{targets:4,name:"logType",title:"type",width:40,searchable:!0,class:["text-center"].join(" "),data:"logType",render:{display:(e,t,a,s)=>'<i class="fas '+x(e)+'"></i>'}},{targets:5,name:"process",title:"Prozess-ID",width:80,searchable:!1,class:"text-right",data:"key"}]});let S=o.dialog({title:"Task-Manager",message:y,size:"large",buttons:{close:{label:"close",className:"btn-default"}}});S.on("shown.bs.modal",function(t){f();let s=e=>Math.round(e)+"ms";for(let t in i)if(i.hasOwnProperty(t)){let o=e("<div>",{class:["col-md-6"].join(" ")}),l=e("<div>",{class:g}),r=e("<div>",{class:a.config.dynamicAreaClass}).append(l),n=e("<h4>",{text:t}).prepend(e("<span>",{class:["txt-color","txt-color-grayLight"].join(" "),text:"Prozess-ID: "})),d=e("<small>",{class:["txt-color","txt-color-blue","pull-right"].join(" ")});n.append(d).append("<br>");let p=e("<small>",{class:"pull-right"});n.append(p),o.append(n),o.append(r),r.showLoadingAnimation(),b.append(o),i[t].averageElement=p,i[t].updateElement=d,i[t].graph=Morris.Area({element:l,data:[],xkey:"x",ykeys:["y"],labels:[t],lineColors:["#375959"],lineWidth:2,pointSize:3,pointFillColors:["#477372"],pointStrokeColors:["#313335"],ymin:0,smooth:!1,hideHover:!0,parseTime:!1,postUnits:"ms",yLabelFormat:s,goals:[],goalStrokeWidth:1,goalLineColors:["#66c84f"],grid:!0,gridTextColor:"#63676a",gridTextSize:9,gridTextFamily:'Arial, "Oxygen Bold"',gridTextWeight:"bold",gridStrokeWidth:.3,resize:!0,dataLabels:!1,hoverReversed:!0,behaveLikeLine:!0,fillOpacity:.5,belowArea:!0,areaColors:["#3c3f41"],padding:8}),h(t),r.hideLoadingAnimation()}}),S.on("hide.bs.modal",function(t){Object.entries(i).forEach(([e,t])=>{t.graph&&(t.graph.destroy(),delete i[e].graph)}),r.destroy(!0),r=null,e(this).off("hide.bs.modal")})})}}});
//# sourceMappingURL=logging.js.map
