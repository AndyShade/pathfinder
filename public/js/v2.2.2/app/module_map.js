define(["jquery","app/init","app/util","app/map/map","app/map/util","app/lib/eventHandler","app/lib/svg","sortable","module/base","module/system_info","module/system_graph","module/system_signature","module/system_route","module/system_intel","module/system_killboard","module/global_thera","module/connection_info","app/counter"],(e,t,a,s,l,n,o,r,i,d,p,m,c,u,g,b,f)=>{"use strict";let h={mapTabElementId:"pf-map-tab-element",mapTabIdPrefix:"pf-map-tab-",mapTabClass:"pf-map-tab",mapTabIconClass:"pf-map-tab-icon",mapTabLinkTextClass:"nav-tabs-link",mapTabSharedIconClass:"pf-map-tab-shared-icon",mapTabContentWrapperClass:"pf-map-tab-content-wrapper",moduleClass:"pf-module",moduleSpacerClass:"pf-module-spacer",moduleCollapsedClass:"collapsed",sortableHandleClass:"pf-sortable-handle",sortableDropzoneClass:"pf-sortable-dropzone",sortableGhostClass:"pf-sortable-ghost",sortableChosenClass:"pf-sortable-chosen",editableSettingsClass:"pf-editable-settings",editableHeadlineClass:"pf-editable-headline",editableToggleClass:"pf-editable-toggle",editableToggleItemClass:"pf-editable-toggle-item",editableToggleSvgClass:"pf-editable-toggle-svg",editableToggleBtnClass:"pf-editable-toggle-btn",mapTabContentLayoutColumnOptions:["grid-2","grid-3"],mapTabContentLayoutOrientationOptions:["left","right"],defaultMapTabContentCols:"grid-3",defaultMapTabContentOrientation:"right"},C=!1;e.fn.getActiveMap=function(){let t=e(this).find(".active."+a.config.mapTabContentClass+" ."+a.config.mapClass);return t.length||(t=!1),t};let y=()=>new Promise(e=>{let s=[d,p,m,c,u,g,b,f],l=a.getObjVal(t,"plugin.modules");l===Object(l)?requirejs(Object.values(l),(...t)=>{s.push(...t),e(s)},t=>{console.error(t.message),e(s)}):e(s)}),T=(e,t=!1,a="scope")=>e.filter(e=>!t||(Array.isArray(t)?t.includes(e[a]):e[a]===t)),v=(e,t,s)=>{return new Promise(l=>{a.getLocalStore("map").getItem(s.mapId).then(n=>{let o=a.getObjVal(n,"modulesDisabled")||[];e=e.filter(e=>!o.includes(e.name));let r=!1;for(let t of e)"system"===t.scope&&t.fullDataUpdate&&(r=!0);let i=[];r&&i.push(a.request("GET","System",s.payload.id,{mapId:s.mapId})),i.push((l=>{let n=[];for(let o of e){let e=o.sortArea||"a",r=o.position||0;for(let t of a.config.mapTabContentAreaAliases){let a="modules_area_"+t;if(l&&l[a]){let s=l[a].indexOf(o.name);if(-1!==s){r=s+1,e=t;break}}}let i=t.getElementsByClassName(a.getMapTabContentAreaClass(e));i.length?(i=i[0],n.push(I(o,i,r,s.mapId,s.payload))):console.warn("renderModules() failed for %o. GridArea class=%o not found",o.name,a.getMapTabContentAreaClass(e))}return Promise.all(n)})(n)),Promise.all(i).then(e=>{let s,n=[];if(r){let t=e.shift();s=a.getObjVal(t,"data")}if(s){let a=e.shift().map(e=>e.data.module).filter(e=>"system"===e.scope&&e.fullDataUpdate);n.push(S(a,t,{payload:s}))}Promise.all(n).then(e=>l(e))})})})},I=(a,s,l,n,o)=>{return new Promise((r,i)=>{E(a,s,!1).then(i=>((a,s,l,n,o)=>{let i={action:"renderModule",data:{module:a}};((e,t)=>{for(let a of e.querySelectorAll("."+t.className+'-spacer[data-module="'+t.name+'"]'))a.remove()})(s,a);let d=new a({position:l}).handle("render",n,o);if(!(d instanceof HTMLElement))return void r(i);let p=$(s,"."+a.className,l),m=[...s.getElementsByClassName(a.className)].find((e,t)=>++t===p);m?m.insertAdjacentElement("afterend",d):s.prepend(d),e(d).velocity({opacity:[1,0],translateY:[0,20],translateZ:0},{duration:t.animationSpeed.mapModule,easing:"easeOutSine",complete:e=>{e[0].getData("module").handle("init"),r(i)}})})(a,s,l,n,o))})},S=(e,t,a)=>{let s=[];for(let l of e)s.push(M(l,t,a.payload));return Promise.all(s)},M=(e,t,a)=>{return new Promise(s=>{let l=[],n=t.querySelectorAll("."+e.className+'[data-module="'+e.name+'"]');for(let e of n)l.push(e.getData("module").handle("update",a));Promise.all(l).then(e=>s(e))})},L=(e,t)=>{let a=[];for(let s of e)a.push(E(s,t));return Promise.all(a)},E=(t,a,s=!1)=>{let l=a=>{return new Promise((l,n)=>{let o={action:"removeModule",data:{}},r=a.getData("module");r instanceof i?(r.handle("beforeHide"),e(a).velocity("reverse",{complete:e=>{if((e=e[0]).getData("module").handle("beforeDestroy"),s){let a=document.createElement("div");a.classList.add(t.className+"-spacer"),a.setAttribute("data-module",t.name),a.style.height=e.offsetHeight+"px",e.insertAdjacentElement("afterend",a)}e.remove(),l(o)}})):(console.warn("Invalid module. Instance of %O expected for %o",i,a),l(o))})};return new Promise(e=>{let s=[],n=a.querySelectorAll("."+t.className+'[data-module="'+t.name+'"]');for(let e of n)s.push(l(e));Promise.all(s).then(t=>e(t))})},A=e=>{let l=t.performanceLogging.keyClientUserData;a.timeStart(l);return new Promise(t=>{if(!1!==e){let t=e.data("id"),l=a.getCurrentMapUserData(t);l&&(e.trigger("pf:updateLocal",l),s.updateUserData(e,l))}t()}).then(e=>{let t=a.timeStop(l);a.log(l,{duration:t,type:"client",description:"update users"})})},O=(s,l)=>{let o={invertSwap:!0,animation:t.animationSpeed.mapModule,handle:"."+h.sortableHandleClass,draggable:"."+h.moduleClass,ghostClass:h.sortableGhostClass,chosenClass:h.sortableChosenClass,scroll:!0,scrollSensitivity:50,scrollSpeed:20,dataIdAttr:"data-module",sort:!0,store:{get:function(e){return[]},set:function(e){let t="modules_"+e.options.group.name;a.getLocalStore("map").setItem(`${l}.${t}`,e.toArray())}},onStart:function(e){this.save();let t=e.item.getData("module").config.sortTargetAreas||[];s.querySelectorAll("."+a.getMapTabContentAreaClass()).forEach(e=>{t.includes(e.getAttribute("data-area"))?e.classList.add(h.sortableDropzoneClass):e.classList.remove(h.sortableDropzoneClass)})},onEnd:function(e){s.querySelectorAll("."+a.getMapTabContentAreaClass()).forEach(e=>{e.classList.remove(h.sortableDropzoneClass)})}};["onChoose","onStart","onEnd","onAdd","onUpdate","onSort","onRemove","onChange","onUnchoose"].forEach(e=>{o[e]=function(t){let l=(t.item||t.related).getData("module");switch(e){case"onStart":this.save();let t=l.config.sortTargetAreas||[];s.querySelectorAll("."+a.getMapTabContentAreaClass()).forEach(e=>{t.includes(e.getAttribute("data-area"))?e.classList.add(h.sortableDropzoneClass):e.classList.remove(h.sortableDropzoneClass)});break;case"onEnd":s.querySelectorAll("."+a.getMapTabContentAreaClass()).forEach(e=>{e.classList.remove(h.sortableDropzoneClass)})}l.handle("onSortableEvent",e,t)}}),s.querySelectorAll("."+a.getMapTabContentAreaClass()).forEach(e=>{r.create(e,Object.assign({},o,{group:{name:"area_"+e.getAttribute("data-area"),pull:(e,t,a,s)=>{return(a.getData("module").config.sortTargetAreas||[]).map(e=>"area_"+e)},put:(e,t,a,s)=>!0}}))});n.addEventListener(s,"click.toggleModuleHeight",t=>{if(t.target.classList.contains(h.moduleClass)&&t.layerX<=9&&t.layerY<=9&&t.layerX>=0&&t.layerY>=0){t.stopPropagation();let a=t.target;a.dataset.origHeight||(a.dataset.origHeight=a.offsetHeight),a.classList.contains(h.moduleCollapsedClass)?e(a).velocity("finish").velocity({height:[a.dataset.origHeight+"px",[400,15]]},{duration:400,easing:"easeOutSine",complete:e=>{e[0].classList.remove(h.moduleCollapsedClass),delete e[0].dataset.origHeight,e[0].style.height=null}}):e(a).velocity("finish").velocity({height:["38px",[400,15]]},{duration:400,easing:"easeOutSine",complete:e=>{e[0].classList.add(h.moduleCollapsedClass)}})}},{passive:!1})},P=()=>{let t=Object.assign(document.createElement("div"),{id:h.mapTabElementId}),s=[(e=>{let t=document.createElement("ul");return t.id=a.config.mapTabBarIdPrefix+e.area,t.dataset.area=e.area,t.classList.add("nav","nav-tabs",a.config.mapTabBarClass),t.setAttribute("role","tablist"),t})({area:"left"})],l=[(e=>{let t=document.createElement("div");return t.dataset.target=a.config.mapTabBarIdPrefix+e.area,t.classList.add("tab-content",h.mapTabContentWrapperClass),t})({area:"left"})];return t.append(...s,...l),s.forEach(e=>D(e)),l.forEach(t=>(t=>{e(t).on("pf:renderGlobalModules",`.${a.config.mapTabContentClass}`,function(e,t){y().then(e=>T(e,"global")).then(a=>v(a,e.target,t))}),e(t).on("pf:renderSystemModules",`.${a.config.mapTabContentClass}`,function(e,t){y().then(e=>T(e,"system")).then(a=>v(a,e.target,t))}),e(t).on("pf:removeSystemModules",`.${a.config.mapTabContentClass}`,e=>{y().then(e=>T(e,"system")).then(t=>L(t,e.target))}),e(t).on("pf:renderConnectionModules",`.${a.config.mapTabContentClass}`,(e,t)=>{y().then(e=>T(e,"connection")).then(a=>v(a,e.target,t))}),e(t).on("pf:removeConnectionModules",`.${a.config.mapTabContentClass}`,e=>{y().then(e=>T(e,"connection")).then(t=>L(t,e.target))}),e(t).on("pf:updateGlobalModules",`.${a.config.mapTabContentClass}`,(e,t)=>{y().then(e=>T(e,"global")).then(a=>S(a,e.target,t))}),e(t).on("pf:updateSystemModules",`.${a.config.mapTabContentClass}`,(e,t)=>{y().then(e=>T(e,!0,"fullDataUpdate")).then(a=>S(a,e.target,t))}),e(t).on("pf:updateRouteModules",`.${a.config.mapTabContentClass}`,(e,t)=>{y().then(e=>T(e,"SystemRouteModule","name")).then(a=>S(a,e.target,t))})})(t)),t},$=(t,a,s)=>{let l=0;return s>0&&e(t).children(a).each((e,t)=>{if(l=e+1,(parseInt(t.getAttribute("data-position"))||0)>=s)return l--,!1}),l},D=n=>{r.create(n,{group:{name:"tabs_"+n.dataset.area,pull:(e,t,a,s)=>["left","right"].map(e=>"tabs_"+e),put:(e,t,a,s)=>!0},animation:t.animationSpeed.mapModule,handle:"."+h.sortableHandleClass,draggable:"."+h.mapTabClass+":not(.noSort)",ghostClass:h.sortableGhostClass,scroll:!1,dataIdAttr:"data-sort-id",sort:!0,direction:"horizontal",store:{get:function(e){return[]},set:function(e){let t=`map_${e.options.group.name}`;a.getLocalStore("character").setItem(`${a.getCurrentCharacterId()}.${t}`,e.toArray())}},onStart:function(e){this.save(),[...document.getElementsByClassName(a.config.mapTabBarClass)].forEach(e=>{e.classList.add(h.sortableDropzoneClass)})},onEnd:function(e){[...document.getElementsByClassName(a.config.mapTabBarClass)].forEach(e=>{e.classList.remove(h.sortableDropzoneClass)})}});e(n).on("click","a",t=>{t.preventDefault();let s=t.currentTarget,n=s.dataset.tabType,o=parseInt(s.dataset.mapId)||0;if("map"===n&&o>0){if(!1===C){let t=e(document.getElementById(h.mapTabElementId)).getActiveMap();o!==t.data("id")&&(C=!0,t.data("frozen",!0),l.visualizeMap(t,"hide").then(a=>{C=((t,a)=>(e(a).tab("show"),t.data("frozen",!1),!1))(t,s)}))}}else t.stopPropagation(),"add"===n?a.triggerMenuAction(document,"ShowMapSettings",{tab:"new"}):"settings"===n?e(s).editable("show"):console.error("Invalid tabType = %o for %O",n,s)}),e(n).on("show.bs.tab","a",e=>{let t=e.currentTarget,a=t.dataset.tabType,s=parseInt(t.dataset.mapId)||0;"map"===a&&s>0&&B(n,s)}),e(n).on("shown.bs.tab","a",function(t){let n=t.currentTarget,o=parseInt(n.dataset.mapId)||0,r=parseInt(n.dataset.defaultSystemId)||0,i=a.getCurrentMapData(o),d=document.getElementById(h.mapTabIdPrefix+o);if(!1!==i&&d){let t=d.querySelector(`.${a.getMapTabContentAreaClass("map")}`);s.loadMap(t,i,{showAnimation:!0}).then(t=>{let a=t.data.mapConfig,s=a.map.getContainer(),n=s.closest(".mCustomScrollbar");e(n).mCustomScrollbar("update"),t.isFirstLoad&&l.showMapInfo(a.map);let o=s.querySelector(`.${l.config.systemActiveClass}`);if(o)l.setSystemActive(a.map,e(o));else if(r){let t=l.getSystemId(a.config.id,r),n=s.querySelector(`#${t}`);n&&l.showSystemInfo(a.map,e(n))}history.pushState&&history.pushState({},"",l.getMapDeeplinkUrl(a.config.id)),A(e(s))})}}),e(n).on("hide.bs.tab","a",t=>{let s=t.currentTarget,l=t.relatedTarget,n=parseInt(s.dataset.mapId)||0;if((parseInt(l.dataset.mapId)||0)>0){let t=document.getElementById(h.mapTabIdPrefix+n).querySelector(`.${a.getMapTabContentAreaClass("map")}`);e(t).mCustomScrollbar("disable",!1)}})},w=(t,s)=>new Promise(l=>{t.dataset.mapId=s.id,a.getObjVal(s,"updated.updated")&&(t.dataset.updated=s.updated.updated),t.setAttribute("href",`#${h.mapTabIdPrefix}${s.id}`);let n=t.querySelector(`.${h.mapTabIconClass}`);n.classList.remove(...n.classList),n.classList.add(h.mapTabIconClass,"fas","fa-fw",s.icon);let o=t.querySelector(`.${h.mapTabSharedIconClass}`);o.style.display="none",s.access&&(s.access.character.length>1||s.access.corporation.length>1||s.access.alliance.length>1)&&(o.style.display="initial");let r=t.querySelector(`.${h.mapTabLinkTextClass}`);r.textContent=s.name;let i=t.parentNode,d=[h.mapTabClass,s.type.classTab];!1===s.draggable&&d.push("noSort"),i.classList.contains("active")&&d.push("active"),i.classList.remove(...i.classList),i.classList.add(...d),void 0!==s.type.name&&r.setAttribute("title",`${s.type.name} map`);e(i.querySelector("[title]")).tooltip({placement:"bottom",container:"body",trigger:"hover",delay:150}).tooltip("fixTitle"),l({action:"update",data:{mapId:s.id,mapName:s.name}})}),j=(e,t)=>{return new Promise(s=>{a.getLocalStore("character").getItem(a.getCurrentCharacterId()).then(l=>{let n=t.id||0,o=t.area||"left",r=t.position||0,i=t.tabType||"map",d=[i,n].join("_");if(l)for(let e of["left","right"]){let t=(a.getObjVal(l,`map_tabs_${e}`)||[]).indexOf(d);if(-1!==t){r=t+1,o=e;break}}let p=a.config.mapTabBarIdPrefix+o,m=e.querySelector("#"+p),c=e.querySelector(`.${h.mapTabContentWrapperClass}[data-target="${p}"]`),u=((e,t,a)=>{let s=document.createElement("li");s.dataset.sortId=a,s.setAttribute("role","presentation");let l=document.createElement("a");return l.dataset.tabType=t,l.setAttribute("role","tab"),e>0&&l.append(Object.assign(document.createElement("i"),{className:h.sortableHandleClass})),l.append(Object.assign(document.createElement("i"),{className:h.mapTabIconClass})),l.append(Object.assign(document.createElement("span"),{className:h.mapTabLinkTextClass})),l.append(Object.assign(document.createElement("i"),{className:[h.mapTabSharedIconClass,"fas","fa-fw","fa-share-alt"].join(" "),title:"shared map"})),s.append(l),s})(n,i,d),g=(e=>{let t=document.createElement("div");return t.id=h.mapTabIdPrefix+parseInt(e),t.classList.add(a.config.mapTabContentClass,"tab-pane"),t.dataset.mapId=e,t})(n);u.dataset.position=String(r);let b=$(m,`.${h.mapTabClass}`,r),f=m.querySelector(`li:nth-child(${b})`);f?f.insertAdjacentElement("afterend",u):m.insertAdjacentElement("afterbegin",u),w(u.querySelector("a"),t),n&&(g.append(...(()=>{let e=[];for(let t of a.config.mapTabContentAreaAliases){let s=document.createElement("div");s.classList.add(a.getMapTabContentAreaClass(),a.getMapTabContentAreaClass(t)),s.setAttribute("data-area",t),e.push(s)}return e})()),O(g,n)),c.insertAdjacentElement("beforeend",g),s({action:"add",data:{mapId:n,mapName:t.name}})})})},q=(t,a)=>{return new Promise(s=>{let n=t.querySelector(`a[href="#${h.mapTabIdPrefix+a}"]`),o="";if(n){o=n.querySelector(`.${h.mapTabLinkTextClass}`).textContent;let s=n.parentNode,r=t.querySelector(`#${h.mapTabIdPrefix+a}`);e(s).remove(),e(r).remove(),l.clearMapInstance(a)}s({action:"delete",data:{mapId:a,mapName:o}})})},x=()=>{let e=[],t=(()=>{let e=window.location.pathname.split("/");return e.pop()||e.pop()})();if(t.length)try{e=t.split("_").map(e=>parseInt(atob(decodeURIComponent(e)))||0)}catch(e){}return e},N=t=>{let s=e=>t.querySelector(`.${h.mapTabClass} > a[data-map-id="${e}"]`);return new Promise(l=>{a.getLocalStore("character").getItem(a.getCurrentCharacterId()).then(a=>{let n=null,o=x(),r=o[0]||0,i=o[1]||0;r&&(n=s(r),i&&n&&(n.dataset.defaultSystemId=i)),!n&&a&&a.defaultMapId&&(n=s(a.defaultMapId)),n||(n=t.querySelector(`.${h.mapTabClass} > a`)),n&&e(n).tab("show"),l()})})},B=(e,t)=>{a.getLocalStore("character").setItem(`${a.getCurrentCharacterId()}.defaultMapId`,t),k(t)},k=t=>{let s=document.getElementById(h.mapTabElementId);if(!s||!t)return;let r=(e,t)=>{h.mapTabContentLayoutColumnOptions.forEach(a=>e.classList.toggle(a,a===t.columns)),h.mapTabContentLayoutOrientationOptions.forEach(a=>e.classList.toggle(a,a===t.orientation))},d=(e=h.defaultMapTabContentCols,t=h.defaultMapTabContentOrientation)=>`#pf-svg-${e}-${t}`;Promise.all([y(),a.getLocalStore("map").getItem(t)]).then(p=>{let m=p[0],c=p[1],u=a.getObjVal(c,"modulesDisabled"),g=Object.assign({},{columns:h.defaultMapTabContentCols,orientation:h.defaultMapTabContentOrientation},a.getObjVal(c,"layout"));r(s,g);let b=Array(i.scopeOrder.length).fill(0),f=m.sort((e,t)=>e.getOrderPrio()-t.getOrderPrio()).map(e=>({value:e.name,text:e.label,metaData:{scope:e.scope,orderPrio:e.getOrderPrio(),prioCount:++b[e.getOrderPrio()],isPlugin:e.isPlugin}}));u||(u=f.reduce((e,t)=>(t.metaData.isPlugin&&e.push(t.value),e),[]),a.getLocalStore("map").setItem(`${t}.modulesDisabled`,u));let C=s.querySelector(`.${h.mapTabClass} > a[data-tab-type="settings"]`);if(C){C=e(C);let p=(e,t=[])=>e.filter(e=>!t.includes(e.value)).map(e=>e.value),c=p(f,u);C.data("editable")?(C.editable("setValue",c),C.editable("option","pk",t),C.editable("option","pfLayoutCurrent",g)):(C.on("shown",(e,t)=>{let l=a.getObjVal(t,"options.pfLayoutCurrent"),p=t.container.$form[0].querySelector(`.${h.editableSettingsClass}`),m=Object.assign(document.createElement("div"),{className:[h.editableToggleClass].join(" ")}),c=h.mapTabContentLayoutColumnOptions.map((e,t)=>{let a=e===l.columns,s=a?l.orientation:void 0,n=o.newSymbolSvg(d(e,s));n.classList.add("btn","btn-default",h.editableToggleSvgClass),n.dataset.value=e,a&&n.classList.add("active");let r=Object.assign(document.createElement("div"),{className:["btn","btn-xs","btn-default",h.editableToggleBtnClass].join(" ")});r.append(Object.assign(document.createElement("i"),{className:["fas","fa-rotate-90","fa-retweet"].join(" ")})),r.dataset.value="left",a||r.classList.add("disabled"),s===r.dataset.value&&r.classList.add("active");let i=Object.assign(document.createElement("div"),{className:["btn-group",h.editableToggleItemClass].join(" ")});return i.append(...t%2?[n,r]:[r,n]),i});m.append(...c),p.insertAdjacentElement("beforebegin",m),n.addEventListener(m,"click.toggleSelect",e=>{e.stopPropagation();let n=e.target.closest(".btn");n&&!n.classList.contains("disabled")&&[...e.currentTarget.getElementsByClassName(h.editableToggleItemClass)].forEach(n=>{let i=n.querySelector(`.${h.editableToggleSvgClass}`),p=n.querySelector(`.${h.editableToggleBtnClass}`);if(n===e.target.closest(`.${h.editableToggleItemClass}`)){if(i===e.target.closest(`.${h.editableToggleSvgClass}`)&&(i.classList.toggle("active",!0),p.classList.toggle("disabled",!1)),p===e.target.closest(`.${h.editableToggleBtnClass}`)&&(p.classList.toggle("active"),o.updateSymbolSvg(i,d(i.dataset.value,p.classList.contains("active")?p.dataset.value:void 0))),i.classList.contains("active")){let e=a.getObjVal(t,"options.pk");a.getLocalStore("map").setItem(`${e}.layout`,{columns:i.dataset.value,orientation:p.classList.contains("active")?p.dataset.value:h.defaultMapTabContentOrientation}).then(e=>{r(s,e),l=e,t.option("pfLayoutCurrent",e)})}}else o.updateSymbolSvg(i,d(i.dataset.value)),i.classList.toggle("active",!1),p.classList.toggle("active",!1),p.classList.toggle("disabled",!0)})},{passive:!1}),p.childNodes.forEach((e,t)=>{1===f[t].metaData.prioCount&&(e.classList.add(h.editableHeadlineClass),e.setAttribute("data-count",b[f[t].metaData.orderPrio]),e.setAttribute("data-headline",i.scopeOrder[f[t].metaData.orderPrio]))})}),C.on("save",{sourceOptions:f},(t,s)=>{let n=e(t.target).data("editable"),o=a.getObjVal(n,"options.pk"),r=n.value,i=p(t.data.sourceOptions,s.newValue||[]),d=l.getMapInstance(o),c=document.getElementById(h.mapTabIdPrefix+o);a.getLocalStore("map").setItem(`${o}.modulesDisabled`,i).then(e=>{let t=T(m,r.diff(s.newValue),"name"),n=T(m,s.newValue.diff(r),"name");L(t,c).then(e=>{let t=n.filter(e=>"global"===e.scope),s=n.filter(e=>"system"===e.scope),r=n.filter(e=>"connection"===e.scope);t.length&&v(t,c,{mapId:o,payload:null}),s.length&&a.getCurrentSystemData(o)&&v(s,c,{mapId:o,payload:a.getCurrentSystemData(o)}),r.length&&l.getConnectionsByType(d,"state_active").length&&v(r,c,{mapId:o,payload:l.getConnectionsByType(d,"state_active")})})})}),C.editable({toggle:"manual",mode:"popup",type:"checklist",showbuttons:!1,onblur:"submit",highlight:!1,title:"layout settings",placement:"left",pk:t,value:c,source:f,emptyclass:"",emptytext:"",display:function(e,t){e&&t&&e.length<t.length?this.dataset.badge=String(e.length):delete this.dataset.badge},tpl:`<div class="editable-checklist ${h.editableSettingsClass}"></div>`,pfLayoutCurrent:g}))}})};return{updateTabData:w,updateMapModule:e=>{let n=t.performanceLogging.keyClientMapData;a.timeStart(n);return new Promise(t=>{let n=document.getElementById(h.mapTabElementId),o=a.getCurrentMapData();if(0===o.length)(e=>{let t=[],s=document.getElementById(h.mapTabElementId);if(s){let l=a.getMapTabLinkElements(e);for(let e=0;e<l.length;e++){let a=l[e],n=parseInt(a.dataset.mapId)||0;n>0&&t.push(q(s,n))}}return Promise.all(t)})(e).then(e=>{a.triggerMenuAction(document,"ShowMapSettings",{tab:"new"})}).then(e=>t());else if(n){let l=[],r=[],i=[],d=e=>{a.showNotify({title:"Map removed",text:e.data.mapName+" deleted",type:"warning"})},p=e=>{a.showNotify({title:"Map added",text:e.data.mapName+" added",type:"success"})},m=a.getMapTabLinkElements(e),c=[];for(let e=0;e<m.length;e++){let t=m[e],s=parseInt(t.dataset.mapId)||0;if(s>0){let e=a.getCurrentMapData(s);!1!==e?(c.push(s),e.config.updated.updated>(parseInt(t.dataset.updated)||0)&&i.push(w(t,e.config))):r.push(q(n,s).then(d))}}for(let e of o)-1===c.indexOf(e.config.id)&&l.push(j(n,e.config).then(p));let u=l.concat(r,i);Promise.all(u).then(e=>{let t=a.getMapModule().getActiveMap();if(!t)return N(n);{let e=t.data("id"),l=a.getCurrentMapData(e);if(!1!==l){let t=document.getElementById(h.mapTabIdPrefix+e).querySelector(`.${a.getMapTabContentAreaClass("map")}`);return s.loadMap(t,l,{})}console.error("No active map found!")}}).then(e=>t())}else{let a=[];n=P(),e.prepend(n);for(let e=0;e<o.length;e++){let t=o[e];a.push(j(n,t.config))}let s={id:0,type:{classTab:l.getInfoForMap("standard","classTab"),name:"new"},icon:"fa-plus",name:"add",area:"left",tabType:"add",position:90},r={id:0,type:{classTab:l.getInfoForMap("standard","classTab")},icon:"fa-tv",name:"",area:"left",tabType:"settings",position:100,draggable:!1};a.push(j(n,s)),a.push(j(n,r)),Promise.all(a).then(e=>N(n)).then(e=>t())}}).then(e=>{let t=a.timeStop(n);a.log(n,{duration:t,type:"client",description:"update map"})})},updateActiveMapUserData:t=>new Promise(a=>{let s=e(t).getActiveMap();A(s).then(()=>a())}),updateSystemModulesData:(t,s)=>{if(s){let t=a.getCurrentSystemData(s.mapId);if(t&&s.id===t.id){let t=document.getElementById(h.mapTabIdPrefix+s.mapId);e(t).trigger("pf:updateSystemModules",{payload:s})}}},getMapModuleDataForUpdate:(e,t=["hasId","hasChanged"])=>{let l=[];return[...e.getElementsByClassName(a.config.mapClass)].forEach(e=>{let n=s.getMapDataForSync(e,t);n&&((a.getObjVal(n,"data.systems")||[]).length||(a.getObjVal(n,"data.connections")||[]).length)&&l.push(n)}),l}}});
//# sourceMappingURL=module_map.js.map
