define(["jquery","app/init","app/util","app/counter","app/logging","mustache","app/map/util","app/map/contextmenu","slidebars","text!templates/layout/header_map.html","text!templates/layout/footer_map.html","dialog/notification","dialog/stats","dialog/map_info","dialog/account_settings","dialog/manual","dialog/shortcuts","dialog/map_settings","dialog/system_effects","dialog/jump_info","dialog/delete_account","dialog/credit","xEditable","app/module_map"],(e,t,a,o,n,i,s,r,l,c,d)=>{"use strict";let g={pageMenuClass:"pf-menu",pageMenuLeftClass:"pf-menu-left",pageMenuRightClass:"pf-menu-right",pageClass:"pf-site",pageHeaderId:"pf-head",headClass:"pf-head",headMenuClass:"pf-head-menu",headMapClass:"pf-head-map",headUserCharacterClass:"pf-head-user-character",userCharacterImageClass:"pf-head-user-character-image",headActiveUsersClass:"pf-head-active-users",headProgramStatusClass:"pf-head-program-status",headMaxLocationHistoryBreadcrumbs:3,footerLicenceLinkClass:"pf-footer-licence",footerClockClass:"pf-footer-clock",menuHeadMenuLogoClass:"pf-head-menu-logo",systemSignatureModuleClass:"pf-system-signature-module",systemIntelModuleClass:"pf-system-intel-module"},u=0,p=!1,m=e=>"list-group-item"+(["info","danger","warning"].includes(e)?`-${e}`:""),f=e=>{e.initTooltips({placement:"bottom",delay:{show:500,hide:0}})},h=t=>{let a=e("<div>",{class:"list-group"});for(let o of t){if(!o)continue;let t;switch(o.type){case"button":let a=[m(),m(o.btnType)];o.class&&a.push(o.class),t=e("<a>",{id:o.id||void 0,class:a.join(" "),href:o.href||void 0,html:"&nbsp;&nbsp;"+o.label}),o.group&&t.attr("data-group",o.group),o.action&&(t.attr("data-action",o.action),o.target&&t.attr("data-target",o.target),o.data&&t.data("payload",o.data)),o.icon&&t.prepend(e("<i>",{class:"fas fa-fw "+o.icon}));break;case"heading":t=e("<div>",{class:"panel-heading"}).prepend(e("<h2>",{class:"panel-title",text:o.label}))}a.append(t)}return a},b=t=>{return new Promise(o=>{e(t).append(h([{type:"button",label:"Home",icon:"fa-home",href:"/"},{type:"heading",label:"Information"},{type:"button",label:"Statistics",icon:"fa-chart-line",btnType:"info",action:"ShowStatsDialog"},{type:"button",label:"Wormhole data",icon:"fa-space-shuttle",btnType:"info",action:"ShowJumpInfo"},{type:"button",label:"Wormhole effects",icon:"fa-crosshairs",btnType:"info",action:"ShowSystemEffectInfo"},{type:"heading",label:"Settings"},{type:"button",class:"loading",label:"Account",icon:"fa-user",group:"userOptions",action:"ShowSettingsDialog"},document.fullscreenEnabled?{type:"button",id:a.config.menuButtonFullScreenId,label:"Full screen",icon:"fa-expand-arrows-alt",action:"Fullscreen"}:null,{type:"button",label:"Notification test",icon:"fa-volume-up",action:"NotificationTest"},{type:"heading",label:"Danger zone"},{type:"button",label:"Delete account",icon:"fa-user-times",btnType:"danger",action:"DeleteAccount"},{type:"button",label:"Logout",icon:"fa-sign-in-alt",btnType:"warning",action:"Logout",data:{graceful:1,deleteCookie:1}}])),o({action:"loadLeftMenu",data:t})})},y=t=>{return new Promise(o=>{e(t).append(h([{type:"button",class:"loading",label:"Settings",icon:"fa-cogs",group:"mapOptions",action:"ShowMapSettings",data:{tab:"settings"}},{type:"button",label:"Information",icon:"fa-street-view",action:"ShowMapInfo",data:{tab:"information"}},{type:"heading",label:"Map"},{type:"button",id:a.config.menuButtonGridId,class:"loading",label:"Grid snapping",icon:"fa-th",group:"mapOptions",action:"MapOption",target:"map",data:{option:"mapSnapToGrid",toggle:!0}},{type:"button",id:a.config.menuButtonMagnetizerId,class:"loading",label:"Magnetizing",icon:"fa-magnet",group:"mapOptions",action:"MapOption",target:"map",data:{option:"mapMagnetizer",toggle:!0}},{type:"heading",label:"System"},{type:"button",id:a.config.menuButtonRegionId,class:"loading",label:"Region label",icon:"fa-map-marked-alt",group:"mapOptions",action:"MapOption",target:"map",data:{option:"systemRegion",toggle:!0}},{type:"button",id:a.config.menuButtonCompactId,class:"loading",label:"Compact view",icon:"fa-compress",group:"mapOptions",action:"MapOption",target:"map",data:{option:"systemCompact",toggle:!0}},{type:"heading",label:"Connection"},{type:"button",id:a.config.menuButtonEndpointId,class:"loading",label:"Signature overlay",icon:"fa-link",group:"mapOptions",action:"MapOption",target:"map",data:{option:"connectionSignatureOverlays",toggle:!0}},{type:"heading",label:"Help"},{type:"button",label:"Manual",icon:"fa-book-reader",btnType:"info",action:"Manual"},{type:"button",label:"Shortcuts",icon:"fa-keyboard",btnType:"info",action:"Shortcuts"},{type:"button",label:"Task-Manager",icon:"fa-tasks",btnType:"info",action:"ShowTaskManager"},{type:"heading",label:"Danger zone"},{type:"button",id:a.config.menuButtonMapDeleteId,label:"Delete map",icon:"fa-trash",btnType:"danger",action:"DeleteMap"}])),o({action:"loadRightMenu",data:t})})},M=()=>{return new Promise(e=>{let t=["svg/logo_inline.svg","svg/grid_layout.svg","svg/swords.svg"].map(e=>`text!${a.imgRoot()}${e}!strip`);requirejs(t,(...t)=>{let a=Object.assign(document.createElement("div"),{className:"pf-svg-wrapper"});a.insertAdjacentHTML("beforeend",t.join("")),document.body.append(a),e({action:"loadSVGs",data:{}})})})},C=t=>{return new Promise(o=>{let n={id:g.pageHeaderId,brandLogo:g.menuHeadMenuLogoClass,popoverTriggerClass:a.config.popoverTriggerClass,userCharacterClass:g.headUserCharacterClass,userCharacterImageClass:g.userCharacterImageClass,usersActiveClass:g.headActiveUsersClass,userLocationId:a.config.headUserLocationId,mapTrackingId:a.config.headMapTrackingId};t.insertAdjacentHTML("afterbegin",i.render(c,n)),e("."+g.headMenuClass).on("click.menuOpen",e=>{e.preventDefault(),e.stopPropagation(),a.triggerMenuAction(document,"Toggle",{menuClass:g.pageMenuLeftClass})}),e("."+g.headMapClass).on("click.menuOpen",e=>{e.preventDefault(),e.stopPropagation(),a.triggerMenuAction(document,"Toggle",{menuClass:g.pageMenuRightClass})}),e("."+g.headActiveUsersClass).on("click",()=>{a.triggerMenuAction(document,"ShowMapInfo",{tab:"activity"})}),e("#"+a.config.headUserLocationId).on("click",">li",t=>{let o=e(t.currentTarget),n=parseInt(o.attr("data-systemId")),i=o.attr("data-systemName"),r=a.getMapModule().getActiveMap();if(r){let t=a.getCurrentMapData(r.data("id")),l=s.getSystemDataFromMapData(t,n,"systemId");if(l)a.triggerMenuAction(r,"SelectSystem",{systemId:l.id});else{let l={systemData:{id:n,name:i}},c=o.prev();if(c.length){let a=parseInt(c.attr("data-systemId")),o=s.getSystemDataFromMapData(t,a,"systemId");if(o){let t=e("#"+s.getSystemId(o.mapId,o.id));t.length&&(l.sourceSystem=t)}}a.triggerMenuAction(r,"AddSystem",l)}}else console.warn("No active map found!")}),e("."+g.headProgramStatusClass).on("click",()=>{a.triggerMenuAction(document,"ShowTaskManager")});let r=e("#"+a.config.headMapTrackingId);r.bootstrapToggle({size:"mini",on:"on",off:"off",onstyle:"success",offstyle:"default",width:38,height:19}),r.bootstrapToggle("on"),r.on("change",t=>{let o="off",n="Your current location will not actually be added",i="info";e(t.target).is(":checked")&&(o="on",n="New connections will actually be added",i="success"),a.showNotify({title:"Map tracking: "+o,text:n,type:i},!1)}),f(e("#"+g.pageHeaderId)),o({action:"loadHeader",data:{pageEl:t}})})},v=t=>{return new Promise(o=>{let n={id:a.config.footerId,footerClockClass:g.footerClockClass,footerLicenceLinkClass:g.footerLicenceLinkClass,currentYear:(new Date).getFullYear()};t.insertAdjacentHTML("afterbegin",i.render(d,n)),e(t.querySelector(`.${g.footerLicenceLinkClass}`)).on("click",t=>{t.stopPropagation(),e.fn.showCreditsDialog()}),T(),o({action:"loadFooter",data:{pageEl:t}})})},S=t=>{return new Promise(o=>{e(t).on("click",".list-group-item[data-action]",t=>{t.preventDefault(),t.stopPropagation();let o=t.currentTarget,n=o.getAttribute("data-action"),i=o.getAttribute("data-target"),s=e(o).data("payload");a.triggerMenuAction((e=>{switch(e){case"map":return a.getMapModule().getActiveMap();case"document":default:return document}})(i),n,s)}),o({action:"setMenuObserver",data:{}})})},w=()=>{return new Promise(t=>{let o=e(document),i=new l;i.init(),e("."+g.pageClass).on("click.menuClose",()=>{i.close()}),o.on("pf:menuAction",(t,o,s)=>{if(t.target===t.currentTarget)switch(t.stopPropagation(),o){case"Close":i.close();break;case"Toggle":i.toggle(s.menuClass);break;case"ShowStatsDialog":e.fn.showStatsDialog();break;case"ShowJumpInfo":e.fn.showJumpInfoDialog();break;case"ShowSystemEffectInfo":e.fn.showSystemEffectInfoDialog();break;case"ShowSettingsDialog":e.fn.showSettingsDialog();break;case"Fullscreen":(t=>{if(document.fullscreenEnabled&&t.requestFullscreen){let o=e("#"+a.config.menuButtonFullScreenId);document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().then(()=>{o.toggleClass("active",!1)}):t.requestFullscreen().then(()=>{o.toggleClass("active",!0),a.triggerMenuAction(document,"Close")})}})(document.body);break;case"NotificationTest":a.showNotify({title:"Test Notification",text:"Accept browser security question"},{desktop:{title:"Test OK",text:"Desktop notifications active"},stack:"barBottom"});break;case"DeleteAccount":e.fn.showDeleteAccountDialog();break;case"Logout":a.logout({ajaxData:{graceful:parseInt(a.getObjVal(s,"graceful"))||0,deleteCookie:parseInt(a.getObjVal(s,"deleteCookie"))||0}});break;case"ShowMapInfo":e.fn.showMapInfoDialog(s);break;case"ShowMapSettings":{let t=!1,o=a.getMapModule().getActiveMap();o&&(t=a.getCurrentMapData(o.data("id"))),e.fn.showMapSettingsDialog(t,s);break}case"Manual":e.fn.showMapManual();break;case"Shortcuts":e.fn.showShortcutsDialog();break;case"ShowTaskManager":n.showDialog();break;case"DeleteMap":{let t=!1,o=a.getMapModule().getActiveMap();o&&(t=o.getMapDataFromClient(["hasId"])),e.fn.showDeleteMapDialog(t);break}default:console.warn("Unknown menuAction %o event name",o)}else console.warn("Unhandled menuAction %o event name. Handled menu events should not bobble up",o)}),o.on("pf:updateMenuOptions",(e,{menuGroup:t,payload:o})=>{let n=document.querySelectorAll(`.${m()}[data-group="${t}"]`);switch(t){case"mapOptions":let e=s.checkRight("map_delete",o);document.getElementById(a.config.menuButtonMapDeleteId).classList.toggle("disabled",!e),[...n].forEach(e=>e.classList.remove("loading"));break;case"userOptions":[...n].forEach(e=>e.classList.toggle("loading",!o))}}),o.on("pf:updateHeaderMapData",(e,t)=>{let o=a.getMapModule().getActiveMap(),n=0,i=0,s=0;o&&o.data("id")===t.mapId&&(n=t.userCountInside,i=t.userCountOutside,s=t.userCountInactive),x(n,i,s)}),o.on("pf:changedUserData",(e,t)=>{t.characterId&&o.trigger("pf:updateMenuOptions",{menuGroup:"userOptions",payload:Boolean(a.getCurrentCharacterData("id"))}),D(t).then()}),o.on("pf:shutdown",(t,n)=>{let i={buttons:{logout:{label:'<i class="fas fa-fw fa-sync"></i> restart',className:["btn-primary"].join(" "),callback:function(){n.redirect?a.redirect(n.redirect,["logout"]):n.reload?location.reload():a.triggerMenuAction(document,"Logout")}}},content:{icon:"fa-bolt",class:"txt-color-danger",title:"Application error",headline:"Logged out",text:[n.reason],textSmaller:[]}};if(n.error&&n.error.length)for(let e of n.error)i.content.textSmaller.push(e.text);return e.fn.showNotificationDialog(i),o.setProgramStatus("offline"),a.showNotify({title:"Logged out",text:n.reason,type:"error"},!1),a.getMapModule().velocity("fadeOut",{duration:300,complete:function(){e(this).remove()}}),!1}),t({action:"setDocumentObserver",data:{}})})},I=()=>{return new Promise(t=>{document.body.style.setProperty("--svgBubble",`url("${a.imgRoot()}svg/bubble.svg")`);let n=e(document.body);n.on("hide.bs.popover","."+a.config.popoverTriggerClass,t=>{e(t.target).data("bs.popover").tip().destroyTooltips(!0)}),n.on("hide.bs.modal","> .modal",t=>{let n=e(t.target);n.destroyPopover(!0),n.find("."+a.config.select2Class).filter((t,a)=>e(a).data("select2")).select2("destroy");for(let t of n.find("table.dataTable"))e(t).DataTable().destroy(!0);o.destroyTimestampCounter(n,!0)}),n.on("click.contextMenuClose",()=>{r.closeMenus()}),t({action:"setBodyObserver",data:{}})})},k=()=>{return new Promise(t=>{let o=e(document.body);o.watchKey("tabReload",()=>{location.reload()}),o.watchKey("renameSystem",()=>{let e=a.getMapModule().getActiveMap();if(e){let t=e.find("."+s.config.systemActiveClass+":first");t.length&&s.toggleSystemAliasEditable(t)}}),o.watchKey("newSignature",()=>{let e=a.getMapModule().getActiveMap();e&&s.getTabContentElementByMapElement(e).find("."+g.systemSignatureModuleClass).trigger("pf:showSystemSignatureModuleAddNew")}),o.watchKey("clipboardPaste",t=>{let o=a.getMapModule().getActiveMap();if(o){let a=s.getTabContentElementByMapElement(o),n=a.find("."+g.systemSignatureModuleClass),i=a.find("."+g.systemIntelModuleClass);if(n.length||i.length){t=t.originalEvent;let a=e(t.target);if("input"!==a.prop("tagName").toLowerCase()&&"textarea"!==a.prop("tagName").toLowerCase()||a.is('input[type="search"]')){let e=(t.originalEvent||t).clipboardData.getData("text/plain");n.trigger("pf:updateSystemSignatureModuleByClipboard",[e]),i.trigger("pf:updateIntelModuleByClipboard",[e])}}}}),t({action:"setGlobalShortcuts",data:{}})})},T=()=>{let t=e("."+g.footerClockClass),o=()=>{let e=a.getServerTime(),n=e.getHours(),i=(e=>e<10?"0"+e:e)(e.getMinutes());t.text(n+":"+i),setTimeout(o,500)};o()},D=e=>{let t=[];return e.characterLogLocation&&t.push(A(Boolean(a.getCurrentCharacterData("logLocation")))),e.charactersIds&&t.push(L(e.characterId)),(e.characterSystemId||e.characterShipType||e.characterStationId||e.characterStructureId||e.characterLogHistory)&&t.push(O(e.characterShipType)),Promise.all(t)},A=t=>{return new Promise(o=>{let n=e("#"+a.config.headMapTrackingId);!0===t?n.bootstrapToggle("enable"):n.bootstrapToggle("off").bootstrapToggle("disable"),o({action:"updateMapTrackingToggle",data:{}})})},L=t=>{return new Promise(o=>{let n=e("."+g.headUserCharacterClass);E(n,e=>{t&&(e.find("span").text(a.getCurrentCharacterData("name")),e.find("img").attr("src",a.eveImageUrl("characters",a.getCurrentCharacterData("id")))),e.initCharacterSwitchPopover(),o({action:"updateHeaderCharacterSwitch",data:{}})},!0)})},O=t=>{return new Promise(o=>{let n=e("#"+a.config.headUserLocationId),i="",s=a.getCurrentCharacterData("log"),r=[];if(s){let e=a.getObjVal(s,"ship"),t=a.getObjVal(e,"typeId")||0,o=a.getObjVal(e,"typeName")||"",n=a.getObjVal(s,"station"),l=a.getObjVal(n,"id")||0,c=a.getObjVal(n,"name")||"",d=a.getObjVal(s,"structure"),u=(a.getObjVal(d,"type.id"),a.getObjVal(d,"type.name")||""),p=a.getObjVal(d,"id")||0,m=a.getObjVal(d,"name")||"";r.push(s);let f=a.getCurrentCharacterData("logHistory");f&&(f.length>g.headMaxLocationHistoryBreadcrumbs&&(i+='<li class="--empty">',i+='<span class="pf-head-breadcrumb-item">',i+="…",i+="</span></li>"),r=r.concat(f.map(e=>e.log).slice(0,g.headMaxLocationHistoryBreadcrumbs))),r=r.reverse();for(let[e,n]of r.entries()){let s=a.getObjVal(n,"system.id"),d=a.getObjVal(n,"system.name"),g=e===r.length-1;i+='<li class="'+(g?"":"hidden-xs")+'" data-systemId="'+s+'" data-systemName="'+d+'">',i+='<span class="pf-head-breadcrumb-item">',g&&(i+='<i class="fas fa-fw fa-map-marker-alt" title="current location"></i>',l>0?i+='<i class="fas fa-home" title="'+c+'"></i>':p>0&&(i+='<i class="fas fa-industry" title="'+u+" &quot;"+m+'&quot;"></i>')),i+=d,g&&t&&(i+='<img class="pf-head-image --right" ',i+='src="'+a.eveImageUrl("types",t)+'" ',i+='title="'+o+'" ',i+=">"),i+="</span></li>"}}E(n,a=>{a.html(i),f(a),t&&e(document).trigger("pf:activeShip")},Boolean(s)),o({action:"updateHeaderCharacterLocation",data:{}})})},x=(a,o,n)=>{let i=e("."+g.headActiveUsersClass),s=(e,t)=>{let a=!1;return e.data("userCount")!==t&&(a=!0,e.data("userCount",t),e.text(t),e.toggleClass(e.attr("data-on"),t>0),e.toggleClass(e.attr("data-off"),0===t)),a},r=s(i.find('.badge[data-type="inside"]'),a),l=s(i.find('.badge[data-type="outside"]'),o),c=s(i.find('.badge[data-type="inactive"]'),n);(r||l||c)&&!i.is(":visible")&&i.velocity("fadeIn",{duration:t.animationSpeed.headerLink})},E=(a,o,n)=>{let i=parseInt(a.css("opacity")),s=e=>{e.show().velocity({opacity:[1,0]},{visibility:"visible",duration:t.animationSpeed.headerLink})},r=(a,o)=>{a.velocity("stop").velocity({opacity:[0,1]},{visibility:"hidden",duration:t.animationSpeed.headerLink,complete:function(){a.hide(),o(e(this))}})};i>0&&n?r(a,e=>{o(e),s(e)}):i>0&&!n?r(a,e=>{e.hide(),o(e)}):0===i&&n?(o(a),s(a)):o(a)};return e.fn.setProgramStatus=function(o){let n=e("."+g.headProgramStatusClass),i=n.find("i"),s=n.find("span"),r="",l="";switch(o){case"online":r="fa-wifi",l="txt-color-green";break;case"slow connection":case"problem":r="fa-exclamation-triangle",l="txt-color-orange";break;case"offline":r="fa-bolt",l="txt-color-red"}if("txt-color-orange"!==l&&"txt-color-red"!==l||(clearInterval(p),p=!1),n.data("status")!==o&&!p){let e=a.getObjVal(t,"timer.PROGRAM_STATUS_VISIBLE")||5e3,c=function(){u===e&&n.velocity("stop").velocity("fadeOut",{duration:t.animationSpeed.headerLink,complete:function(){n.data("status",o),n.removeClass("txt-color-green txt-color-orange txt-color-red"),i.removeClass("fa-wifi fa-exclamation-triangle fa-bolt"),n.addClass(l),i.addClass(r),s.text(o)}}).velocity("fadeIn",{duration:t.animationSpeed.headerLink}),(u-=1e3)<=0&&(clearInterval(p),p=!1)};p||(u=e,p=setInterval(c,1e3))}},e.fn.getFormValues=function(){let t=e(this),o={},n=t.serializeArray();n=n.concat(t.find("input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:0}}).get());for(let t of n){let a=/^\d+$/.test(t.value)?parseInt(t.value):t.value;if(-1!==t.name.indexOf("[]")){let n=t.name.replace("[]","");e.isArray(o[n])||(o[n]=[]),o[n].push(a)}else o[t.name]=a}let i=t.find("."+a.config.formEditableFieldClass).editable("getValue");return o=e.extend(o,i)},{renderPage:e=>{let t=Object.assign(document.createElement("div"),{className:g.pageClass});t.setAttribute("canvas","container");let o=Object.assign(document.createElement("div"),{id:r.config.contextMenuContainerId});t.append(a.getMapModule()[0],o);let n=Object.assign(document.createElement("div"),{className:[g.pageMenuClass,g.pageMenuLeftClass].join(" ")});n.setAttribute("off-canvas",[g.pageMenuLeftClass,"left","push"].join(" "));let i=Object.assign(document.createElement("div"),{className:[g.pageMenuClass,g.pageMenuRightClass].join(" ")});return i.setAttribute("off-canvas",[g.pageMenuRightClass,"right","push"].join(" ")),e.prepend(t,n,i),Promise.resolve({pageEl:t,pageMenuLeftEl:n,pageMenuRightEl:i})},loadPageStructure:({pageEl:e,pageMenuLeftEl:t,pageMenuRightEl:a})=>new Promise(o=>{Promise.all([C(e),v(e),b(t),y(a),M()]).then(e=>Promise.all([S(e[2].data),S(e[3].data),w(),I(),k()])).then(()=>o({action:"loadPageStructure",data:e}))}),initTabChangeObserver:()=>new Promise(e=>{let t,o;void 0!==document.visibilityState&&(t="visibilityState",o="visibilitychange");let n=()=>{"visible"===document[t]?(window.isVisible=!0,a.getCurrentTriggerDelay("UPDATE_SERVER_MAP",-5e3),a.getCurrentTriggerDelay("UPDATE_SERVER_USER_DATA",-5e3),a.stopTabBlink()):(window.isVisible=!1,a.getCurrentTriggerDelay("UPDATE_SERVER_MAP",5e3),a.getCurrentTriggerDelay("UPDATE_SERVER_USER_DATA",5e3))};t&&o&&(n(),document.addEventListener(o,n,!1)),e({action:"initTabChangeObserver",data:!1})}),renderMapContextMenus:()=>Promise.all([r.renderMapContextMenu(),r.renderConnectionContextMenu(),r.renderEndpointContextMenu(),r.renderSystemContextMenu(t.systemStatus)]).then(e=>{document.getElementById(r.config.contextMenuContainerId).innerHTML=e.join("")})}});
//# sourceMappingURL=page.js.map
