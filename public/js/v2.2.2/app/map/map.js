define(["jquery","app/init","app/util","app/key","app/lib/dragSelect","app/lib/eventHandler","bootbox","app/map/util","app/map/contextmenu","app/map/overlay/overlay","app/map/overlay/util","app/map/system","app/map/layout","app/map/magnetizing","app/map/scrollbar","app/map/local"],(e,t,a,s,n,o,i,l,c,d,r,p,m,u,g)=>{"use strict";let f={zIndexCounter:110,maxActiveConnections:8,mapIdPrefix:"pf-map-",systemClass:"pf-system",systemSelectedClass:"pf-system-selected",systemHeadClass:"pf-system-head",systemHeadNameClass:"pf-system-head-name",systemHeadCounterClass:"pf-system-head-counter",systemHeadTagClass:"pf-system-head-tag",systemHeadExpandClass:"pf-system-head-expand",systemHeadInfoClass:"pf-system-head-info",systemBodyClass:"pf-system-body",systemBodyItemHeight:16,systemBodyItemClass:"pf-system-body-item",systemBodyItemStatusClass:"pf-user-status",systemBodyItemNameClass:"pf-system-body-item-name",systemBodyRightClass:"pf-system-body-right",endpointSourceClass:"pf-map-endpoint-source",endpointTargetClass:"pf-map-endpoint-target",systemSec:"pf-system-sec"},y={},h=[],C={mapSnapToGrid:{buttonId:a.config.menuButtonGridId,description:"Grid snapping",class:"mapGridClass"},mapMagnetizer:{buttonId:a.config.menuButtonMagnetizerId,description:"Magnetizer",onEnable:u.initMagnetizer,onDisable:u.destroyMagnetizer},systemRegion:{buttonId:a.config.menuButtonRegionId,description:"Region names",class:"systemRegionClass",onEnable:d.toggleInfoSystemRegion,onDisable:d.toggleInfoSystemRegion},systemCompact:{buttonId:a.config.menuButtonCompactId,description:"Compact system layout",class:"systemCompactClass"},connectionSignatureOverlays:{buttonId:a.config.menuButtonEndpointId,description:"Endpoint overlay",onEnable:d.showInfoSignatureOverlays,onDisable:d.hideInfoSignatureOverlays}},S=(t,a)=>{let s=e(t.target),n=l.getEffectInfoForSystem("effect","class");return s.hasClass(f.systemHeadNameClass)||s.hasClass(n)||s.hasClass(f.systemHeadExpandClass)||s.hasClass(f.systemHeadInfoClass)},b={source:{filter:S,isTarget:!0,allowLoopback:!1,cssClass:f.endpointSourceClass,uniqueEndpoint:!1,dragOptions:{},connectionsDetachable:!0,maxConnections:10},target:{filter:S,isSource:!0,cssClass:f.endpointTargetClass,dropOptions:{activeClass:"dragActive"}},endpointTypes:t.endpointTypes,connectionTypes:t.connectionTypes},v=(e,t)=>{e.revalidate(t);let a="object"==typeof t&&t.length?t:[t];for(let t of a){let a=e.anchorManager.getConnectionsFor(t.id);for(let e of a)for(let t of e[0].endpoints){let e=t.getOverlay(r.config.endpointOverlayId);if(e instanceof jsPlumb.Overlays.Label){let a=e.getParameter("signatureLabels");e.setLocation(l.getEndpointOverlaySignatureLocation(t,a))}}}},I=(s,n,o,i=!1,l={})=>{let c=n.attr("id"),d=a.getObjVal(l,"compactView"),r=n.find("."+f.systemHeadCounterClass),p=n.find("."+f.systemBodyClass),m=n.find("."+f.systemHeadExpandClass),u=n.data("userCacheKey"),g=n.data("userCount")||0,y=Boolean(n.data("currentUser")),h=0;if(n.data("currentUser",i),i&&!y&&Boolean(a.getObjVal(t,"character.autoLocationSelect"))&&Boolean(a.getCurrentCharacterData("selectLocation"))&&a.triggerMenuAction(s.getContainer(),"SelectSystem",{systemId:n.data("id"),forceSelect:!1}),o&&o.user){h=o.user.length;let t=[];for(let e of o.user)t.push(e.id+"_"+e.log.ship.typeId);let i=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});t.sort(i.compare);let l=d?"compact":"default";if((l+="_"+t.join("_").hashCode())!==u)if(n.data("userCacheKey",l),n.data("userCount",h),p.empty(),d)r.text(h),n.toggleSystemTooltip("destroy",{}),m.hide(),n.toggleBody(!1,s,{}),s.revalidate(c);else{r.empty();for(let t=0;t<o.user.length;t++){let s=o.user[t],n=a.getStatusInfoForCharacter(s,"class"),i=s.name,l=e("<div>",{class:f.systemBodyItemClass}).append(e("<span>",{text:s.log.ship.typeName,class:f.systemBodyRightClass})).append(e("<i>",{class:["fas","fa-circle",f.systemBodyItemStatusClass,n].join(" ")})).append(e("<span>",{class:f.systemBodyItemNameClass,text:i}));p.append(l)}let t="";h>=g?t="good":h<g&&(t="bad");let i={systemId:c,highlight:t,userCount:h};m.css("display","inline-block"),n.toggleBody(!0,s,{complete:function(e){e.toggleSystemTooltip("show",i),s.revalidate(c)}})}}else n.data("userCacheKey",!1),n.data("userCount",0),p.empty(),u&&u.length>0&&(r.empty(),n.toggleSystemTooltip("destroy",{}),m.hide(),n.toggleBody(!1,s,{}),s.revalidate(c))};e.fn.toggleBody=function(t,a,s){let n=e(this),o=n.find("."+f.systemBodyClass),i=n.attr("id");!0===t?o.velocity({height:f.systemBodyItemHeight+"px"},{duration:50,display:"auto",progress:function(){a.revalidate(i)},complete:function(){a.revalidate(i),s.complete&&s.complete(n)}}):!1===t&&o.velocity({height:"0px",width:"100%","min-width":"none"},{duration:50,display:"none",begin:function(){},progress:function(){a.revalidate(i)},complete:function(){a.revalidate(i)}})},e.fn.setSystemStatus=function(s){let n=e(this),o=a.getStatusInfoForSystem(s,"id"),i=a.getStatusInfoForSystem(s,"class");for(let e in t.systemStatus)t.systemStatus.hasOwnProperty(e)&&n.removeClass(t.systemStatus[e].class);n.data("statusId",o),n.addClass(i)},e.fn.getSystem=function(s,n){let o=e(this),i=l.getSystemId(o.data("id"),n.id),c=document.getElementById(i),d=n.position.x+"px",r=n.position.y+"px";if(c){let a=(c=e(c)).css("left"),o=c.css("top");d===a&&r===o||c.velocity({left:d,top:r},{easing:"linear",duration:t.animationSpeed.mapMoveSystem,begin:function(t){e(t).toggleSystemTooltip("hide",{}),e(t).destroyPopover(!0),e(t).updateSystemZIndex()},progress:function(e){v(s,e)},complete:function(t){e(t).toggleSystemTooltip("show",{show:!0}),v(s,t)}});let i=c.getSystemInfo(["alias"]);i!==n.alias&&(i=n.alias?n.alias:n.name,c.find("."+f.systemHeadNameClass).editable("setValue",i)),c.getSystemInfo(["tag"])!==n.tag&&c.find("."+f.systemHeadTagClass).editable("setValue",n.tag)}else{let t=n.name;n.alias&&""!==n.alias&&(t=n.alias);let s=[f.systemHeadNameClass];3===n.type.id&&s.push(a.config.fontTriglivianClass);let o=l.getEffectInfoForSystem("effect","class"),m=l.getEffectInfoForSystem(n.effect,"class"),u=a.getSecurityClassForSystem(n.security);(c=e("<div>",{id:i,class:f.systemClass}).append(e("<div>",{class:f.systemHeadClass}).append(e("<span>",{class:[f.systemSec,u].join(" "),text:l.getSystemSecurityForDisplay(n.security).toLowerCase()}),e("<span>",{class:[f.systemHeadTagClass,u].join(" ")}).attr("data-value",n.tag),e("<span>",{class:s.join(" ")}).attr("data-value",t),e("<span>",{class:[f.systemHeadCounterClass,a.config.popoverTriggerClass].join(" ")}),e("<i>",{class:["fas","fa-lock","fa-fw"].join(" ")}).attr("title","locked"),e("<i>",{class:["fas","fa-square","fa-fw",o,m,a.config.popoverTriggerClass].join(" ")}),e("<i>",{class:["fas","fa-angle-down",f.systemHeadExpandClass].join(" ")}),p.getHeadInfoElement(n)),e("<div>",{class:f.systemBodyClass}))).css({left:d,top:r})}return c.setSystemStatus(n.status.name),c.data("id",parseInt(n.id)),c.data("systemId",parseInt(n.systemId)),c.data("name",n.name),c.data("tag",n.tag),c.data("typeId",parseInt(n.type.id)),c.data("effect",n.effect),c.data("security",n.security),c.data("trueSec",parseFloat(n.trueSec)),c.data("regionId",parseInt(n.region.id)),c.data("region",n.region.name),c.data("constellationId",parseInt(n.constellation.id)),c.data("constellation",n.constellation.name),c.data("planets",n.planets),c.data("shattered",n.shattered),c.data("drifter",n.drifter),c.data("statics",n.statics),c.data("updated",parseInt(n.updated.updated)),c.data("changed",!1),c.attr("data-mapid",parseInt(o.data("id"))),n.sovereignty&&c.data("sovereignty",n.sovereignty),Boolean(c.data("locked"))!==n.locked&&c.toggleLockSystem(!1,{hideNotification:!0,hideCounter:!0,map:s}),c.setSystemRally(n.rallyUpdated,{poke:n.rallyPoke||!1,hideNotification:!0,hideCounter:!0}),c};let w=(t,s)=>{let n=s.closest("."+a.config.mapClass),o=l.getMapInstance(s.attr("data-mapid")),i={};switch(t){case"add_system":p.showNewSystemDialog(o,{sourceSystem:s},V);break;case"lock_system":s.toggleLockSystem(!0,{map:o}),o.repaint(s),l.markAsChanged(s);break;case"set_rally":s.data("rallyUpdated")?(s.setSystemRally(0),l.markAsChanged(s)):e.fn.showRallyPointDialog(s);break;case"find_route":i=s.getSystemData(),l.showFindRouteDialog(n,{systemId:i.systemId,name:i.name});break;case"select_connections":let c=l.searchConnectionsBySystems(o,[s],"*");l.showConnectionInfo(o,c);break;case"change_status_unknown":case"change_status_friendly":case"change_status_occupied":case"change_status_hostile":case"change_status_empty":case"change_status_unscanned":r.getMapOverlay(s,"timer").startMapUpdateCounter();let d=t.split("_");s.setSystemStatus(d[2]),l.markAsChanged(s);break;case"delete_system":let m=n.getSelectedSystems();e.merge(m,s),e.uniqueSort(m),e.fn.showDeleteSystemDialog(o,m);break;case"set_destination":case"add_first_waypoint":case"add_last_waypoint":i=s.getSystemData(),a.setDestination(t,"system",{id:i.systemId,name:i.name})}},_=(s,n,o)=>{let i=e(n.getContainer()),c=parseInt(i.data("id"));switch(s){case"add_system":let d=m.getEventCoordinates(o),r=l.newSystemPositionByCoordinates(i,{center:[d.x,d.y]});r.length&&(d.x=r[0].left,d.y=r[0].top),p.showNewSystemDialog(n,{position:d},V);break;case"select_all":i.selectAllSystems();break;case"filter_wh":case"filter_stargate":case"filter_jumpbridge":case"filter_abyssal":let u=s.split("_")[1],g=l.getScopeInfoForConnection(u,"label");a.getLocalStore("map").getItem(c).then(e=>{let s=[];e&&e.filterScopes&&(s=e.filterScopes);let o=s.indexOf(u);o>=0?s.splice(o,1):(s.push(u),s.length===Object.keys(t.connectionScopes).length&&(s=[])),a.getLocalStore("map").setItem(`${c}.filterScopes`,s),l.filterMapByScopes(n,s),a.showNotify({title:"Scope filter changed",text:g,type:"success"})});break;case"delete_systems":let f=i.getSelectedSystems();e.fn.showDeleteSystemDialog(n,f);break;case"map_edit":a.triggerMenuAction(document,"ShowMapSettings",{tab:"edit"});break;case"map_info":a.triggerMenuAction(document,"ShowMapInfo",{tab:"information"})}},k=(t,s)=>{if(!s._jsPlumb)return void a.showNotify({title:"Connection not found",type:"error"});let n=s._jsPlumb.instance,o=e(n.getContainer()),c=s.scope,d=l.getScopeInfoForConnection(c,"label");switch(t){case"delete_connection":i.confirm("Is this connection really gone?",e=>{e&&l.deleteConnections([s])});break;case"preserve_mass":case"wh_eol":r.getMapOverlay(o,"timer").startMapUpdateCounter(),l.toggleConnectionType(s,t),l.markAsChanged(s);break;case"status_fresh":case"status_reduced":case"status_critical":let e=t.split("_")[1];r.getMapOverlay(o,"timer").startMapUpdateCounter(),l.setConnectionMassStatusType(s,"wh_"+e),l.markAsChanged(s);break;case"wh_jump_mass_s":case"wh_jump_mass_m":case"wh_jump_mass_l":case"wh_jump_mass_xl":r.getMapOverlay(o,"timer").startMapUpdateCounter(),l.setConnectionJumpMassType(s,t),l.markAsChanged(s);break;case"scope_wh":case"scope_stargate":case"scope_jumpbridge":let n=t.split("_")[1],c=l.getScopeInfoForConnection(n,"label");i.confirm("Change scope from "+d+" to "+c+"?",e=>{e&&(T(s,n),r.getMapOverlay(o,"timer").startMapUpdateCounter(),a.showNotify({title:"Connection scope changed",text:"New scope: "+c,type:"success"}),l.markAsChanged(s))})}},D=(t,a)=>{let s=a._jsPlumb.instance,n=e(s.getContainer());switch(t){case"bubble":r.getMapOverlay(n,"timer").startMapUpdateCounter(),a.toggleType(t);for(let e of a.connections)l.markAsChanged(e)}},T=(e,t)=>{let a=e.getConnector(),s=l.getScopeInfoForConnection(t,"connectorDefinition");if(a.type!==s[0]){e.setConnector(s);let a=e._jsPlumb.instance,n=e.scope,o=l.filterDefaultTypes(e.getType()),i=[l.getDefaultConnectionTypeByScope(t)],c=o.intersect(l.filterDefaultTypes(Object.keys(a._connectionTypes)).diff(i));l.removeConnectionTypes(e,c),l.addConnectionTypes(e,i),e.scope=t,console.info('connection "scope" changed for %O. Scope %o → %o, Types %o → %o',e,n,t,o,i)}},M=(t,a)=>new Promise((s,n)=>{let o=e(t.getContainer()).data("id"),i=a.id||0,c=e("#"+l.getSystemId(o,a.source)),d=e("#"+l.getSystemId(o,a.target));if(c.length)if(d.length){let e=t.connect({source:c[0],target:d[0],scope:a.scope||t.Defaults.Scope});if(e instanceof jsPlumb.Connection){if(e.addType((a.type||l.getDefaultConnectionTypeByScope(t.Defaults.Scope)).join(" ")),e.setParameters({connectionId:i,updated:a.updated,created:a.created,eolUpdated:a.eolUpdated}),e.scope!==t.Defaults.Scope){let t=l.getScopeInfoForConnection(e.scope,"connectorDefinition");e.setConnector(t)}if(a.endpoints)for(let t of e.endpoints){let s=l.getEndpointLabel(e,t);if(s&&a.endpoints[s]&&Array.isArray(a.endpoints[s].types))for(let e of a.endpoints[s].types)t.addType(e)}s({action:"drawConnection",data:{connection:e}})}else n(new Error("drawConnection(): connection must be instanceof jsPlumb.Connection"))}else n(new Error(`drawConnection(): target system (id: ${a.target}) not found`));else n(new Error(`drawConnection(): source system (id: ${a.source}) not found`))}),O=(t,s)=>{if(t.suspendedElement)return console.info("connection update skipped for %O. SuspendedElement: %o",t,t.suspendedElement),t;let n=l.getDataByConnection(t),o=t._jsPlumb.instance,i=e(o.getContainer()).data("id");t.hasType("state_process")&&l.removeConnectionTypes(t,["state_process"]),t.getParameter("connectionId")!==s.id&&t.setParameter("connectionId",s.id),n.scope!==s.scope&&(T(t,s.scope),n=l.getDataByConnection(t)),n.source!==s.source&&o.setSource(t,l.getSystemId(i,s.source)),n.target!==s.target&&o.setTarget(t,l.getSystemId(i,s.target));let c=l.allConnectionJumpMassTypes(),d=c.intersect(s.type),r=c.intersect(n.type);d.equalValues(r)||(l.setConnectionJumpMassType(t,d.length?d[0]:void 0),n=l.getDataByConnection(t));let p=l.allConnectionMassStatusTypes(),m=p.intersect(s.type),u=p.intersect(n.type);m.equalValues(u)||(l.setConnectionMassStatusType(t,m.length?m[0]:void 0),n=l.getDataByConnection(t));let g=["wh_eol","preserve_mass"],f=g.intersect(s.type.diff(n.type)),y=g.intersect(n.type.diff(s.type));l.addConnectionTypes(t,f),l.removeConnectionTypes(t,y);let h=l.getEndpointsDataByConnection(t);for(let e of t.endpoints){let n=l.getEndpointLabel(t,e),o=a.getObjVal(h,[n,"types"].join("."))||[],i=a.getObjVal(s,["endpoints",n,"types"].join("."))||[],c=i.diff(o),d=o.diff(i);for(let t of c)e.addType(t);for(let t of d)e.removeType(t)}return t.setParameter("created",s.created),t.setParameter("updated",s.updated),t.setParameter("eolUpdated",s.eolUpdated),t.setParameter("changed",!1),t},E=(t,s)=>{t=e(t);return new Promise((n,o)=>{a.getLocalStore("map").getItem(s.config.id).then(o=>{let i=0;o&&o.style&&(i=o.style.height),t.css("height",i),((e,t)=>{let s=s=>{let n="",o="";"HTMLDivElement"===s.constructor.name?(n=s.style.width,o=s.style.height):"ResizeObserverEntry"===s.constructor.name&&(n=s.target.style.width,o=s.target.style.height),n=parseInt(n.substring(0,n.length-2))||0,o=parseInt(o.substring(0,o.length-2))||0,e.trigger("pf:mapResize"),a.getLocalStore("map").getItem(t.config.id).then(e=>{let s=!0;e&&e.style&&e.style.width===n&&e.style.height===o&&(s=!1),s&&a.getLocalStore("map").setItem(`${t.config.id}.style`,{width:n,height:o})})};if(window.ResizeObserver){let t;new ResizeObserver(e=>{let a=e=>setTimeout(s,100,e);for(let s of e)clearTimeout(t),t=a(s)}).observe(e[0])}else if(requestAnimationFrame){let t=e=>(s(e),setTimeout(t,500,e));t(e[0])}})(t,s);let l=s.config.id,c=e("<div>",{id:f.mapIdPrefix+l,class:a.config.mapClass}).data("id",l);t.append(c),s.map.setContainer(c),Z(t),$(s.map),t.setMapShortcuts();let d=r.getMapOverlay(c,"info");d.updateOverlayIcon("systemPopover","show"),d.updateOverlayIcon("connection","show"),d.updateOverlayIcon("connectionEol","show"),n({action:"newMapElement",data:{mapConfig:s}})})})},x=t=>{return new Promise((a,s)=>{let n={action:"updateMap",data:{mapConfig:t}},o=t.map?t.map.getContainer():null;if(!o)return a(n);let i=t.config.id,c=G(o,[],!0);if(!c)return-1===h.indexOf(i)&&h.push(i),a(n);(o=e(o)).data("updated")!==t.config.updated.updated&&(o.data("name",t.config.name),o.data("scopeId",t.config.scope.id),o.data("typeId",t.config.type.id),o.data("typeName",t.config.type.name),o.data("icon",t.config.icon),o.data("created",t.config.created.created),o.data("updated",t.config.updated.updated));let d=c.data.systems,r=c.data.connections;for(let e=0;e<t.data.systems.length;e++){let a=t.data.systems[e],s=!0;for(let e=0;e<d.length;e++)if(d[e].id===a.id){d[e].updated.updated<a.updated.updated&&o.getSystem(t.map,a),s=!1;break}!0===s&&B(t.map,a).catch(console.warn)}for(let a=0;a<d.length;a++){let s=!0;for(let e=0;e<t.data.systems.length;e++)if(t.data.systems[e].id===d[a].id){s=!1;break}if(!0===s){let s=e("#"+l.getSystemId(o.data("id"),d[a].id));p.removeSystems(t.map,s)}}t.map.setSuspendDrawing(!0);for(let e=0;e<t.data.connections.length;e++){let a=t.data.connections[e],s=!0;for(let e=0;e<r.length;e++){if(r[e].id===a.id){r[e].updated<a.updated&&O(r[e].connection,a),s=!1;break}if(0===r[e].id&&r[e].source===a.source&&r[e].target===a.target){O(r[e].connection,a),s=!1;break}}!0===s&&M(t.map,a).catch(console.warn)}for(let e=0;e<r.length;e++){if(0===r[e].id)continue;let a=!0;for(let s=0;s<t.data.connections.length;s++)if(t.data.connections[s].id===r[e].id){a=!1;break}if(!0===a){let a=r[e].connection;a&&a.source&&a.target&&t.map.deleteConnection(a,{fireEvent:!1})}}return t.map.setSuspendDrawing(!1,!0),P(t.map),a(n)}).then(t=>new Promise(s=>{a.getLocalStore("map").getItem(t.data.mapConfig.config.id).then(a=>{a&&a.connectionSignatureOverlays&&d.showInfoSignatureOverlays(e(t.data.mapConfig.map.getContainer())),s(t)})})).then(e=>new Promise(t=>{a.getLocalStore("map").getItem(e.data.mapConfig.config.id).then(a=>{let s=[];a&&a.filterScopes&&(s=a.filterScopes),l.filterMapByScopes(e.data.mapConfig.map,s),t(e)})})).then(t=>new Promise(s=>{let n=a.getObjVal(t,"data.mapConfig.map");if(n){let s=n.getContainer().closest(`.${a.config.mapTabContentClass}`);e(s).trigger("pf:updateGlobalModules",{payload:a.getObjVal(t,"data.mapConfig.config.id")})}s(t)}))},P=t=>{let a=t.getAllConnections(),s=e(t.getContainer()).data("id");if(s>0){y[s]=[];for(let e=0;e<a.length;e++)j(s,a[e])}else console.warn("updateConnectionsCache","missing mapId")},j=(e,t)=>{if(e>0&&t){let a=parseInt(t.getParameter("connectionId"));a>0&&(y[e][a]=t)}else console.warn("updateConnectionCache","missing data")};e.fn.getConnectionById=function(e,t){return a.getObjVal(y,[e,t].join("."))||null};let B=(t,s,n,o=null)=>new Promise((i,c)=>{if((e=>(a.getObjVal(e,"name")||"").length>0)(s)){let a={action:"drawSystem"},d=e(t.getContainer()),r=d.getSystem(t,s);d.append(r),L(r),((e,t)=>{if(!e.isTarget(t)){let a=b.target;a.scope=e.Defaults.Scope,e.makeTarget(t,a)}})(t,r),((e,t)=>{if(!e.isSource(t)){let a=b.source;a.scope=e.Defaults.Scope,a.connector=l.getScopeInfoForConnection("wh","connectorDefinition"),e.makeSource(t,a)}})(t,r),R(t,r),u.addElement(s.mapId,r[0]),a.data={system:r},n?(o=Object.assign({},{source:e(n).data("id"),target:r.data("id"),scope:t.Defaults.Scope,type:[l.getDefaultConnectionTypeByScope(t.Defaults.Scope)]},o),M(t,o).then(e=>A(e.data.connection,Boolean(o.disableAutoScope))).then(e=>{a.data={connection:e.data.connection},i(a)}).catch(c)):i(a)}else c(new Error("drawSystem() failed. Invalid systemData"))}),L=t=>{t=e(t);let a=e(t).find("."+f.systemHeadNameClass),s=e(t).find("."+f.systemHeadTagClass),n=e(a).add(e(s));a.editable({mode:"popup",type:"text",name:"alias",emptytext:t.data("name"),title:"System alias",placement:"top",onblur:"submit",toggle:"manual",showbuttons:!1}),s.editable({mode:"popup",type:"text",name:"tag",emptytext:"",title:"System tag",placement:"top",onblur:"submit",container:"body",toggle:"manual",showbuttons:!1,display:function(t){String(t).length&&(t+=" "),e(this).text(t)}}),n.on("save",function(e,a){l.markAsChanged(t)}),n.on("shown",function(e,a){t.toggleSystemTooltip("hide",{});let s=a.input.$input.select();setTimeout(function(e){e.select()},0,s)}),n.on("hidden",function(e,a){t.toggleSystemTooltip("show",{show:!0});let s=l.getMapInstance(t.attr("data-mapid"));v(s,t)})};e.fn.updateSystemZIndex=function(){return this.each(function(){let t=f.zIndexCounter++;e(this).css("z-index",t)})};let A=(t,s=!1)=>new Promise((n,o)=>{t instanceof jsPlumb.Connection||o(new Error("saveConnection(): connection must be instanceof jsPlumb.Connection")),t.addType("state_process");let i=t._jsPlumb.instance,c=e(i.getContainer()).data("id"),d=l.getDataByConnection(t);d.mapId=c,d.disableAutoScope=s,a.request("PUT","Connection",[],d,{connection:t,map:i,mapId:c,oldConnectionData:d}).then(s=>{let i=s.data;if(e.isEmptyObject(i))s.context.map.deleteConnection(s.context.connection,{fireEvent:!1}),o(new Error("saveConnection(): response error"));else{t=O(s.context.connection,i),j(s.context.mapId,t);let e=l.getScopeInfoForConnection(i.scope,"label"),o="New connection established";s.context.oldConnectionData.id>0&&(o="Connection switched"),a.showNotify({title:o,text:"Scope: "+e,type:"success"}),n({action:"saveConnection",data:{connection:t}})}},e=>{e.context.map.deleteConnection(e.context.connection,{fireEvent:!1}),a.handleAjaxErrorResponse(e),o(new Error("saveConnection(): request error"))})}),H=t=>t instanceof e&&t.hasClass(f.systemClass)?N(t):t instanceof window.jsPlumbInstance?F(t):t instanceof jsPlumb.Connection?U(t):t instanceof jsPlumb.Endpoint?z(t):void 0,N=e=>{return new Promise(t=>{let s=c.defaultMenuOptionConfig();s.id=c.config.systemContextMenuId,s.selectCallback=w;let n=e.closest("."+a.config.mapClass);!0===e.data("locked")&&s.hidden.push("delete_system"),n.find("."+l.config.systemActiveClass).length||s.hidden.push("find_route"),!0===e.data("locked")&&s.active.push("lock_system"),e.data("rallyUpdated")>0&&s.active.push("set_rally"),e.hasClass(l.config.systemActiveClass)&&s.disabled.push("find_route"),t(s)})},F=t=>{return new Promise(s=>{let n=c.defaultMenuOptionConfig();n.id=c.config.mapContextMenuId,n.selectCallback=_;let o=e(t.getContainer());a.getLocalStore("map").getItem(o.data("id")).then(e=>{e&&e.filterScopes&&(n.active=e.filterScopes.map(e=>"filter_"+e)),s(n)})})},U=e=>{return new Promise(a=>{let s=c.defaultMenuOptionConfig();s.id=c.config.connectionContextMenuId,s.selectCallback=k;let n=e.scope;"abyssal"===n?(s.hidden.push("wh_eol"),s.hidden.push("preserve_mass"),s.hidden.push("change_status"),s.hidden.push("wh_jump_mass_change"),s.hidden.push("change_scope"),s.hidden.push("separator")):"stargate"===n?(s.hidden.push("wh_eol"),s.hidden.push("preserve_mass"),s.hidden.push("change_status"),s.hidden.push("wh_jump_mass_change"),s.hidden.push("scope_stargate")):"jumpbridge"===n?(s.hidden.push("wh_eol"),s.hidden.push("preserve_mass"),s.hidden.push("change_status"),s.hidden.push("wh_jump_mass_change"),s.hidden.push("scope_jumpbridge")):"wh"===n&&s.hidden.push("scope_wh"),!0===e.hasType("wh_eol")&&s.active.push("wh_eol"),!0===e.hasType("preserve_mass")&&s.active.push("preserve_mass");for(let a of Object.keys(t.wormholeSizes))e.hasType(a)&&s.active.push(a);!0===e.hasType("wh_reduced")?s.active.push("status_reduced"):!0===e.hasType("wh_critical")?s.active.push("status_critical"):s.active.push("status_fresh"),e.getParameter("sizeLocked")&&s.disabled.push("wh_jump_mass_change"),a(s)})},z=e=>{return new Promise(t=>{let a=c.defaultMenuOptionConfig();a.id=c.config.endpointContextMenuId,a.selectCallback=D,!0===e.hasType("bubble")&&a.active.push("bubble"),t(a)})},R=(t,s)=>{s=e(s);let n=e(t.getContainer()),o=[l.config.mapSnapToGridDimension,l.config.mapSnapToGridDimension],i=null,c=!1;t.draggable(s,{containment:"parent",constrain:!0,filter:S,snapThreshold:l.config.mapSnapToGridDimension,start:function(t){let a=e(t.el);a.css("pointer-events","none"),(i=r.getMapOverlay(a,"timer")).startMapUpdateCounter(),n.hasClass(l.config.mapGridClass)?t.drag.params.grid=o:delete t.drag.params.grid;let s=n.getSelectedSystems().get();s=s.concat(a.get()),s=e.unique(s),e(s).toggleSystemTooltip("hide",{}),e(s).destroyPopover(!0),e(s).updateSystemZIndex()},drag:function(e){c||requestAnimationFrame(()=>{i.startMapUpdateCounter(),u.executeAtEvent(t,e.e),c=!1}),c=!0},stop:function(t){let a=e(t.el);i.startMapUpdateCounter(),a.toggleSystemTooltip("show",{show:!0}),l.markAsChanged(a);let s=a.position(),n="top";s.top<100&&(n="bottom"),s.left<100&&(n="right"),a.find("."+f.systemHeadNameClass).editable("option","placement",n),t.selection.forEach(t=>{l.markAsChanged(e(t[0]).css("pointer-events","initial"))})}}),!0===s.data("locked")&&t.setDraggable(s,!1);s.id;a.singleDoubleClick(s[0],function(a){let s=!1;if(e(a.target).closest(".popover").length&&(s=!0),!s){let s=e(this);1===a.which&&(!0===a.ctrlKey?l.toggleSystemsSelect(t,[s]):l.showSystemInfo(t,s))}},function(t){t.stopPropagation();let a=e(this),s=e(t.target);(s=s.hasClass(f.systemHeadNameClass)?a.find("."+f.systemHeadNameClass):a.find("."+f.systemHeadTagClass)).hasClass("editable")&&(e(a).updateSystemZIndex(),s.editable("show"))})},V=(e,t,a,s=null)=>B(e,t,a,s);e.fn.selectAllSystems=function(){return this.each(function(){let t=e(this),s=q(t.data("id")),n=t.find("."+f.systemClass+":not(."+f.systemSelectedClass+"):not(."+l.config.systemHiddenClass+")");n=n.filter(function(t,a){return!0!==e(a).data("locked")}),l.toggleSystemsSelect(s,n),a.showNotify({title:n.length+" systems selected",type:"success"})})},e.fn.toggleLockSystem=function(t,s){let n=e(this),o=s.map,i=!1;!0===s.hideNotification&&(i=!0);let c=!1;!0===s.hideCounter&&(c=!0);let d=n.getSystemInfo(["alias"]);!0===n.data("locked")?(n.data("locked",!1),n.removeClass(l.config.systemLockedClass),o.setDraggable(n,!0),i||a.showNotify({title:"System unlocked",text:d,type:"unlock"})):(n.data("locked",!0),n.addClass(l.config.systemLockedClass),o.setDraggable(n,!1),i||a.showNotify({title:"System locked",text:d,type:"lock"})),v(o,n),c||r.getMapOverlay(n,"timer").startMapUpdateCounter()};let q=function(s){if(!l.existsMapInstance(s)){jsPlumb.Defaults.LogEnabled=!0;let n=jsPlumb.getInstance({Anchor:["Continuous",{faces:["top","right","bottom","left"]}],Anchors:[["Continuous",{faces:["top","right","bottom","left"]}],["Continuous",{faces:["top","right","bottom","left"]}]],Container:null,PaintStyle:{strokeWidth:4,stroke:"#3c3f41",outlineWidth:2,outlineStroke:"#63676a",dashstyle:"0","stroke-linecap":"round"},Endpoint:["Dot",{radius:5}],Endpoints:[["Dot",{radius:5,cssClass:f.endpointSourceClass}],["Dot",{radius:5,cssClass:f.endpointTargetClass}]],EndpointStyle:{fill:"#3c3f41",stroke:"#63676a",strokeWidth:2},EndpointStyles:[{fill:"#3c3f41",stroke:"#63676a",strokeWidth:2},{fill:"#3c3f41",stroke:"#63676a",strokeWidth:2}],Connector:["Bezier",{curviness:40}],ReattachConnections:!1,Scope:t.defaultMapScope,LogEnabled:!0});n.registerEndpointTypes(b.endpointTypes),n.registerConnectionTypes(b.connectionTypes),n.bind("beforeDrop",function(t){let a=t.connection,s=t.dropEndpoint,o=t.sourceId,c=t.targetId;if(o===c)return console.warn("Source/Target systems are identical"),!1;if(s.connections.length>0)return console.warn("Endpoint already occupied"),!1;let d=e("#"+o),r=e("#"+c);return 3!==d.data("typeId")&&3!==r.data("typeId")||T(a,"abyssal"),a.suspendedElement||l.addConnectionTypes(a,[l.getDefaultConnectionTypeByScope(a.scope)]),l.checkForConnection(n,o,c).length>1&&i.confirm("Connection already exists. Do you really want to add an additional one?",e=>{!e&&a._jsPlumb&&a._jsPlumb.instance.detach(a)}),A(a).catch(console.warn),!0}),n.bind("beforeStartDetach",function(e){return!0}),n.bind("beforeDetach",function(e){return!0}),n.bind("connection",function(e,t){}),n.bind("click",function(e,t){e instanceof jsPlumb.Connection&&((e,t)=>{if(1===t.which){let s=e._jsPlumb.instance;if(!0===t.ctrlKey){let t=l.getConnectionsByType(s,"state_active");t.length>=f.maxActiveConnections&&!e.hasType("state_active")?a.showNotify({title:"Connection select limit",text:"You can´t select more connections",type:"warning"}):t.length>0?l.toggleConnectionActive(s,[e]):l.showConnectionInfo(s,[e])}else l.showConnectionInfo(s,[e])}})(e,t)}),n.bind("connectionMoved",function(e,t){}),n.bind("connectionDrag",function(e,t){}),n.bind("connectionDetached",function(e,t){let a=e.connection;l.deleteConnections([a])}),n.bind("contextmenu",function(e,t){H(e).then(a=>{let s={component:e};c.openMenu(a,t,s)})}),n.bind("zoom",function(e){d.updateZoomOverlay(this),1===e?a.getLocalStore("map").removeItem(`${s}.mapZoom`):a.getLocalStore("map").setItem(`${s}.mapZoom`,e)}),n.bind("checkDropAllowed",function(e){e.sourceEndpoint;return 0===e.targetEndpoint.connections.length}),l.setMapInstance(s,n)}return l.getMapInstance(s)},$=t=>{let s=e(t.getContainer());d.initMapDebugOverlays(t),s.on("contextmenu",function(s){s.preventDefault(),s.stopPropagation(),e(s.target).hasClass(a.config.mapClass)&&H(t).then(e=>{let a={component:t};c.openMenu(e,s,a)})}),s.on("contextmenu","."+f.systemClass,function(t){t.preventDefault(),t.stopPropagation();let a=e(t.currentTarget);H(a).then(e=>{let s={component:a};c.openMenu(e,t,s)})});new n({target:s[0],selectables:"."+f.systemClass+":not(."+l.config.systemLockedClass+"):not(."+l.config.systemHiddenClass+")",selectedClass:l.config.systemSelectedClass,selectBoxClass:"pf-map-drag-to-select",boundary:".mCSB_container_wrapper",onShow:()=>{a.triggerMenuAction(document,"Close")},onHide:e=>{let n=s.getSelectedSystems();if(n.length>0){a.showNotify({title:n.length+" systems selected",type:"success"});for(let e=0;e<n.length;e++)t.addToDragSelection(n[e])}for(let a=0;a<e.length;a++)t.removeFromDragSelection(e[a])},debug:!1,debugEvents:!1});s.hoverIntent({over:function(t){let a=e(this).closest("."+f.systemClass),s=l.getMapInstance(a.attr("data-mapid")),n=a.attr("id"),o=a.find("."+f.systemBodyClass);a.updateSystemZIndex();let i=parseInt(a.data("userCount"))*f.systemBodyItemHeight,c=a[0].clientWidth,d=c>150?c:150;o.velocity("stop").velocity({height:i+"px",width:d,"min-width":"150px"},{easing:"easeOut",duration:60,progress:function(){s.revalidate(n)},complete:function(){s.revalidate(n);let t=e(this),a=d-50-10-20;t.find("."+f.systemBodyItemNameClass).css({width:a+"px"}),t.find("."+f.systemBodyRightClass).show()}})},out:function(t){let a=e(this).closest("."+f.systemClass),s=l.getMapInstance(a.attr("data-mapid")),n=a.attr("id"),o=a.find("."+f.systemBodyClass);o.velocity("stop"),o.find("."+f.systemBodyRightClass).hide(),o.find("."+f.systemBodyItemNameClass).css({width:""}),o.velocity("reverse",{complete:function(){e(this).css({width:""}),s.revalidate(n)}})},selector:"."+f.systemClass+" ."+f.systemHeadExpandClass}),s.hoverIntent({over:function(t){e(this).tooltip({trigger:"manual",placement:"right",viewport:this.closest(`.${f.systemClass}`)}).tooltip("show")},out:function(t){e(this).tooltip("destroy")},selector:`.${f.systemClass} .fas[title]`}),s.hoverIntent({over:function(t){let s=e(this),n=s.closest("."+f.systemClass),o=n.data("mapid"),i=n.data("systemId"),l=a.getCurrentMapUserData(o),c=a.getCharacterDataBySystemId(l.data.systems,i);s.addSystemPilotTooltip(c,{trigger:"manual",placement:"right"}).setPopoverSmall().popover("show")},out:function(t){e(this).destroyPopover()},selector:"."+f.systemHeadCounterClass}),s.hoverIntent({over:function(t){let a=e(this),s=a.closest("."+f.systemClass),n=s.data("security"),o=s.data("effect");a.addSystemEffectTooltip(n,o,{trigger:"manual",placement:"right"}).setPopoverSmall().popover("show")},out:function(t){e(this).destroyPopover()},selector:"."+f.systemClass+" ."+l.getEffectInfoForSystem("effect","class")}),l.initWormholeInfoTooltip(s,"."+f.systemHeadInfoClass+' span[class^="pf-system-sec-"]',{placement:"right",smaller:!0}),s.hoverIntent({over:function(e){for(let e of t.selectEndpoints({element:this}).getOverlay(r.config.endpointOverlayId))e[0]instanceof jsPlumb.Overlays.Label&&e[0].fire("toggleSize",!0)},out:function(e){for(let e of t.selectEndpoints({element:this}).getOverlay(r.config.endpointOverlayId))e[0]instanceof jsPlumb.Overlays.Label&&e[0].fire("toggleSize",!1)},selector:"."+f.systemClass});let o=(t,s)=>{let n=C[s.option];a.getLocalStore("map").getItem(t.data("id")).then(function(t){let s="disabled",n=e("#"+this.mapOption.buttonId),o=!1;t&&t[this.data.option]&&(o=!0),o===this.data.toggle?(n.removeClass("active"),this.mapOption.class&&this.mapContainer.removeClass(l.config[this.mapOption.class]),this.mapOption.onDisable&&!this.data.skipOnDisable&&this.mapOption.onDisable(this.mapContainer),r.getMapOverlay(this.mapContainer,"info").updateOverlayIcon(this.data.option,"hide"),a.getLocalStore("map").removeItem(`${this.mapContainer.data("id")}.${this.data.option}`)):(n.addClass("active"),this.mapOption.class&&this.mapContainer.addClass(l.config[this.mapOption.class]),this.mapOption.onEnable&&!this.data.skipOnEnable&&this.mapOption.onEnable(this.mapContainer),r.getMapOverlay(this.mapContainer,"info").updateOverlayIcon(this.data.option,"show"),a.getLocalStore("map").setItem(`${this.mapContainer.data("id")}.${this.data.option}`,1),s="enabled"),this.data.toggle&&a.showNotify({title:this.mapOption.description,text:s,type:"info"})}.bind({data:s,mapOption:n,mapContainer:t}))},i=(s,n)=>{let o=l.getSystemId(s.data("id"),n.systemId),i=s.find("#"+o);if(1===i.length){let o=!1!==a.getObjVal(n,"forceSelect");if(!o){let t=(t=>{let s=null;if(t.length&&(t=t[0],a.isDomElement(document.activeElement)&&document.activeElement!==document.body)){let n=document.activeElement.tagName.toLocaleLowerCase(),o=["input","select","textarea"].includes(n),i=t.contains(document.activeElement);if(o&&i)s=n;else if(a.isDomElement(document.querySelector(".bootbox")))s="dialogOpen";else if(a.isDomElement(document.querySelector(".editable-open")))s="xEditableOpen";else{let n=t.querySelector("."+a.config.summernoteClass);a.isDomElement(n)&&"object"==typeof e(n).data().summernote&&(s="SummernoteOpen")}}return s})(l.getTabContentElementByMapElement(i));null!==t?console.info("Skip auto select systemId %i. Reason: %o",n.systemId,t):o=!0}if(o){let e=s.closest("."+a.getMapTabContentAreaClass("map"));g.scrollToCenter(e,i),l.showSystemInfo(t,i)}}};s.on("pf:menuAction",(e,a,n)=>{if(e.target===e.currentTarget)switch(e.stopPropagation(),a){case"MapOption":o(s,n);break;case"SelectSystem":i(s,n);break;case"AddSystem":p.showNewSystemDialog(t,n,"function"==typeof n.callback?n.callback:V);break;default:console.warn("Unknown menuAction %o event name",a)}else console.warn("Unhandled menuAction %o event name. Handled menu events should not bobble up",a)}),s.on("pf:deleteSystems",function(e,a){p.deleteSystems(t,a.systems,a.callback)}),s.on("pf:unlocked",function(){let t=e(this).data("id"),s=h.indexOf(t);if(-1!==s){let e=a.getCurrentMapData(t);e&&x(e),h.splice(s,1)}}),s.on("pf:updateLocal",function(t,s){let n=a.getObjVal(s,"config.id")||0;if(n){let t=e(this),o=r.getMapOverlay(t,"local"),i=a.getCurrentMapData(n),c=a.getCurrentCharacterData("log"),d=!0;if(i&&c&&c.system){let e=i.data.systems.filter(e=>e.systemId===c.system.id);if(e.length){e=e[0];let t=a.getNearBySystemData(e,i,l.config.defaultLocalJumpRadius),n=a.getNearByCharacterData(t,s.data.systems);o.updateLocalTable(e,n),d=!1}}d&&o.clearLocalTable()}})};e.fn.getSystemInfo=function(t){let a=[];for(let s=0;s<t.length;s++)switch(t[s]){case"alias":let n=e(this).find("."+f.systemHeadNameClass),o="";n.hasClass("editable")&&(o=n.editable("getValue",!0)),a.push(o);break;case"tag":let i=e(this).find("."+f.systemHeadTagClass),l="";i.hasClass("editable")&&(l=i.editable("getValue",!0)),a.push(l);break;default:a.push("bad system query")}return 1===a.length?a[0]:a};let G=(t,a=[],s=!1)=>{let n=!1;return r.isMapCounterOverlayActive(t)||(n=e(t).getMapDataFromClient(a,s)),n};e.fn.getMapDataFromClient=function(t=[],a=!1){let s=e(this),n=q(s.data("id")),o=t.includes("hasId"),i=t.includes("hasChanged"),c={};c.config={id:parseInt(s.data("id")),name:s.data("name"),scope:{id:parseInt(s.data("scopeId"))},icon:s.data("icon"),type:{id:parseInt(s.data("typeId"))},created:parseInt(s.data("created")),updated:parseInt(s.data("updated"))};let d={},r=[],p=s.getSystems();for(let t=0;t<p.length;t++){let s=e(p[t]);i&&!l.hasChanged(s)||r.push(s.getSystemData(a))}d.systems=r;let m=[],u=n.getAllConnections();for(let e=0;e<u.length;e++){let t=u[e];j(c.config.id,t),i&&!l.hasChanged(t)||(o&&!t.getParameter("connectionId")||m.push(l.getDataByConnection(t,a)))}return d.connections=m,c.data=d,c},e.fn.getSystemData=function(t=!1){let a=e(this),s=a.data(),n={id:parseInt(s.id),updated:{updated:parseInt(s.updated)}};if(!t){let e={systemId:parseInt(s.systemId),name:s.name,alias:a.getSystemInfo(["alias"]),tag:a.getSystemInfo(["tag"]),effect:s.effect,type:{id:s.typeId},security:s.security,trueSec:s.trueSec,region:{id:s.regionId,name:s.region},constellation:{id:s.constellationId,name:s.constellation},status:{id:s.statusId},locked:s.locked?1:0,rallyUpdated:s.rallyUpdated||0,rallyPoke:s.rallyPoke?1:0,currentUser:s.currentUser,planets:s.planets,shattered:s.shattered?1:0,drifter:s.drifter?1:0,statics:s.statics,userCount:parseInt(s.userCount)||0,position:l.getSystemPosition(a)},t=["sovereignty"];for(let s of t){let t=a.data(s);null!==t&&void 0!==t&&(e[s]=t)}n=Object.assign(n,e)}return n};let Z=t=>{let n,i=t.find("."+a.config.mapClass),l=i.data("id");g.initScrollbar(t,{callbacks:{onInit:function(){let e=this;o.addEventListener(this,"update:dragSelect",function(t){t.stopPropagation();let a=(n=t.detail).getIntersection(),s=n._selectBox.dataset.origin,o=s?s.split("|",2):[],i=[null,null],l=(e,t)=>e[((t+2)%e.length+e.length)%e.length];["top","right","bottom","left"].forEach((e,t,s)=>{o.includes(e)&&a.includes(e)?i[t%2]=e:o.includes(e)&&a.includes(l(s,t))&&(i[t%2]=l(s,t))}),g.autoScroll(e,i)},{capture:!0});let t=[0,0],a=[0,0],l=[0,0],c=0,d=e=>{i.toggleClass("disabled",e).toggleClass("pf-map-move",e)},r=()=>{if(s.isActive(" ")){let e=[Math.max(0,t[0]-l[0]),Math.max(0,t[1]-l[1])];e[0]===Math.abs(this.mcs.left)&&e[1]===Math.abs(this.mcs.top)||g.scrollToPosition(this,[e[1],e[0]],{scrollInertia:0,scrollEasing:"linear",timeout:5}),c=requestAnimationFrame(r)}};this.addEventListener("keydown",function(e){32===e.keyCode&&(e.preventDefault(),d(!0))},{capture:!1}),this.addEventListener("keyup",function(e){32===e.keyCode&&(e.preventDefault(),d(!1))},{capture:!1}),this.addEventListener("mousemove",function(e){c&&(l[0]=e.clientX-a[0],l[1]=e.clientY-a[1]),d(s.isActive(" "))},{capture:!1}),this.addEventListener("mousedown",function(e){!c&&1===e.which&&s.isActive(" ")&&(t[0]=Math.abs(this.mcs.left),t[1]=Math.abs(this.mcs.top),a[0]=e.clientX,a[1]=e.clientY,d(!0),c=requestAnimationFrame(r))},{capture:!1}),this.addEventListener("mouseup",function(e){1===e.which&&(cancelAnimationFrame(c),c=0,t=[0,0],a=[0,0],l=[0,0])},{capture:!1})},onScroll:function(){i.attr("data-scroll-left",this.mcs.left),i.attr("data-scroll-top",this.mcs.top),a.getLocalStore("map").setItem(`${l}.scrollOffset`,{x:Math.abs(this.mcs.left),y:Math.abs(this.mcs.top)})},onScrollStart:function(){e(this).find(".editable.editable-open").editable("hide"),e(this).find("."+f.systemHeadClass+" .fa").tooltip("hide")},whileScrolling:function(){n&&n.update()}}}),t.initMapOverlays(),t.initLocalOverlay(l)};return{getMapInstance:q,loadMap:(t,s,n)=>{let o=!1;return new Promise((e,a)=>{jsPlumb.ready(()=>{s.map=q(s.config.id),void 0===s.map.getContainer()?(o=!0,E(t,s).then(e=>x(e.data.mapConfig)).then(t=>e(t))):x(s).then(t=>e(t))})}).then(t=>((t,s)=>new Promise((n,o)=>{let i={action:"initMapOptions",data:{mapConfig:t}};if(s.showAnimation){let s=e(t.map.getContainer());l.setMapDefaultOptions(s,t.config).then(e=>l.visualizeMap(s,"show")).then(e=>l.zoomToDefaultScale(t.map)).then(e=>l.scrollToDefaultPosition(t.map)).then(e=>{a.showNotify({title:"Map initialized",text:t.config.name+" - loaded",type:"success"})}).then(()=>n(i))}else n(i)}))(t.data.mapConfig,n)).then(e=>({action:"loadMap",data:e.data,isFirstLoad:o}))},updateUserData:(t,s)=>{return new Promise((t,n)=>{let o={action:"updateUserData"},i=q(s.config.id),c=i.getContainer();if(void 0!==c){if(!0===(c=e(c)).data("frozen"))return t(o);let n=c.hasClass(l.config.systemCompactClass),d=a.getObjVal(a.getCurrentCharacterData("log"),"system.id")||0,r={mapId:s.config.id,userCountInside:0,userCountOutside:0,userCountInactive:0},p=!1;for(let t of c.find("."+f.systemClass)){let a=(t=e(t)).data("systemId"),o=null,l=!1,c=s.data.systems.length;for(;c--;){let e=s.data.systems[c];a===e.id&&(o=e,r.userCountInside+=o.user.length,s.data.systems.splice(c,1))}!p&&d&&d===a&&(l=!0,p=!0),I(i,t,o,l,{compactView:n})}for(let e of s.data.systems)e.id?r.userCountOutside+=e.user.length:r.userCountInactive+=e.user.length;e(document).trigger("pf:updateHeaderMapData",r)}t(o)})},getMapDataForSync:G,saveSystemCallback:V,drawConnection:M,saveConnection:A}});
//# sourceMappingURL=map.js.map
