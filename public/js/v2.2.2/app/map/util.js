define(["jquery","app/init","app/util","app/map/layout","app/map/scrollbar","app/map/overlay/util"],(e,t,a,s,n,o)=>{"use strict";let i={mapSnapToGridDimension:20,defaultLocalJumpRadius:3,zoomMax:1.5,zoomMin:.5,mapGridClass:"pf-grid-small",systemRegionClass:"pf-map-region",systemCompactClass:"pf-map-compact",systemIdPrefix:"pf-system-",systemClass:"pf-system",systemActiveClass:"pf-system-active",systemSelectedClass:"pf-system-selected",systemLockedClass:"pf-system-locked",systemHiddenClass:"pf-system-hidden",tableCellEllipsisClass:"pf-table-cell-ellipsis",tableCellEllipsis80Class:"pf-table-cell-80",tableCellEllipsis90Class:"pf-table-cell-90",tableCellEllipsis100Class:"pf-table-cell-100"},r={},l=e=>"object"==typeof r[e],c=(e,a)=>{let s="";return t.classes.systemInfo.hasOwnProperty(e)&&(s=t.classes.systemInfo[e][a]),s},p=(e,t,s="id")=>(a.getObjVal(e,"data.systems")||[]).find(e=>e[s]===t)||!1,d=(e,t,s="id")=>p(a.getCurrentMapData(e),t,s),m=(e,t,s="id")=>(a.getObjVal(e,"data.connections")||[]).find(e=>e[s]===t)||!1,u=(e,s)=>a.getObjVal(t.classes.systemEffects,`${e}.${s}`)||"";e.fn.getSystems=function(){return this.find("."+i.systemClass)},e.fn.getSelectedSystems=function(){return e(this).find("."+i.systemSelectedClass)};let g=e=>{return e.diff(["","default","info_signature","state_active","state_process"])},f=(e,t)=>t.element===e.source?"source":t.element===e.target&&"target",y=(e,t)=>({label:f(e,t),types:g(t.getType())}),h=(e,t,a=!1)=>{let s=[];for(let n of e.select().hasType(t))n[0]!==a&&s.push(n[1]);return s},C=e=>{let t={source:{},target:{}};for(let a of e.endpoints){let s=y(e,a);"source"===s.label?t.source=s:"target"===s.label&&(t.target=s)}return t},b=(t,a=!1)=>{let s=e(t.source),n=e(t.target),o={id:t.getParameter("connectionId")||0,updated:t.getParameter("updated")||0,source:parseInt(s.data("id")),target:parseInt(n.data("id"))};return o=a?Object.assign(o,{connection:t}):Object.assign(o,{sourceName:s.data("name"),sourceAlias:s.getSystemInfo(["alias"])||s.data("name"),targetName:n.data("name"),targetAlias:n.getSystemInfo(["alias"])||n.data("name"),scope:t.scope,type:g(t.getType()),endpoints:C(t)})},S=t=>e(t).closest("."+a.config.mapTabContentClass),w=(t,a=1)=>{let s=!1;if(a!==t.getZoom()){let n=[0,0],o=t.getContainer(),i=["webkit","moz","ms","o"],r="scale("+a+")",l=100*n[0]+"% "+100*n[1]+"%";for(let e=0;e<i.length;e++)o.style[i[e]+"Transform"]=r,o.style[i[e]+"TransformOrigin"]=l;o.style.transform=r,o.style.transformOrigin=l,s=t.setZoom(a);let c=o.getBoundingClientRect().width,p=o.getBoundingClientRect().height,d=e(o),m=d.outerWidth(),u=d.outerHeight(),g=d.parents(".mCSB_container_wrapper").outerWidth(),f=d.parents(".mCSB_container_wrapper").outerHeight(),y=1===a||m!==c&&c>g,h=1===a||u!==p&&p>f;d.parents(".mCSB_container").css({width:y?c+"px":g-50+"px",height:h?p+"px":f+"px"});let C=d.closest(".mCustomScrollbar");y&&h?C.mCustomScrollbar("update"):C.mCustomScrollbar("scrollTo","#"+d.attr("id"),{scrollInertia:0,scrollEasing:"linear",timeout:0,moveDragger:!1})}return s},v=(e,t,a)=>{a?(t.addClass(i.systemSelectedClass),e.addToDragSelection(t)):(t.removeClass(i.systemSelectedClass),e.removeFromDragSelection(t))},I=(e,t)=>{[...e.getContainer().getElementsByClassName(i.systemClass)].forEach(e=>e.classList.remove(i.systemActiveClass)),t.addClass(i.systemActiveClass);let s=t.getSystemData();s.mapId=parseInt(t.attr("data-mapid"))||0,a.setCurrentSystemData(s.mapId,s)},T=(t,a,s)=>{t=e(t),s||v(a,t,!1),t.toggleClass(i.systemHiddenClass,!s)},O=(e,t,a=[],s=[],n=!1)=>{if(t&&a.length){let i,r;!a.includes("info_signature")&&t.hasType("info_signature")&&(i=t.getOverlay(o.config.connectionOverlayArrowId))&&(r={direction:i.direction,foldback:i.foldback});for(let o=0;o<a.length;o++)t[e](a[o],"object"==typeof s[o]?s[o]:{},n);!i||i.direction===r.direction&&i.foldback===r.foldback||(i.updateFrom(r),n||t.repaint())}},M=(e,t,a,s=!1)=>{_(e,[t],"object"==typeof a?[a]:[],s)},_=(e,t=[],a=[],s=!1)=>{e&&O("addType",e,t.diff(e.getType()),a,s)},k=(e,t,a,s=!1)=>{D(e,[t],"object"==typeof a?[a]:[],s)},D=(e,t=[],a=[],s=!1)=>{e&&O("removeType",e,t.intersect(e.getType()),a,s)},j=(e,t)=>{if(e.isVisible()!==t){e.setVisible(t,!0);for(let a of e.endpoints)a.setVisible(t,!0)}},x=(t,a,s)=>{let n=e(t.getContainer());e(document).trigger("pf:updateConnectionInfoModule",{connectionsUpdate:a,connectionsRemove:s,mapId:parseInt(n.data("id"))})},P=(e,t,a,s=!1)=>{let n=[],o=void 0===t?["*"]:Array.isArray(t)?t:[t],i=void 0===a?[]:Array.isArray(a)?a:[a];return e.select({scope:o}).each(function(e){if(!s||e.isVisible())if(i.length>0){for(let t=0;t<i.length;t++)if(e.hasType(i[t])){n.push(e);break}}else n.push(e)}),n},A=(e,a)=>{let s="";return t.connectionTypes.hasOwnProperty(e)&&(s=t.connectionTypes[e][a]),s},E=()=>["wh_fresh","wh_reduced","wh_critical"],R=()=>["wh_jump_mass_s","wh_jump_mass_m","wh_jump_mass_l","wh_jump_mass_xl"],B=(e,t,a)=>{t=a.includes(t)?[t]:[],e._jsPlumb.instance.setSuspendDrawing(!0);let s=e._jsPlumb.instance.isSuspendDrawing();D(e,a.diff(t),[],s),_(e,t,[],s),e._jsPlumb.instance.setSuspendDrawing(!1,!0)};e.fn.setSystemRally=function(t,s){t=t||0;let n=!1;return s=e.extend({},{poke:!1,hideNotification:!1,hideCounter:!1},s),this.each(function(){let i=e(this),r=i.data("rallyUpdated")||0;if(t!==r){s.hideCounter||o.getMapOverlay(i,"timer").startMapUpdateCounter();let e=c("rally","class");if(t>0){i.addClass(e),n=s.poke;let o={title:"Rally Point",text:"System: "+i.data("name")};if(1===t)o.type="success",a.showNotify(o);else if(s.poke){let e=i.data("mapid"),s=i.data("id");a.getLocalStore("map").getItem(e).then(function(n){let i={};n&&n.rallyPoke&&(i=n.rallyPoke),i.hasOwnProperty(this.systemId)&&i[this.systemId]===t||(i[this.systemId]=t,a.getLocalStore("map").setItem(`${this.mapId}.rallyPoke`,i),o.type="info",a.showNotify(o,{desktop:!0,stack:"barBottom",click:t=>{window.location.href=U(e,s)}}))}.bind({mapId:e,systemId:s,rallyUpdated:t}))}l=i.parents("."+a.config.mapClass),p={systemId:i.data("systemId"),name:i.data("name"),rally:1},S(l).trigger("pf:updateRouteModules",{mapId:parseInt(l.data("id")),payload:{task:"findRoute",systemToData:p}})}else i.removeClass(e),s.hideNotification||a.showNotify({title:"Rally point removed",type:"success"})}var l,p;i.data("rallyUpdated",t),i.data("rallyPoke",n)})},e.fn.setMapShortcuts=function(){return this.each((t,s)=>{let n=(s=e(s)).find("."+a.config.mapClass),o=require("app/map/map"),i=require("app/map/system"),r=o.getMapInstance(n.data("id"));s.watchKey("mapSystemAdd",e=>{i.showNewSystemDialog(r,{position:{x:0,y:0}},o.saveSystemCallback)},{focus:!0}),s.watchKey("mapSystemsSelect",e=>{n.selectAllSystems()},{focus:!0}),s.watchKey("mapSystemsDelete",t=>{let a=n.getSelectedSystems();e.fn.showDeleteSystemDialog(r,a)},{focus:!0})})},e.fn.addSystemPilotTooltip=function(t,s){let n={placement:"top",html:!0,trigger:"hover",container:"body",title:"Pilots",content:a.getSystemPilotsTable(t),delay:{show:150,hide:0}};return s=e.extend({},n,s),this.each(function(){e(this).popover(s)})},e.fn.addStationServiceTooltip=function(t,s){let n=e=>{switch(e){case"bounty-missions":case"assasination-missions":case"courier-missions":case"interbus":return!1;case"reprocessing-plant":return"reprocess";case"refinery":return!1;case"market":return"market";case"black-market":case"stock-exchange":return!1;case"cloning":return"clonebay";case"surgery":case"dna-therapy":return!1;case"repair-facilities":return"repairshop";case"factory":return"industry";case"labratory":return"research";case"gambling":return!1;case"fitting":return"fitting";case"paintshop":return"skins";case"news":case"storage":return!1;case"insurance":return"insurance";case"docking":return"docking";case"office-rental":return!1;case"jump-clone-facility":return"jumpclones";case"loyalty-point-store":return"lpstore";case"navy-offices":return"factionalwarfare";case"security-offices":return"concord";default:return!1}},o=(e=>{let t="";for(let s=0;s<e.length;s++){let o=n(e[s]);o&&(t+=`<img class="${a.config.popoverListIconClass}" src="${a.imgRoot()}icons/client/ui/window/${o}.png" alt="${e[s]}">`)}return t})(t),i={placement:"top",html:!0,trigger:"hover",container:"body",title:'<i class="fas fa-tools fa-fw"></i>&nbsp;Services',content:"",delay:{show:150,hide:0}};return s=e.extend({},i,s),this.each(function(){let t=e(this);t.popover(s);let n=t.data("bs.popover");n.options.content=o,n.tip().addClass(a.config.popoverClass),s.show&&t.popover("show")})},e.fn.addSystemEffectTooltip=function(t,s,n){let o=u(s,"class"),i=a.getSystemEffectData(t,s),r=a.getAreaIdBySecurity(t),l={placement:"top",html:!0,trigger:"hover",container:"body",title:'<i class="fas fa-square fa-fw '+o+'"></i>&nbsp;'+u(s,"name")+"&nbsp;&nbsp;<kbd>"+a.getSystemEffectMultiplierByAreaId(parseInt(r))+'x</kbd><span class="pull-right '+a.getSecurityClassForSystem(t)+'">'+t+"</span>",content:a.getSystemEffectTable(i),delay:{show:150,hide:0}};return n=e.extend({},l,n),this.each(function(){e(this).popover(n)})},e.fn.addSystemPlanetsTooltip=function(t,s){let n={placement:"top",html:!0,trigger:"hover",container:"body",title:"Planets",content:a.getSystemPlanetsTable(t),delay:{show:150,hide:0}};return s=e.extend({},n,s),this.each(function(){if(t.length){let t=e(this);t.popover(s),s.show&&t.popover("show")}})},e.fn.addWormholeInfoTooltip=function(t,s){return this.each(function(){let n=e(this);requirejs(["text!templates/tooltip/wormhole_info.html","mustache"],(o,i)=>{let r={};t.massTotal?r.massTotal=a.formatMassValue(t.massTotal):r.massTotal='<span class="txt-color txt-color-grayLight">unknown</span>',t.massIndividual?r.massIndividual=a.formatMassValue(t.massIndividual):r.massIndividual='<span class="txt-color txt-color-grayLight">unknown</span>',t.massRegeneration&&(r.massRegeneration=a.formatMassValue(t.massRegeneration)),t.maxStableTime&&(r.maxStableTime=t.maxStableTime+" h"),t.scanWormholeStrength?r.scanWormholeStrength=parseFloat(t.scanWormholeStrength).toLocaleString()+"&nbsp;&#37;":r.scanWormholeStrength='<span class="txt-color txt-color-grayLight">unknown</span>';let l=t.name;t.size&&(l+="&nbsp;&nbsp;<kbd>"+t.size.label+"</kbd>"),t.security&&(l+='<span class="pull-right '+t.class+'">'+t.security+"</span>");let c=i.render(o,r),p={placement:"top",html:!0,trigger:"hover",container:"body",title:l,content:"",delay:{show:150,hide:0}};s=e.extend({},p,s),n.popover(s);let d=n.data("bs.popover");d.options.title=l,d.options.content=c,s.smaller&&n.setPopoverSmall(),s.show&&n.popover("show")})})};let L=(e,t)=>i.systemIdPrefix+e+"-"+t,F=(e={},t=1,a=!1)=>{let n={center:[0,30],loops:4,debug:!1};return e=Object.assign({},n,e),new s.Position(Object.assign({},n,e)).findNonOverlappingDimensions(t,a)},V=e=>{let t=e.parent(),a=[i.mapSnapToGridDimension,i.mapSnapToGridDimension],s={container:t[0],center:e[0],grid:!!t.hasClass(i.mapGridClass)&&a};return F(s)},z=(e,t={},a=1,s=!1)=>{let n=[i.mapSnapToGridDimension,i.mapSnapToGridDimension],o={container:e[0],center:[0,0],grid:!!e.hasClass(i.mapGridClass)&&n,loops:10,defaultGapX:10,defaultGapY:10};return t=Object.assign({},o,t),F(t,a,s)},G=(e,t=1)=>{let a={x:Math.abs(parseInt(e.attr("data-scroll-left"))||0),y:Math.abs(parseInt(e.attr("data-scroll-top"))||0)};a.y=Math.max(a.y,30);let s=[a],n=z(e,{center:[a.x,a.y],minX:a.x,minY:a.y},t,!0);return n.length&&(s=n.map(e=>({x:parseInt(e.left)||0,y:parseInt(e.top)||0}))),s},U=(e,t)=>{let a=location.protocol+"//"+location.host+"/map";return a+=e?"/"+encodeURIComponent(window.btoa(e)):"",a+=t?"_"+encodeURIComponent(window.btoa(t)):""};return{config:i,setMapInstance:(e,t)=>{r[e]=t},getMapInstance:e=>r[e],existsMapInstance:l,clearMapInstance:e=>{l(e)&&delete r[e]},getMapTypes:(e,s)=>{let n=Object.assign({},t.mapTypes);if(!0===e){let e=[];[{type:"private",hasRight:!1,selector:"id"},{type:"corporation",hasRight:!0,selector:"corporation.id"},{type:"alliance",hasRight:!1,selector:"alliance.id"}].forEach(t=>{if(a.getCurrentCharacterData(t.selector)){let o=a.filterCurrentMapData("config.type.id",a.getObjVal(n,t.selector)),i=a.getObjVal(n,`${t.type}.defaultConfig.max_count`);o.length<i&&(t.hasRight&&s&&!a.hasRight(s,t.type)||e.push(t.type))}}),n=a.filterObjByKeys(n,e)}return Object.entries(n).forEach(([e,t])=>{t.name=e}),Object.keys(n).map(e=>n[e])},getMapScopes:()=>{let a=[];return e.each(t.mapScopes,function(e,t){let s=t;s.name=e,a.push(s)}),a},getScopeInfoForMap:(e,a)=>{let s="";return t.mapScopes.hasOwnProperty(e)&&(s=t.mapScopes[e][a]),s},getMapIcons:()=>t.mapIcons,getInfoForMap:(e,a)=>{let s="";return t.mapTypes.hasOwnProperty(e)&&(s=t.mapTypes[e][a]),s},getInfoForSystem:c,getSystemDataFromMapData:p,getSystemData:d,getConnectionDataFromMapData:m,getConnectionData:(e,t,s="id")=>m(a.getCurrentMapData(e),t,s),getSystemTypeInfo:(e,a)=>(Object.values(t.systemType).find(t=>t.id===e)||{})[a]||"",getEffectInfoForSystem:u,getSystemSecurityForDisplay:e=>{const t={"0.0":"ns",L:"ls",H:"hs",T:"tr"};return t.hasOwnProperty(e)?t[e]:e},getSystemSecurityForClass:e=>{if("tr"===e.toLowerCase().slice(0,2)||"a"===e[0].toLowerCase())var t=e[0];else if(e.length>2){var a=e.match(/[c|C][0-9]{1,2}/);t=null===a||0==a.length?e.slice(0,2):a[0].toUpperCase()}else t=e;const s={ns:"0.0",ls:"L",hs:"H",tr:"T"};return s.hasOwnProperty(t)?s[t]:t.toUpperCase()},markAsChanged:t=>{t instanceof e&&t.hasClass(i.systemClass)?t.data("changed",!0):t instanceof jsPlumb.Connection&&t.setParameter("changed",!0)},hasChanged:t=>{let a=!1;return t instanceof e&&t.hasClass(i.systemClass)?a=t.data("changed")||!1:t instanceof jsPlumb.Connection&&(a=t.getParameter("changed")||!1),a},toggleSystemsSelect:(t,a)=>{for(let s of a)!0!==(s=e(s)).data("locked")&&(s.hasClass(i.systemSelectedClass)?v(t,s,!1):v(t,s,!0))},addConnectionTypes:_,removeConnectionTypes:D,toggleConnectionType:(e,t,a,s=!1)=>{O("toggleType",e,[t],"object"==typeof a?[a]:[],s)},toggleConnectionActive:(e,t)=>{let a=[],s=[];e.setSuspendDrawing(!0);for(let e of t)e.hasType("state_active")?(k(e,"state_active"),s.push(e)):(M(e,"state_active"),a.push(e));e.setSuspendDrawing(!1,!0),x(e,a,s)},setSystemActive:I,showMapInfo:t=>{let a=e(t.getContainer());S(a).trigger("pf:renderGlobalModules",{mapId:parseInt(a.data("id")),payload:null})},showSystemInfo:(t,s)=>{I(t,s);let n=e(t.getContainer()),o=parseInt(n.data("id"))||0;S(n).trigger("pf:renderSystemModules",{mapId:o,payload:a.getCurrentSystemData(o)})},showConnectionInfo:(t,a)=>{((e,t)=>{e.setSuspendDrawing(!0);for(let a of h(e,"state_active"))t.includes(a)||k(a,"state_active");for(let e of t)e.hasType("state_active")||M(e,"state_active");e.setSuspendDrawing(!1,!0)})(t,a);let s=e(t.getContainer());S(s).trigger("pf:renderConnectionModules",{mapId:parseInt(s.data("id")),payload:a})},showFindRouteDialog:(e,t)=>{S(e).trigger("pf:updateRouteModules",{mapId:parseInt(e.data("id")),payload:{task:"showFindRouteDialog",systemToData:t}})},filterDefaultTypes:g,getEndpointLabel:f,getConnectionsByType:h,getEndpointsDataByConnection:C,getDataByConnection:b,getDataByConnections:e=>{let t=[];for(let a of e)t.push(b(a));return t},searchConnectionsBySystems:(t,a,s)=>{let n=[];return e.each(a,function(e,a){n=(n=n.concat(t.getConnections({scope:s,source:a}))).concat(t.getConnections({scope:s,target:a}))}),n},searchConnectionsByScopeAndType:P,getConnectionInfo:A,getConnectionFakeClassesByTypes:e=>{let t=["pf-fake-connection"];for(let a=0;a<e.length;a++)t.push(A(e[a],"cssClass"));return t},checkForConnection:(e,t,a)=>{let s=[];return s=(s=s.concat(e.getConnections({scope:"*",source:t,target:a}))).concat(e.getConnections({scope:"*",source:a,target:t}))},getDefaultConnectionTypeByScope:e=>{let t="";switch(e){case"wh":t="wh_fresh";break;case"jumpbridge":t="jumpbridge";break;case"stargate":t="stargate";break;case"abyssal":t="abyssal";break;default:console.error('Connection scope "'+e+'" unknown!')}return t},allConnectionMassStatusTypes:E,allConnectionJumpMassTypes:R,setConnectionMassStatusType:(e,t)=>{B(e,t,["wh_fresh","wh_reduced","wh_critical"])},setConnectionJumpMassType:(e,t)=>{B(e,t,["wh_jump_mass_s","wh_jump_mass_m","wh_jump_mass_l","wh_jump_mass_xl"])},getScopeInfoForConnection:(a,s)=>{let n="";if(t.connectionScopes.hasOwnProperty(a))switch(s){case"connectorDefinition":let o='{ "data": '+t.connectionScopes[a][s]+"}";n=e.parseJSON(o).data;break;default:n=t.connectionScopes[a][s]}return n},deleteConnections:(t,s)=>{if(t.length>0){let n=e=>{for(let t of e)t._jsPlumb.instance.deleteConnection(t,{fireEvent:!1})},o=t[0]._jsPlumb.instance,i=e(o.getContainer()),r=[];for(let e of t){e.addType("state_process");let t=e.getParameter("connectionId");void 0!==t&&r.push(t)}r.length>0&&a.request("DELETE","Connection",r,{mapId:i.data("id")},{connections:t}).then(e=>{for(let t of e.context.connections)t._jsPlumb&&t.removeType("state_process");let t=e.context.connections.filter(function(e){return e._jsPlumb&&-1!==this.indexOf(e.getParameter("connectionId"))},e.data);n(t),s&&s()},a.handleAjaxErrorResponse)}},getConnectionDataFromSignatures:(t,s)=>{let n={source:{ids:[],names:[],labels:[]},target:{ids:[],names:[],labels:[]},hash:!1};if(t&&s&&s.signatures){let o=require("module/system_signature"),i=t.endpoints[0],r=t.endpoints[1],l=e(i.element),c=e(r.element),p=l.data("id"),d=c.data("id");if(!p||!d)return n;let m=[];for(let e of s.signatures){m.push(a.getObjVal(e,"updated.updated"));let t=null,s=null;if(e.system.id===p?(s="source",t=l):e.system.id===d&&(s="target",t=c),n[s].ids.push(e.id),n[s].names.push(e.name.toUpperCase()),e.typeId>0&&t&&t){let i=o.getSignatureTypeOptionsBySystem(t,5),r=a.flattenXEditableSelectArray(i);if(r.hasOwnProperty(e.typeId)){let t=r[e.typeId];t=t.substr(0,t.indexOf(" ")),n[s].labels.push(t)}}}n.hash=m.join().hashCode()}return n},getEndpointOverlaySignatureLocation:(e,t)=>{let a=[.5,.5];if(!e.anchor.getCurrentFace)return a;{let s=t.length,n=s?1===s?-1:3:-.5,o=s?1===s?2.2:3:1.5;switch(e.anchor.getCurrentFace()){case"top":return[.5,-.75];case"left":return[n,.25];case"right":return[o,.25];case"bottom":return[.5,1.75];default:return a}}},formatEndpointOverlaySignatureLabel:e=>{let a="txt-color-grayLighter",s=e.join(", ");return 0===e.length?(s='<i class="fas fa-question-circle"></i>',a="txt-color-red"):1!==e.length||e.includes("K162")||(a=t.wormholes[e[0]].class),'<span class="txt-color '+a+'">'+s+"</span>"},getTabContentElementByMapElement:S,hasActiveConnection:e=>{return h(e,"state_active").length>0},filterMapByScopes:(t,a)=>{if(t){t.setSuspendDrawing(!0);let s=e(t.getContainer()),n=s.getSystems(),i=t.getAllConnections();if(a&&a.length){let r=[],l=P(t,a);for(let e of i)l.indexOf(e)>=0?(j(e,!0),r.indexOf(e.endpoints[0].element)<0&&r.push(e.endpoints[0].element),r.indexOf(e.endpoints[1].element)<0&&r.push(e.endpoints[1].element)):j(e,!1);let c=[];a.indexOf("wh")>=0&&c.push(1),a.indexOf("abyssal")>=0&&c.push(4);for(let a of n)c.indexOf(e(a).data("typeId"))>=0||r.indexOf(a)>=0?T(a,t,!0):T(a,t,!1);o.getMapOverlay(s,"info").updateOverlayIcon("filter","show")}else{for(let e of n)T(e,t,!0);for(let e of i)j(e,!0);o.getMapOverlay(s,"info").updateOverlayIcon("filter","hide")}t.setSuspendDrawing(!1,!0)}},changeZoom:(e,t)=>{let a=!1,s=e.getZoom();return"up"===t?s+=.1:s-=.1,(s=Math.round(10*s)/10)>=i.zoomMin&&s<=i.zoomMax&&(a=w(e,s)),a},setZoom:w,toggleSystemAliasEditable:e=>{e.find(".editable").editable("toggle")},visualizeMap:(e,t)=>{return new Promise((a,s)=>{o.getMapOverlay(e,"timer").startMapUpdateCounter();let n=e.find("."+i.systemClass),r=e.find(".jtk-endpoint:visible"),l=e.find(".jtk-connector:visible"),c=e.find(".jtk-overlay:visible, .tooltip"),p=e=>(e.length>0&&(e.addClass("pf-notransition"),e.css("opacity",0),e[0].offsetHeight,e.removeClass("pf-notransition")),e),d=n.add(r).add(l);"show"===t?(p(n),p(r),p(l),p(c),c.velocity("transition.fadeIn",{duration:60,display:"auto"}),d.length?d.velocity({translateY:[0,-20],opacity:[1,0]},{duration:150,easing:"easeOut",complete:function(){a({action:"visualizeMap",data:!1})}}):a({action:"visualizeMap",data:!1})):"hide"===t&&(c.velocity("transition.fadeOut",{duration:60,display:"auto"}),d.length?d.velocity({translateY:[-20,0],opacity:[0,1]},{duration:150,easing:"easeOut",complete:function(){a({action:"visualizeMap",data:!1})}}):a({action:"visualizeMap",data:!1}))})},setMapDefaultOptions:(t,s)=>{return new Promise((n,o)=>{e(document).trigger("pf:updateMenuOptions",{menuGroup:"mapOptions",payload:s}),a.triggerMenuAction(t,"MapOption",{option:"mapSnapToGrid",toggle:!1}),a.triggerMenuAction(t,"MapOption",{option:"mapMagnetizer",toggle:!1}),a.triggerMenuAction(t,"MapOption",{option:"systemRegion",toggle:!1}),a.triggerMenuAction(t,"MapOption",{option:"systemCompact",toggle:!1}),a.triggerMenuAction(t,"MapOption",{option:"connectionSignatureOverlays",toggle:!1,skipOnEnable:!0,skipOnDisable:!0}),n({action:"setMapDefaultOptions",data:!1})})},getSystemPosition:e=>{let t=e.css("left"),a=e.css("top");return{x:parseInt(t.substring(0,t.length-2)),y:parseInt(a.substring(0,a.length-2))}},scrollToDefaultPosition:t=>{return new Promise(s=>{let o={action:"scrollToDefaultPosition",data:!1};if(1===t.getZoom()){let i=e(t.getContainer());a.getLocalStore("map").getItem(i.data("id")).then(e=>{if(e&&e.scrollOffset){let t=i.closest("."+a.getMapTabContentAreaClass("map"));n.scrollToPosition(t,[e.scrollOffset.y,e.scrollOffset.x])}s(o)})}else s(o)})},zoomToDefaultScale:t=>{return new Promise(s=>{let n=e(t.getContainer());a.getLocalStore("map").getItem(n.data("id")).then(e=>{e&&e.mapZoom&&w(t,e.mapZoom),s({action:"zoomToDefaultScale",data:!1})})})},initWormholeInfoTooltip:(s,n,o={})=>{o=Object.assign({},{trigger:"manual",placement:"top",smaller:!1,show:!0},o),s.hoverIntent({over:function(s){let n=e(this),i=n.attr("data-name"),r=a.getObjVal(t,"wormholes."+i);r&&n.addWormholeInfoTooltip(r,o)},out:function(t){e(this).destroyPopover()},selector:n})},getSystemId:L,checkRight:(e,t)=>{let s=!1,n=a.getObjVal(t,"type.name"),o=a.getCurrentUserInfo(n+"Id");if((a.getObjVal(t,"access."+("private"===n?"character":n))||[]).some(e=>e.id===o))switch(n){case"private":s=!0;break;case"corporation":s=a.hasRight(e,n);break;case"alliance":s=!0}return s},newSystemPositionBySystem:V,newSystemPositionByCoordinates:z,newSystemPositionsByMapOffset:G,newSystemPositionsByMap:t=>{let s={};if(t){let n=t.data("id");s.defaults=G(t,2);let o=a.getCurrentLocationData();if(o.id){let t=d(n,o.id,"systemId");if(t){let a=e("#"+L(n,t.id));if(a.length){let e=V(a);e.length&&(s.location={systemId:o.id,position:{x:e[0].left,y:e[0].top}})}}}}return Object.keys(s).length?s:null},getMapDeeplinkUrl:U}});
//# sourceMappingURL=util.js.map
