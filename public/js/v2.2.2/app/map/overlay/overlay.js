define(["jquery","app/init","app/util","app/map/overlay/util","app/map/util","app/lib/cron"],(e,t,a,n,o,i)=>{"use strict";let s=e=>o.getMapInstance(n.getMapElementFromOverlay(e).data("id")),r=(e,t)=>{let a=t.labels,i=t.names,s=e.getOverlay(n.config.endpointOverlayId);s instanceof jsPlumb.Overlays.Label?a.equalValues(s.getParameter("signatureLabels"))&&i.equalValues(s.getParameter("signatureNames"))||(s.setLabel(o.formatEndpointOverlaySignatureLabel(a)),s.setParameter("fullSize",!1),s.setParameter("signatureLabels",a),s.setParameter("signatureNames",i),s.updateClasses(a.length?"small":"icon",a.length?"icon":"small"),s.setLocation(o.getEndpointOverlaySignatureLocation(e,a))):e.addOverlay(["Label",{label:o.formatEndpointOverlaySignatureLabel(a),id:n.config.endpointOverlayId,cssClass:[n.config.componentOverlayClass,a.length?"small":"icon"].join(" "),location:o.getEndpointOverlaySignatureLocation(e,a),events:{toggleSize:function(e){let t=this.getParameter("signatureNames");e&&!this.getParameter("fullSize")&&t.length?(this.setLabel(this.getLabel()+'<br><span class="initialism">'+t.join(", ")+"</span>"),this.setParameter("fullSize",!0)):this.getParameter("fullSize")&&(this.setLabel(o.formatEndpointOverlaySignatureLabel(this.getParameter("signatureLabels"))),this.setParameter("fullSize",!1))}},parameters:{fullSize:!1,signatureLabels:a,signatureNames:i}}])},l={filter:{title:"active filter",trigger:"active",class:"pf-map-overlay-filter",iconClass:["fas","fa-fw","fa-filter"],onClick:function(e){let t=n.getMapElementFromOverlay(this),i=s(this);a.getLocalStore("map").setItem(`${t.data("id")}.filterScopes`,[]),o.filterMapByScopes(i,[])}},mapSnapToGrid:{title:"grid",trigger:"active",class:"pf-map-overlay-grid",iconClass:["fas","fa-fw","fa-th"]},mapMagnetizer:{title:"magnetizer",trigger:"active",class:"pf-map-overlay-magnetizer",iconClass:["fas","fa-fw","fa-magnet"]},systemRegion:{title:"regions",trigger:"active",class:"pf-map-overlay-region",iconClass:["fas","fa-fw","fa-map-marked-alt"]},systemCompact:{title:"compact layout",trigger:"active",class:"pf-map-overlay-compact",iconClass:["fas","fa-fw","fa-compress"]},connectionSignatureOverlays:{title:"signature overlays",trigger:"active",class:"pf-map-overlay-endpoint",iconClass:["fas","fa-fw","fa-link"]},systemPopover:{title:"sovereignty",trigger:"hover",class:"pf-map-overlay-popover",iconClass:["fas","fa-fw","fa-landmark"],hoverIntent:{over:function(t){let o=n.getMapElementFromOverlay(this);o.find("."+n.config.systemHeadClass).each(function(){let t=e(this);if(!t.data("bs.popover")){let e=t.parent().data(),n=a.getObjVal(e,"sovereignty");n&&t.popover({placement:"bottom",html:!0,trigger:"manual",container:o,title:!1,content:a.getSystemSovereigntyTable(n)})}t.setPopoverSmall(),t.popover("show")})},out:function(e){n.getMapElementFromOverlay(this).find("."+n.config.systemHeadClass).popover("hide")}}},connection:{title:"WH data",trigger:"hover",class:"pf-map-overlay-connection-wh",iconClass:["fas","fa-fw","fa-fighter-jet"],hoverIntent:{over:function(e){let t=s(this),i=o.searchConnectionsByScopeAndType(t,"wh"),r=a.getServerTime();for(let e of i){let t=e.getParameter("created"),o=e.getParameter("updated"),i=a.convertTimestampToServerTime(t),s=a.convertTimestampToServerTime(o),l=a.getTimeDiffParts(i,r),c=a.getTimeDiffParts(s,r),d=[a.formatTimeParts(l)+'&nbsp;<i class="fas fa-fw fa-plus-square"></i>',a.formatTimeParts(c)+'&nbsp;<i class="fas fa-fw fa-pen-square"></i>'];e.addOverlay(["Label",{label:d.join("<br>"),id:n.config.connectionOverlayWhId,cssClass:[n.config.componentOverlayClass,"small","text-right"].join(" "),location:.35}])}},out:function(e){let t=s(this),a=o.searchConnectionsByScopeAndType(t,"wh");for(let e of a)e.removeOverlay(n.config.connectionOverlayWhId)}}},connectionEol:{title:"EOL",trigger:"hover",class:"pf-map-overlay-connection-eol",iconClass:["fas","fa-fw","fa-hourglass-end"],hoverIntent:{over:function(e){let t=s(this),i=o.searchConnectionsByScopeAndType(t,"wh",["wh_eol"]),r=a.getServerTime();for(let e of i){let t=e.getParameter("eolUpdated"),o=a.convertTimestampToServerTime(t),i=a.getTimeDiffParts(o,r);e.addOverlay(["Label",{label:'<i class="fas fa-fw fa-hourglass-end"></i>&nbsp;'+a.formatTimeParts(i),id:n.config.connectionOverlayEolId,cssClass:[n.config.componentOverlayClass,"eol"].join(" "),location:.25}])}},out:function(e){let t=s(this),a=o.searchConnectionsByScopeAndType(t,"wh",["wh_eol"]);for(let e of a)e.removeOverlay(n.config.connectionOverlayEolId)}}}};e.fn.startMapUpdateCounter=function(){if(!this.length)return void console.warn("startMapUpdateCounter() failed. Missing DOM node");let o=this[0],s=n.getMapCounter(o),r=e(s).data("easyPieChart");if(!r)return void console.warn("startMapUpdateCounter() failed. easyPieChart not initialized");let l=(e=0)=>{r&&r.update(e)},c=s.getData("counterTask");if(!c){let r=o.closest(`.${a.config.mapTabContentClass}`),d=parseInt(r.dataset.mapId)||0;(c=i.new(`mapUpdateCounter_${d}`,{precision:"secondTenths",isParallel:!0,targetRunCount:10*n.config.logTimerCount})).task=((a,i)=>{if(i.runCount%5==0){let e=Math.round(i.targetProgress);l(100-e)}i.targetAchieved&&e(o).velocity("transition.whirlOut",{duration:t.animationSpeed.mapOverlay,complete:function(){n.getMapElementFromOverlay(o).trigger("pf:unlocked")}})}),s.setData("counterTask",c)}c.isConnected()||e(o).velocity("stop").velocity("transition.whirlIn",{duration:t.animationSpeed.mapOverlay}),l(100),c.reset(),c.start()},e.fn.updateOverlayIcon=function(a,n){let o=e(this),i=!1,s=l[a].class,r=o.find("."+s);if(r)if("show"===n)i=!0,"active"!==l[a].trigger&&"refresh"!==l[a].trigger||r.addClass("active"),r.data("visible")||(r.velocity({opacity:[.8,0],scale:[1,0],width:["20px",0],height:["20px",0],marginRight:["10px",0]},{duration:240,easing:"easeInOutQuad"}),r.data("visible",!0));else if("hide"===n){r.data("visible")&&(r.removeClass("active").velocity("reverse"),r.data("visible",!1)),o.find("i:visible").length>0&&(i=!0)}!0===i&&o.is(":hidden")?o.velocity("stop").velocity("transition.whirlIn",{duration:t.animationSpeed.mapOverlay}):!1===i&&o.is(":visible")&&o.velocity("stop").velocity("transition.whirlOut",{duration:t.animationSpeed.mapOverlay})};return e.fn.initMapOverlays=function(){return this.each(function(){let a=e(this),i=e("<div>",{class:[n.config.mapOverlayClass,n.config.mapOverlayTimerClass].join(" ")});a.append(i),a.append((()=>{let t=t=>{let a=e(t.target);if(!a.hasClass("disabled")){let e=a.attr("data-zoom"),t=s(a);o.changeZoom(t,e)}};return e("<div>",{class:[n.config.mapOverlayClass,n.config.mapOverlayZoomClass].join(" ")}).append(e("<i>",{class:["fas","fa-caret-up",n.config.zoomOverlayUpClass].join(" ")}).attr("data-zoom","up").on("click",t),e("<span>",{class:n.config.zoomOverlayValueClass,text:"100"}),e("<i>",{class:["fas","fa-caret-down",n.config.zoomOverlayDownClass].join(" ")}).attr("data-zoom","down").on("click",t))})());let r=e("<div>",{class:[n.config.mapOverlayClass,n.config.mapOverlayInfoClass].join(" ")});Object.entries(l).forEach(([t,a])=>{let n=e("<i>",{class:a.iconClass.concat(["pull-right",a.class]).join(" ")}).attr("title",a.title).tooltip({placement:"bottom",container:"body",delay:150});"hover"!==a.trigger&&"refresh"!==a.trigger||n.hoverIntent(a.hoverIntent),a.hasOwnProperty("onClick")&&n.on("click",a.onClick),r.append(n)}),a.append(r),((a,o,i="")=>{if(!n.getMapCounter(a)){let n=Object.assign(document.createElement("div"),{className:`${t.classes.pieChart.class} ${t.classes.pieChart.pieChartMapCounterClass}`}),o=Object.assign(document.createElement("span"),{textContent:i}),s=Object.assign(document.createElement("i"),{className:["fas","fa-fw","fa-lock"].join(" ")});o.append(s),n.append(o),a.append(n),e(n).initMapUpdateCounter(),a.dataset.placement="left",a.setAttribute("title","update counter"),e(a).tooltip()}})(i[0])})},{showInfoSignatureOverlays:i=>{let s=i.data("id"),c=o.getMapInstance(s),d=a.getCurrentMapData(s),g=a.getObjVal(d,"data.connections");if(g){let s=((e,t,a="info")=>n.getMapOverlay(e,a).find("."+t))(i,l.connectionSignatureOverlays.class);(t=>{let a=(t=e(t)).data("default-icon");a||(a=e(t).attr("class").match(/\bfa-\S*/g)[1],t.data("default-icon",a)),t.toggleClass(a+" fa-sync fa-spin")})(s),((e,i)=>{let s="info_signature";i=a.arrayToObject(i),e.setSuspendDrawing(!0);let l=e.isSuspendDrawing();e.getAllConnections().forEach(e=>{let c=e.getParameter("connectionId"),d=e.endpoints[0],g=e.endpoints[1],f=a.getObjVal(i,`${c}`),p=o.getConnectionDataFromSignatures(e,f),m=!1;if("wh"===e.scope){let i,c="diamond",v=1;if(f&&f.signatures){let e=p.source.labels,t=p.target.labels;e.includes("K162")&&t.includes("K162")||0===e.length&&0===t.length||e.length>0&&t.length>0&&!e.includes("K162")&&!t.includes("K162")?c="diamond":e.includes("K162")||0===e.length&&!t.includes("K162")?(c="arrow",v=-1,i=t.find(e=>"K162"!==e)):(c="arrow",i=e.find(e=>"K162"!==e))}"arrow"===c?e.updateClasses(n.config.connectionArrowOverlaySuccessClass,n.config.connectionArrowOverlayDangerClass):e.updateClasses(n.config.connectionArrowOverlayDangerClass,n.config.connectionArrowOverlaySuccessClass);let u=((e,t=1,a="arrow")=>{switch(e){case"arrow":return{[`${a}length`]:15,[`${a}direction`]:t,[`${a}foldback`]:.8};default:return{[`${a}length`]:10,[`${a}direction`]:1,[`${a}foldback`]:2}}})(c,v);if(e.hasType(s)?e.reapplyTypes(u,l):e.addType(s,u,l),r(d,p.source),r(g,p.target),t.wormholes.hasOwnProperty(i)){m=!0;let s=a.getObjVal(Object.assign({},t.wormholes[i]),"size.type");s&&!e.hasType(s)&&(n.getMapOverlay(e.canvas,"timer").startMapUpdateCounter(),o.setConnectionJumpMassType(e,s),o.markAsChanged(e))}}else e.hasType(s)&&e.removeType(s,void 0,l);e.setParameter("sizeLocked",m)}),e.setSuspendDrawing(!1,!0)})(c,g),(t=>{let a=(t=e(t)).data("default-icon");t.toggleClass(a+" fa-sync fa-spin")})(s)}},hideInfoSignatureOverlays:e=>{let t=e.data("id"),a=o.getMapInstance(t),i="info_signature";a.setSuspendDrawing(!0),a.getAllConnections().forEach(e=>{let t=e.getOverlay(n.config.connectionOverlayArrowId);t&&t.cleanup(),e.hasType(i)&&e.removeType(i,{},!0)}),a.selectEndpoints().removeOverlay(n.config.endpointOverlayId),a.setSuspendDrawing(!1,!0)},toggleInfoSystemRegion:e=>{let t=e.data("id");o.getMapInstance(t).repaintEverything()},updateZoomOverlay:e=>{let t=e.getZoom(),a=Math.round(1e3*t)/10,i=n.getMapOverlay(e.getContainer(),"zoom"),s=i.find("."+n.config.zoomOverlayValueClass),r=i.find("."+n.config.zoomOverlayUpClass),l=i.find("."+n.config.zoomOverlayDownClass);s.toggleClass("active",1!==t).text(a),r.toggleClass("disabled",t>=o.config.zoomMax),l.toggleClass("disabled",t<=o.config.zoomMin)},initMapDebugOverlays:t=>{if(new URL(window.location.href).searchParams.has("debug")){let a=e(t.getContainer());a.on("mouseover",".jtk-connector",function(a){if(a.stopPropagation(),a.target.classList.contains("jtk-connector-outline")){let i=a.currentTarget._jsPlumb;if(!i.getOverlay(n.config.debugOverlayId)){let a=[],s=[],r=e=>t=>t.id===e;for(let e of i.endpoints){let n=t.anchorManager.getConnectionsFor(e.elementId);for(let e of n)if(!a.some(r(e[0].id))){a.push(e[0]);for(let t of e[0].endpoints)s.some(r(t.id))||s.push(t)}}let l=t=>{let a=o.getDataByConnection(t),n="<div><table>";return n+="<tr><td>"+t.id+'</td><td class="text-right">'+a.id+"</td></tr>",n+='<tr><td>Scope:</td><td class="text-right">'+a.scope+"</td></tr>",n+='<tr><td>Type:</td><td class="text-right">'+a.type.toString()+"</td></tr>",e(n+="</table></div>").on("click",function(){console.info(t)})};for(let e of a)e.addOverlay(["Custom",{id:n.config.debugOverlayId,cssClass:[n.config.componentOverlayClass,"debug"].join(" "),create:l}]);let c=t=>{let a=o.filterDefaultTypes(t.getType()),n="<div><table>";return n+="<tr><td>"+t.id+'</td><td class="text-right"></td></tr>',n+='<tr><td>Scope:</td><td class="text-right">'+t.scope+"</td></tr>",n+='<tr><td>Type:</td><td class="text-right">'+a.toString()+"</td></tr>",e(n+="</table></div>").on("click",function(){console.info(t)})};for(let e of s)e.addOverlay(["Custom",{id:n.config.debugOverlayId,cssClass:[n.config.componentOverlayClass,"debug"].join(" "),create:c}])}}}),a.on("mouseover",function(e){e.stopPropagation(),e.target===e.currentTarget&&(t.select().removeOverlay(n.config.debugOverlayId),t.selectEndpoints().removeOverlay(n.config.debugOverlayId))})}}}});
//# sourceMappingURL=overlay.js.map
